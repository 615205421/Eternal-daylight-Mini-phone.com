<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>世纪小手机</title>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>  
/* ==================== 全局基础样式 ==================== */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}

/* ==================== 手机容器 ==================== */
.phone-container{width:380px;height:666px;background:#fff;border:16px solid #e6e6e6;border-radius:54px;overflow:hidden;position:relative;z-index:1;box-shadow:0 30px 60px rgba(0,0,0,.7),0 15px 35px rgba(0,0,0,.6),0 5px 15px rgba(0,0,0,.5),0 0 0 1px rgba(255,255,255,.95),0 0 0 3px rgba(230,230,230,.9),0 0 0 5px rgba(210,210,210,.6),inset 0 15px 35px rgba(255,255,255,.95),inset 0 8px 20px rgba(255,255,255,.9),inset 0 4px 10px rgba(255,255,255,.85),inset 0 -8px 20px rgba(0,0,0,.15),inset 0 -4px 10px rgba(0,0,0,.12);background-image:linear-gradient(145deg,rgba(255,255,255,.95)0,rgba(245,245,245,.95)15%,rgba(235,235,235,.95)35%,rgba(225,225,225,.95)65%,rgba(235,235,235,.95)85%,rgba(245,245,245,.95)100%),radial-gradient(ellipse at 50% 20%,rgba(255,255,255,.7)0,rgba(255,255,255,.4)30%,transparent 70%),radial-gradient(ellipse at 50% 90%,rgba(255,255,255,.5)0,transparent 50%),linear-gradient(to right,rgba(255,255,255,.6)0,transparent 10%,transparent 90%,rgba(255,255,255,.6)100%),linear-gradient(to bottom,rgba(255,255,255,.8)0,transparent 15%);background-blend-mode:overlay,normal,normal,normal,normal}.phone-container::before{content:"";position:absolute;top:-1px;left:-1px;right:-1px;height:14px;background:linear-gradient(to bottom,rgba(255,255,255,.9)0,rgba(255,255,255,.7)30%,rgba(255,255,255,.3)70%,transparent 100%);border-radius:54px 54px 0 0;pointer-events:none;z-index:999}.phone-container::after{content:"";position:absolute;bottom:-1px;left:-1px;right:-1px;height:10px;background:linear-gradient(to top,rgba(255,255,255,.5)0,rgba(255,255,255,.2)50%,transparent 100%);border-radius:0 0 54px 54px;pointer-events:none;z-index:999}.screen{width:100%;height:100%;position:relative;overflow:hidden;border-radius:48px;box-sizing:border-box;background:linear-gradient(to bottom,rgba(255,255,255,.25)0,rgba(255,255,255,.1)8px)}.screen::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;border-radius:48px;pointer-events:none;z-index:9999;box-shadow:inset 0 3px 8px rgba(0,0,0,.4),inset 0 1px 4px rgba(0,0,0,.3),inset 0 0 2px rgba(0,0,0,.2),inset 0 -1px 4px rgba(255,255,255,.8),0 0 0 1.5px rgba(255,255,255,.95),0 0 0 2.5px rgba(240,240,240,.9),0 0 0 4px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.15)}.phone-container .screen-wrapper{position:relative}.phone-container .screen-wrapper::after{content:"";position:absolute;top:2px;left:2px;right:2px;bottom:2px;border-radius:48px;pointer-events:none;z-index:1;box-shadow:inset 0 4px 10px rgba(0,0,0,.3),inset 0 2px 5px rgba(0,0,0,.25),inset 0 1px 3px rgba(0,0,0,.15),0 1px 0 rgba(255,255,255,.8),0 1px 3px rgba(255,255,255,.5);background:linear-gradient(to bottom,rgba(0,0,0,.15)0,rgba(0,0,0,.03)5px,rgba(0,0,0,0)50%,rgba(0,0,0,.03)95%,rgba(0,0,0,.15)100%)}.phone-container .side-highlight-left,.phone-container .side-highlight-right{position:absolute;top:10%;width:2px;height:80%;pointer-events:none;z-index:998}.phone-container .side-highlight-left{left:6px;background:linear-gradient(to right,rgba(255,255,255,.7)0,rgba(255,255,255,.3)50%,transparent 100%)}.phone-container .side-highlight-right{right:6px;background:linear-gradient(to left,rgba(255,255,255,.7)0,rgba(255,255,255,.3)50%,transparent 100%)}

/* ==================== 锁屏界面 ==================== */
.lock-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;z-index:100;display:none;flex-direction:column;align-items:center;justify-content:space-between;padding:60px 20px 40px;transition:transform .6s cubic-bezier(0.4,0,0.2,1);pointer-events:all;overflow:hidden;border-radius:20px}.lock-screen.active{display:flex;transform:translateY(0)}.lock-screen.unlocking{transform:translateY(-100%)}.lock-screen-content{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:space-between}.lock-icon{width:30px;height:30px;margin-bottom:15px;color:#000;font-size:25px;animation:lockFloat 2s ease-in-out infinite;position:relative;z-index:10}@keyframes lockFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}.lock-icon.unlocking{animation:unlock .5s ease-out forwards}@keyframes unlock{0%{transform:translateY(0)scale(1);opacity:1}50%{transform:translateY(-20px)scale(1.2);opacity:.7}100%{transform:translateY(-100px)scale(.5);opacity:0}}.lock-time{font-size:110px;font-weight:1000;letter-spacing:-2px;color:#000;margin-bottom:5px;}.lock-date{font-size:14px;color:#666;margin-bottom:25px;font-weight:400;letter-spacing:1px}.lock-weather{text-align:center;margin-bottom:20px;padding:12px;border-radius:12px;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);border:1px solid rgba(0,0,0,.1);width:85%;max-width:280px}.weather-location{font-size:13px;color:#000;margin-bottom:6px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px}.weather-info{font-size:16px;color:#000;font-weight:300}.lock-quote{max-width:260px;text-align:center;margin-bottom:20px;padding:15px}.quote-text{font-size:13px;color:#000;line-height:1.5;font-style:italic;margin-bottom:8px;letter-spacing:.3px;font-weight:300}.quote-author{font-size:10px;color:#666;letter-spacing:.5px;text-transform:uppercase}.unlock-hint{color:#000;font-size:11px;opacity:.7;animation:fadeInOut 2s infinite;text-align:center}.unlock-hint i{display:block;margin-bottom:4px;font-size:14px;animation:slideUp 1.5s infinite}@keyframes slideUp{0%,100%{transform:translateY(0);opacity:.7}50%{transform:translateY(-5px);opacity:1}}@keyframes fadeInOut{0%,100%{opacity:.5}50%{opacity:.9}}.lock-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,rgba(255,255,255,.1) 0%,rgba(255,255,255,0) 100%);z-index:5}

/* ==================== 界面通用样式 ==================== */
.interface{position:absolute;top:0;left:0;width:100%;height:100%;padding:20px;opacity:0;pointer-events:none;transition:all .3s ease;background:#fff;display:flex;flex-direction:column;border-radius:20px}
.interface.active{opacity:1;pointer-events:all}
.interface.exiting{transform:translateX(-100%);opacity:0}
.interface.entering{transform:translateX(100%)}
.interface.entering.active{transform:translateX(0)}

/* ==================== 头部导航 ==================== */
.header{text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:5px solid #000;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.back-button{position:absolute;left:0;background:#fff;border:1px solid #000;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px;z-index:1}
.header h1{font-size:21px;font-weight:600;margin:0;display:flex;gap:8px}
.toggle-persona{position:absolute;right:0;top:0;background:#fff;border:1px solid #000;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px}

/* ==================== 桌面/主屏幕 ==================== */
.desktop-interface{position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;color:#000;padding-top:10px}
.desktop-interface.active{display:flex}
.desktop-time{font-size:100px;font-weight:1000;margin-bottom:5px;color:#000}
.desktop-signature{font-size:16px;color:#000;margin-bottom:15px;text-align:center;min-height:24px;padding:0 20px;width:100%;cursor:text;transition:all .3s ease;outline:none;border:none;background:transparent;font-family:inherit}
.desktop-signature:focus{background:rgba(0,0,0,.05);border-radius:8px}
.lock-screen-btn{position:relative;margin:10px auto 0;color:#000;cursor:pointer;font-size:24px;z-index:10;transition:all .3s ease;text-align:center;display:block;background:none;border:none;padding:0}
.lock-screen-btn:hover{transform:scale(1.2);color:#333}
.lock-screen-btn:active{transform:scale(.9)}
.app-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:15px auto 0;padding:0 10px;width:100%;max-width:340px}
.app-item{display:flex;flex-direction:column;align-items:center;width:100%;justify-content:center}
.app-icon{width:60px;height:60px;background:#fff;border-radius:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease;font-size:24px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.app-icon:hover{transform:scale(1.05);background:#f5f5f5;box-shadow:0 3px 10px rgba(0,0,0,.12)}
.app-label{margin-top:5px;font-size:11px;text-align:center;color:#000;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.1;padding:0 2px}
.app-navigation{display:none}

/* ==================== 聊天界面 ==================== */
.chat-interface{padding-bottom:0}
.scrollable-content,.chat-messages{flex:1;overflow-y:auto;margin-bottom:0;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.scrollable-content::-webkit-scrollbar,.chat-messages::-webkit-scrollbar{display:none}
.chat-messages{padding:10px;border:1px solid #000;background:#fafafa;margin-bottom:10px}
.chat-container{display:flex;flex-direction:column;height:100%}
.chat-input-container{flex-shrink:0;margin-top:auto;padding:5px 0;background:#fff;margin-bottom:5px;}
.chat-input{display:flex;gap:10px}
.chat-input input{flex:1;padding:10px;border:1px solid #000;border-radius:5px}
.chat-input button{padding:10px 20px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer}
.chat-input input:focus{border:3px solid #4a6ee0!important;outline:none!important;box-shadow:none!important}

/* ==================== AI圆圈 ==================== */
.ai-circle{border:3px solid #000;background:#fff;transition:all .3s ease;width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;font-weight:700;margin:20px 0}
.ai-circle:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,.1)}
.message{border:1px solid #000;background:#fff;margin:8px 0;max-width:85%}
.user-message{margin-left:auto;background:#f8f8f8}
.ai-message{margin-right:auto;background:#f0f0f0}

/* ==================== 外卖小票样式 ==================== */
.chat-receipt-wrapper{max-width:280px;margin:10px auto;background:transparent;border:none;border-radius:0;overflow:visible;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.1);font-family:'Courier New',monospace}
.chat-receipt{padding:20px;position:relative;background:white;border-left:1px dashed #000;border-right:1px dashed #000}
.chat-receipt::before{content:"";position:absolute;top:-6px;left:-1px;right:-1px;height:6px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M-1 7 Q 5 -2 11 7' fill='%23fff' stroke='%23000' stroke-width='1' stroke-dasharray='2,2'/%3E%3C/svg%3E");background-size:10px 6px;background-repeat:round;z-index:1}
.chat-receipt::after{content:"";position:absolute;bottom:-6px;left:-1px;right:-1px;height:6px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M-1 -1 Q 5 8 11 -1' fill='%23fff' stroke='%23000' stroke-width='1' stroke-dasharray='2,2'/%3E%3C/svg%3E");background-size:10px 6px;background-repeat:round;z-index:1}
.receipt-header{text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:2px dashed #000}
.receipt-title{font-size:18px;font-weight:800;margin:0;letter-spacing:1px}
.receipt-subtitle{font-size:12px;color:#666;margin:5px 0}
.receipt-store-info{font-size:11px;color:#666;margin-bottom:15px;text-align:center}
.receipt-datetime{font-size:11px;color:#666;text-align:center;margin-bottom:15px}
.receipt-items{margin:15px 0;border-top:1px dashed #000;border-bottom:1px dashed #000;padding:10px 0}
.receipt-item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px}
.receipt-item-name{flex:1}
.receipt-item-quantity{margin:0 10px;min-width:20px;text-align:center}
.receipt-item-price{min-width:40px;text-align:right;font-weight:600}
.receipt-divider{border-bottom:1px dashed #000;margin:10px 0}
.receipt-totals{margin:15px 0}
.receipt-total-line{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px}
.receipt-total-line.total{border-top:2px dashed #000;padding-top:8px;margin-top:8px}
.receipt-footer{text-align:center;margin-top:20px;padding-top:10px;border-top:2px dashed #000}
.receipt-thankyou{font-size:12px;font-weight:600;margin-bottom:5px}
.receipt-barcode{height:30px;width:80%;margin:10px auto;background-image:linear-gradient(90deg,#000 0%,#000 4%,transparent 4%,transparent 5%,#000 5%,#000 7%,transparent 7%,transparent 9%,#000 9%,#000 14%,transparent 14%,transparent 15%,#000 15%,#000 18%,transparent 18%,transparent 21%,#000 21%,#000 23%,transparent 23%,transparent 25%,#000 25%,#000 31%,transparent 31%,transparent 33%,#000 33%,#000 37%,transparent 37%,transparent 39%,#000 39%,#000 42%,transparent 42%,transparent 44%,#000 44%,#000 49%,transparent 49%,transparent 51%,#000 51%,#000 55%,transparent 55%,transparent 57%,#000 57%,#000 61%,transparent 61%,transparent 63%,#000 63%,#000 67%,transparent 67%,transparent 71%,#000 71%,#000 75%,transparent 75%,transparent 77%,#000 77%,#000 81%,transparent 81%,transparent 83%,#000 83%,#000 89%,transparent 89%,transparent 91%,#000 91%,#000 95%,transparent 95%,transparent 100%)}
.receipt-barcode-number{font-size:10px;letter-spacing:4px;color:#000;text-align:center;margin-top:-5px}
.receipt-order-number{font-size:10px;color:#666;margin:5px 0}
.receipt-status{display:inline-block;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:600;margin-top:5px}
.receipt-status.delivered{background:#e8f5e8;color:#2e7d32}
.receipt-status.overtime{background:#ffebee;color:#c62828}
.receipt-status.delivering{background:#e3f2fd;color:#1565c0}
.receipt-checkbox{position:absolute;top:10px;right:10px;width:18px;height:18px;border:2px solid #000;border-radius:3px;cursor:pointer;background:white;z-index:10}
.receipt-checkbox.checked{background:#000}
.receipt-checkbox.checked::after{content:"✓";color:white;font-size:12px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.chat-receipt-wrapper:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.15)}
.chat-receipt-wrapper.selected{border-color:#4a6ee0;box-shadow:0 0 0 2px rgba(74,110,224,0.3)}
.receipt-action-buttons{display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px dashed #ddd}
.receipt-action-btn{flex:1;padding:6px 10px;border:1px solid #000;background:white;border-radius:4px;cursor:pointer;font-size:11px;text-align:center;transition:all .2s}
.receipt-action-btn:hover{background:#000;color:white}
.receipt-action-btn.primary{background:#000;color:white}
.receipt-action-btn.primary:hover{background:#333}
.receipt-remark{font-size:10px;color:#666;margin:8px 0 5px 0;padding-top:8px;border-top:1px dashed #ddd;word-wrap:break-word;line-height:1.4;text-align:left}
.receipt-remark strong{color:#000;font-weight:600}

/* ==================== 外卖订单条框样式 ==================== */
.order-type-selector{margin-bottom:10px;font-size:14px;display:flex;align-items:center;gap:8px}
.order-type-selector select{padding:5px 10px;border:1px solid #000;border-radius:4px;background:#fff;font-size:13px}
.simple-order-item{padding:12px 14px;border:1px solid #ddd;border-radius:6px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;background:#fff;transition:all .2s ease}
.simple-order-item:hover{background:#f9f9f9;border-color:#000}
.simple-order-info{flex:1;font-size:12px}
.simple-order-name{font-weight:700;font-size:13px;color:#333;margin-bottom:4px}
.simple-order-details{font-size:12px;color:#666;margin-bottom:4px}
.simple-order-time{font-size:11px;color:#999}
.simple-order-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.simple-order-price{font-size:13px;font-weight:700;color:#000}
.simple-order-status{font-size:12px;padding:4px 10px;border-radius:12px;background:#f0f0f0;color:#666}
.status-delivering{background:#e8f5e8;color:#2e7d32}
.status-delivered{background:#e3f2fd;color:#1565c0}
.status-overtime{background:#ffebee;color:#c62828}
.empty-order{text-align:center;padding:25px;color:#999;font-size:13px}

/* ==================== 聊天管理 ==================== */
.chat-management-section{margin-top:10px;padding:15px;border:1px solid #000;background:#fafafa;border-radius:8px}
.chat-management-section h3{margin-bottom:10px;font-size:16px;display:flex;align-items:center;gap:8px}
.chat-management-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.chat-management-buttons button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;min-width:120px;transition:all .2s ease}
.chat-management-buttons button:hover{background:#f0f0f0;transform:translateY(-1px)}
.chat-management-buttons button.danger{background:#f8f8f8;border-color:#888;color:#333}
.chat-management-buttons button.danger:hover{background:#e0e0e0}
.selection-mode-info{padding:8px;background:#f0f0f0;border-radius:5px;margin-bottom:10px;display:none;font-size:12px}
.selection-mode-info.active{display:block}
.selection-count{font-weight:700;color:#666}
.selection-actions{display:flex;gap:8px;margin-top:8px;display:none}
.selection-actions.active{display:flex}
.selection-actions button{flex:1;padding:6px 10px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:11px}
.selection-actions button.danger{background:#f8f8f8;border-color:#888;color:#333}
.message-checkbox{display:none;margin-left:10px;cursor:pointer}
.selection-mode .message-checkbox{display:inline-block}
.message{max-width:100%;padding:10px;margin:5px 0;border-radius:20px;word-wrap:break-word;position:relative;transition:all .3s ease;opacity:1;transform:scale(1)}
.message:hover{background-color:transparent}
.message.selected{background:#f0f0f0!important;border-color:#aaa!important}
.message.selected:hover{background-color:#e8e8e8!important}
.selection-mode .message-actions{display:none!important}
.user-message{background:#fff;border:1px solid #000;margin-left:auto}
.ai-message{background:#fff;border:1px solid #000;margin-right:auto}
.message-sender{font-size:16px;color:#000;margin-bottom:3px;font-weight:800}
.message-content{font-size:13px}
.message-actions{position:absolute;top:5px;display:none;right:10px;gap:5px}
.message:hover .message-actions{display:flex}
.message-action{background:rgba(255,255,255,.9);border:1px solid #000;border-radius:3px;width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px}
.message.editing{background:#fff;border-color:#fff}
.message.deleting{opacity:0;transform:scale(.5);max-height:0;margin:0;padding:0;overflow:hidden;transition:all .3s ease}
.chat-mode-switch,.chat-type-switch{margin-top:10px;padding:8px;background:#f0f0f0;border:1px solid #000;border-radius:5px;display:flex;align-items:center;justify-content:space-between;font-size:12px}
.chat-mode-label,.chat-type-label{font-weight:700}
.chat-mode-buttons,.chat-type-buttons{display:flex;gap:5px}
.chat-mode-btn,.chat-type-btn{padding:4px 8px;border:1px solid #000;background:#fff;border-radius:3px;cursor:pointer;font-size:11px;transition:all .2s ease}
.chat-mode-btn.active,.chat-type-btn.active{background:#000;color:#fff}
.chat-mode-btn:hover,.chat-type-btn:hover{background:#f0f0f0}
.chat-mode-btn.active:hover,.chat-type-btn.active:hover{background:#333}
.chat-mode-indicator{display:inline-block;width:6px;height:6px;border-radius:50%;margin-left:5px;vertical-align:middle}
.chat-mode-online{background:#0f0}
.chat-mode-offline{background:red}
.chat-mode-description{font-size:10px;color:#666;margin-top:4px;text-align:center}
.multi-persona-selector{margin-top:10px;padding:8px;background:#f0f0f0;border:1px solid #000;border-radius:5px;display:none;font-size:12px}
.multi-persona-selector.active{display:block}
.multi-persona-label{font-weight:700;margin-bottom:5px;display:block}
.persona-select{width:100%;padding:5px;border:1px solid #000;border-radius:3px;background:#fff;font-size:11px}
.multi-persona-management{margin-top:5px;display:flex;gap:5px}
.multi-persona-management button{flex:1;padding:4px 8px;border:1px solid #000;background:#fff;border-radius:3px;cursor:pointer;font-size:10px}
.multi-persona-management button:hover{background:#f0f0f0}
.chat-character-profile{margin-top:20px;padding:16px;border:1px solid #e0e0f0;border-radius:8px;background-color:#fafafa}
.chat-character-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.chat-character-avatar{width:60px;height:60px;border-radius:50%;background-color:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:24px}
.chat-character-info{flex:1}
.chat-character-name{font-weight:600;font-size:18px;margin-bottom:4px}
.chat-character-bio{font-size:14px;color:#666}
.chat-character-stats{display:flex;gap:16px;margin-bottom:16px}
.chat-character-stat{text-align:center}
.chat-character-stat-number{font-weight:600;font-size:16px}
.chat-character-stat-label{font-size:12px;color:#666}
.chat-character-edit-btn{background-color:#000;color:#fff;border:none;border-radius:4px;padding:8px 16px;font-size:14px;cursor:pointer;width:100%}

/* ==================== 备份与编辑 ==================== */
.backup-section{margin-top:15px;padding:15px;border:1px solid #000;border-radius:8px;background:#fafafa}
.backup-section h3{margin-bottom:10px;font-size:16px}
.backup-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.backup-buttons button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;min-width:120px}
.backup-buttons button:hover{background:#f0f0f0}
.backup-file-input{display:none}
.backup-status{margin-top:10px;padding:8px;border-radius:5px;text-align:center;display:none;font-size:12px}
.backup-success,.backup-error{background:#f0f0f0;border:1px solid #000;color:#000}
.backup-info{font-size:11px;color:#666;margin-top:8px;text-align:center}
.edit-input{width:100%;padding:8px;border:1px solid #000;border-radius:9px;font-size:13px;resize:vertical;min-height:80px}
.edit-actions{display:flex;gap:10px;margin-top:10px;justify-content:flex-end}
.edit-actions button{padding:5px 10px;border:1px solid #000;background:#fff;border-radius:3px;cursor:pointer;font-size:12px}
.persona-editor{max-height:0;overflow:hidden;transition:max-height .3s ease;margin-bottom:10px}
.persona-editor.expanded{max-height:100px}
.persona-form{padding:15px;border:2px solid #000;border-radius:5px;background:#fafafa}
.form-group{margin-bottom:5px}
.form-group label{display:block;margin-bottom:4px;font-size:14px}
.form-input{width:100%;padding:8px;border:1px solid #000;border-radius:9px;background:#fff}
.persona-actions{display:flex;gap:10px;flex-wrap:wrap}
.persona-actions button{flex:1;padding:5px;border:1px solid #000;background:#fff;border-radius:20px;cursor:pointer;min-width:50px}
input,textarea,select,input:-webkit-autofill{border:2px solid #ddd;border-radius:8px;padding:12px 15px;width:100%;background:#fff}
input:focus,textarea:focus,.input:focus,select:focus{border:3px solid #4a6ee0!important;outline:none;box-shadow:none}
input:-webkit-autofill{-webkit-box-shadow:0 0 0 1000px #fff inset;border:3px solid #4a6ee0!important}

/* ==================== API设置 ==================== */
#api-interface .header h1{margin-left:20px}
.api-section{margin-bottom:15px;padding:15px;border:1px solid #000}
.api-section h3{margin-bottom:10px}
.api-input{width:100%;padding:8px;border:1px solid #000;margin-bottom:10px;border-radius:5px}
.api-buttons{display:flex;gap:10px;flex-wrap:wrap}
.api-buttons button{padding:8px 15px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;flex:1}
.api-status{margin-top:10px;padding:8px;border-radius:5px;text-align:center;display:none}
.status-success,.status-error{background:#f0f0f0;border:1px solid #000}
.model-list{max-height:200px;overflow-y:auto;border:1px solid #000;margin-top:10px;padding:10px;background:#fafafa;scrollbar-width:none}
.model-list::-webkit-scrollbar{display:none}
.model-item{padding:5px;border-bottom:1px solid #eee;cursor:pointer}
.model-item:hover{background:#f0f0f0}
.model-item:last-child{border-bottom:none}
.refresh-status{display:flex;align-items:center;gap:10px;margin-top:10px}
.refresh-button{background:#fff;border:1px solid #000;padding:5px 10px;border-radius:3px;cursor:pointer}
.last-updated{font-size:12px;color:#666}
.model-info{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding:5px;background:#fff;border-radius:3px}
.current-model{font-size:14px;font-weight:600}
.model-badge{background:#000;color:#fff;padding:3px 6px;border-radius:10px;font-size:12px}

/* ==================== 设置界面样式 ==================== */
#settings-interface .header h1{margin-left:25px}
.settings-container{padding:20px}
.settings-category{margin-bottom:30px}
.settings-category-title{font-size:14px;font-weight:600;color:#666;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
.settings-list{background:#fff;border:1.5px solid #000;border-radius:12px;overflow:hidden}
.settings-item{display:flex;align-items:center;padding:16px 20px;border-bottom:1px solid #eee;cursor:pointer;transition:background-color .2s ease}
.settings-item:last-child{border-bottom:none}
.settings-item:hover{background-color:#f9f9f9}
.settings-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:25px;border-radius:8px;margin-right:15px;flex-shrink:0;font-weight:900}
.settings-info{flex:1}
.settings-title{font-size:16px;font-weight:600;color:#000;margin-bottom:4px}
.settings-desc{font-size:13px;color:#666}
.settings-arrow{font-size:24px;color:#999;margin-left:10px}
.settings-value{font-size:14px;color:#666;margin-left:10px}
.settings-switch{margin-left:10px}
.switch{position:relative;display:inline-block;width:50px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
.slider:before{position:absolute;content:"";height:16px;width:16px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}
input:checked+.slider{background-color:#000}
input:checked+.slider:before{transform:translateX(26px)}
.settings-footer{text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #eee;color:#999;font-size:13px}
.app-version{font-weight:600;margin-bottom:8px}
.copyright{font-size:12px}

/* ==================== 安全隐私界面 ==================== */
#security-interface .header h1{margin-left:25px}
.security-container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:400px;padding:20px}
.security-card{width:100%;max-width:300px;padding:20px;border:1px solid #000;border-radius:12px;margin-bottom:20px;background:#fafafa}
.security-card h3{margin-bottom:15px;font-size:16px}
.security-card p{font-size:13px;color:#666;margin-bottom:10px}
.security-btn{padding:10px 15px;border:1px solid #000;background:#fff;border-radius:8px;cursor:pointer;margin:5px;transition:all .2s ease}
.security-btn:hover{background:#000;color:#fff}
.security-lock{width:120px;height:120px;border:3px solid #000;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;font-weight:700;margin:40px auto;color:#000;transition:all .3s ease}
.security-lock:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,.1)}

/* ==================== 样式编辑器 ==================== */
#style-interface .header h1{margin-left:30px}
.style-container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:400px}
.css-editor{width:100%;height:200px;padding:10px;border:1px solid #000;border-radius:8px;font-family:monospace;resize:vertical}
.apply-css{width:100%;padding:10px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;margin-top:10px}
.style-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;width:100%}
.style-buttons button{flex:1;padding:10px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;min-width:120px}

/* ==================== 通用组件 ==================== */
.scroll-hint{text-align:center;font-size:10px;color:#666;margin-top:10px;display:none}
.confirm-dialog{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}
.confirm-content{background:#fff;padding:20px;border:2px solid #000;border-radius:10px;text-align:center;max-width:300px;margin:0 20px}
.confirm-buttons{display:flex;gap:10px;margin-top:15px}
.confirm-buttons button{flex:1;padding:8px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer}
.status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px;transition:all .3s ease}
.status-online{background:#0f0}
.status-offline{background:red}
.status-generating{background:#0f0;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.loading{opacity:.7;pointer-events:none}
.typing-indicator{display:inline-block;margin-left:5px}
.typing-dot{display:inline-block;width:4px;height:4px;background:#000;border-radius:50%;margin:0 1px;animation:typing 1.4s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* ==================== 角色模态框 ==================== */
.persona-modal{position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100vh!important;background:rgba(0,0,0,.7)!important;display:none;justify-content:center;align-items:center;z-index:9999!important;margin:0!important;padding:0!important}
.modal-content{background:#fff!important;width:90%;max-width:350px;max-height:80vh;border:2px solid #000!important;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;z-index:10000}
.modal-header{padding:15px;border-bottom:1px solid #000;background:#fafafa;display:flex;justify-content:space-between;align-items:center}
.modal-header h3{margin:0;font-size:16px}
.close-modal{background:none;border:none;font-size:20px;cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
.modal-body{flex:1;overflow-y:auto;padding:15px;scrollbar-width:none}
.modal-body::-webkit-scrollbar{display:none}
.persona-tabs{display:flex;border-bottom:1px solid #000;margin-bottom:15px}
.persona-tab{flex:1;padding:10px;text-align:center;border:none;background:#fff;cursor:pointer;border-bottom:2px solid transparent}
.persona-tab.active{border-bottom:2px solid #000;font-weight:600}
.persona-form-section{display:none}
.persona-form-section.active{display:block}
.form-section{margin-bottom:20px;padding:15px;border:1px solid #000;border-radius:5px}
.form-section h4{margin-bottom:10px;font-size:14px}
.persona-preview{margin-top:15px;padding:10px;border:1px solid #000;border-radius:5px;background:#fafafa;font-size:12px}
.persona-preview h5{margin-bottom:5px;font-size:12px;color:#000}
#multi-preview-content{color:#000}
#multi-preview-content div{color:#000;border-color:#000}

/* ==================== 音乐播放器 ==================== */
#music-interface .header h1{margin-left:30px}
.music-player{display:flex;flex-direction:column;height:100%;background:#fff}
.music-fixed-area{flex-shrink:0;display:flex;flex-direction:column;align-items:center;padding:10px 15px 5px}
.music-scrollable-area{flex:1;overflow-y:auto;padding:5px 15px 15px;scrollbar-width:none}
.music-scrollable-area::-webkit-scrollbar{display:none}
.disc-container{width:220px;height:220px;margin:15px 0 20px;display:flex;justify-content:center;align-items:center;position:relative}
.disc-container::before{content:"";display:block;padding-top:100%}
.disc-container>*{position:absolute;top:0;left:0;width:100%;height:100%}
.disc{width:100%;height:100%;background:radial-gradient(circle,#333 0%,#000 100%);border-radius:50%;display:flex;justify-content:center;align-items:center;position:relative;animation:rotate 20s linear infinite;animation-play-state:paused}
.disc-center{width:40px;height:40px;background-color:#fff;border-radius:50%;z-index:2}
.disc.playing{animation-play-state:running}
@keyframes rotate{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.music-title{font-size:16px;font-weight:700;margin-bottom:8px;text-align:center;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.music-artist{font-size:12px;color:#666;margin-bottom:15px;text-align:center;width:100%}
.song-info{margin-bottom:15px;width:100%;text-align:center}
.song-title{font-size:18px;font-weight:600;margin-bottom:8px;color:#000}
.song-artist{font-size:14px;color:#555}
.progress-container{width:100%;margin-bottom:15px}
.progress-info{display:flex;justify-content:space-between;margin-bottom:10px;font-size:12px;color:#555}
.progress-bar{width:100%;height:4px;background-color:#ddd;border-radius:2px;cursor:pointer;position:relative;overflow:hidden}
.progress{height:100%;background-color:#000;border-radius:2px;width:0;transition:width .1s}
.control-buttons{display:flex;justify-content:center;align-items:center;gap:30px;margin-bottom:15px}
.btn{background:none;border:none;cursor:pointer;font-size:20px;color:#000;width:20px;height:40px;display:flex;justify-content:center;align-items:center;border-radius:50%;transition:all .3s}
.btn:hover{background-color:#f0f0f0}
.btn-play{width:50px;height:50px;background-color:#000;color:#fff;font-size:18px;display:flex;justify-content:center;align-items:center;padding-bottom:2px}
.btn-play:hover{background-color:#333;transform:scale(1.05)}
.btn-loop{font-size:18px;width:40px;height:40px;background:none;border:none;cursor:pointer;padding:0 20px}
.import-section{margin-top:5px;width:100%;max-width:100%}
.import-btn{width:100%;padding:10px;background:#fff;border:2px solid #000;border-radius:8px;text-align:center;cursor:pointer;margin-bottom:10px;transition:all .2s ease;font-size:14px}
.import-btn:hover{background:#f0f0f0}
.file-input{display:none}
.playlist{width:100%;max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:8px;margin-top:10px;border:2px solid #000;font-size:12px;scrollbar-width:none}
.playlist::-webkit-scrollbar{display:none}
.playlist-item{padding:6px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.playlist-item:last-child{border-bottom:none}
.playlist-item:hover{background:#f9f9f9}
.playlist-item.active{background:#f0f0f0;font-weight:700}
.song-duration{font-size:10px;color:#666;margin-left:8px}

/* ==================== 世界书 ==================== */
#worldbook-interface .header{display:flex;justify-content:space-between;align-items:center;position:relative;text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:5px solid #000;flex-shrink:0;width:100%}
#worldbook-interface .header h1{flex:1;text-align:center;margin:0;display:flex;align-items:flex-start;justify-content:center;gap:8px;font-size:22px}
#worldbook-interface .add-worldbook-btn{background:none;border:none;font-size:36px;cursor:pointer;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;position:absolute;right:0;color:#000;font-weight:400;transition:all .2s ease}
#worldbook-interface .add-worldbook-btn:hover{transform:scale(1.1);color:#333}
#worldbook-interface h2{display:flex;align-items:center;gap:8px;font-size:20px}
.worldbook-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.worldbook-list{display:flex;flex-direction:column;gap:10px}
.worldbook-item{border:1px solid #000;border-radius:8px;padding:12px;background:#fff;position:relative}
.worldbook-title{font-weight:700;margin-bottom:5px;font-size:14px}
.worldbook-content{font-size:12px;color:#333;margin-bottom:10px;max-height:60px;overflow:hidden;position:relative}
.worldbook-content.expanded{max-height:none;overflow:visible}
.worldbook-actions{display:flex;gap:8px;justify-content:flex-end}
.worldbook-action{background:#fff;border:1px solid #000;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px}
.worldbook-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1002}
.worldbook-modal-content{background:#fff;padding:20px;border:2px solid #000;border-radius:10px;width:90%;max-width:350px}
.worldbook-form-group{margin-bottom:15px}
.worldbook-form-group label{display:block;margin-bottom:5px;font-size:14px}
.worldbook-form-input{width:100%;padding:8px;border:1px solid #000;border-radius:5px;font-size:14px}
.worldbook-form-textarea{width:100%;padding:8px;border:1px solid #000;border-radius:5px;font-size:14px;resize:vertical;min-height:100px}
.worldbook-form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:15px}
.worldbook-form-btn{padding:8px 15px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer}
.worldbook-status,.worldbook-backup-status{margin-top:10px;padding:8px;border-radius:5px;text-align:center;display:none;font-size:12px}
.worldbook-status-success,.worldbook-backup-success,.worldbook-status-error,.worldbook-backup-error{background:#f0f0f0;border:1px solid #000;color:#000}
.worldbook-toggle{position:absolute;right:10px;top:10px;background:#fff;border:1px solid #000;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px}
.worldbook-active-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px}
.worldbook-active{background:#0f0}
.worldbook-inactive{background:red}
.worldbook-backup-section{margin-top:20px;padding:15px;border:1px solid #000;border-radius:8px;background:#fafafa}
.worldbook-backup-section h3{margin-bottom:10px;font-size:16px;display:flex;align-items:center;gap:8px}
.worldbook-backup-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.worldbook-backup-buttons button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;min-width:120px;transition:all .2s ease}
.worldbook-backup-buttons button:hover{background:#f0f0f0;transform:translateY(-1px)}
.worldbook-backup-info{font-size:11px;color:#666;margin-top:8px;text-align:center}
.worldbook-backup-file-input{display:none}

/* ==================== 钱包 ==================== */
#wallet-interface .header h1{margin-left:30px}
.wallet-container{max-width:100%;margin:0 auto;padding:0 10px;overflow-x:hidden}
.balance-card{background:#000;color:#fff;border-radius:15px;padding:25px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.1);margin-bottom:25px;border:2px solid #000;overflow:hidden;width:100%;box-sizing:border-box}
.balance-label{font-size:.9em;opacity:.8;margin-bottom:8px}
.balance-amount{font-size:2.2em;font-weight:700;letter-spacing:1px;margin:10px 0;word-wrap:break-word;overflow-wrap:break-word;max-width:100%;padding:0 10px}
.balance-sub-info{font-size:.9em;opacity:.8;display:flex;justify-content:space-around;margin-top:15px;flex-wrap:wrap}
.action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:25px}
.action-btn{background:#000;color:#fff;border:2px solid #000;border-radius:12px;padding:15px;text-align:center;cursor:pointer;transition:all .3s ease;font-weight:500}
.action-btn:hover{background:#333;transform:translateY(-2px)}
.action-btn .icon{font-size:1.2em;margin-bottom:5px;display:block}
.transaction-section{margin-top:20px;border-radius:10px;background:#f9f9f9;overflow:hidden}
.transaction-section h3{margin-bottom:15px;font-size:1.1em;color:#000;text-align:center;padding:15px;border-bottom:1px solid #ddd}
.transaction-list{max-height:300px;overflow-y:auto;padding:10px}
.transaction-item{display:flex;justify-content:space-between;align-items:center;padding:12px 10px;border-bottom:1px solid #eee}
.transaction-item:last-child{border-bottom:none}
.transaction-info{flex:1}
.transaction-title{font-weight:700;font-size:.9em;margin-bottom:3px}
.transaction-date{font-size:.8em;color:#666}
.transaction-amount{font-weight:700;font-size:1em}
.transaction-expense{color:#f44}
.transaction-income{color:#0a0}
.empty-state{padding:30px 0;color:#666;text-align:center}
.wallet-modal,.utility-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
.wallet-modal-content,.utility-modal-content{background:#fff;padding:25px;border-radius:15px;width:90%;max-width:350px;box-shadow:0 5px 20px rgba(0,0,0,.2)}
.wallet-modal-header,.utility-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.wallet-modal-title,.utility-modal-title{font-size:1.3em;font-weight:700;color:#000}
.wallet-close-btn,.utility-close-btn{background:none;border:none;font-size:1.5em;cursor:pointer;color:#000}
.wallet-input-group{margin-bottom:20px}
.wallet-input-label{display:block;margin-bottom:8px;color:#000;font-weight:500}
.amount-input{width:100%;padding:12px 15px;border:2px solid #000;border-radius:8px;font-size:1.1em;text-align:center;transition:all .3s ease}
.amount-input:focus{outline:none;border-color:#07f}
.wallet-confirm-btn,.utility-confirm-btn{width:100%;background:#000;color:#fff;border:2px solid #000;border-radius:8px;padding:12px;font-size:1.1em;cursor:pointer;transition:background .3s ease}
.wallet-confirm-btn:hover,.utility-confirm-btn:hover{background:#333}
.house-type-selector{margin-bottom:20px;padding:15px;background:#f9f9f9;border-radius:10px;border:1px solid #ddd}
.house-type-selector label{display:block;margin-bottom:8px;color:#000;font-weight:500}
.house-type-select{width:100%;padding:12px 15px;border:2px solid #000;border-radius:8px;font-size:1em;background-color:#fff}
.utility-info{margin-bottom:20px;padding:15px;background:#f9f9f9;border-radius:10px;border:1px solid #ddd}
.utility-item{display:flex;justify-content:space-between;margin-bottom:10px;font-size:1em}
.utility-total{display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:1px solid #ddd;font-weight:700;font-size:1.1em}
@media (max-width:480px){.balance-amount{font-size:1.8em}.action-buttons{grid-template-columns:1fr;gap:10px}.balance-sub-info{flex-direction:column;gap:5px}}

/* ==================== 微博 ==================== */
#weibo-interface .header h1{margin-left:25px}
.weibo-container{max-width:100%;margin:0 auto;border-left:1px solid #f0f0f0;border-right:1px solid #f0f0f0;min-height:100vh;background:#fff;overflow-y:auto;padding:0}
.weibo-header{position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-bottom:1px solid #e0e0e0;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;z-index:100}
.weibo-logo{font-weight:700;font-size:20px}
.weibo-nav a{color:#000;text-decoration:none;margin-left:20px;font-size:14px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all .2s}
.weibo-nav a.active{background-color:#000;color:#fff}
.weibo-nav a.active:hover{background-color:#000;color:#fff} 
.weibo-nav a:hover{background-color:#f0f0f0}
.weibo-page-content{display:none}
.weibo-page-content.active{display:block}
.weibo-category-section{padding:16px;border-bottom:1px solid #f0f0f0;background-color:#fafafa}
.weibo-category-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.weibo-category-title{font-weight:600;font-size:16px}
.weibo-manage-categories-btn{background:none;border:1px solid #000;border-radius:4px;padding:4px 12px;font-size:12px;cursor:pointer;transition:all .2s}
.weibo-manage-categories-btn:hover{background-color:#000;color:#fff}
.weibo-category-tags{display:flex;flex-wrap:wrap;gap:8px}
.weibo-category-tag{background-color:#fff;border:1px solid #000;border-radius:16px;padding:4px 12px;font-size:12px;cursor:pointer;transition:all .3s ease;color:#000}
.weibo-category-tag.active{background-color:#000;color:#fff}
.weibo-category-tag:hover{background-color:#f0f0f0;transform:translateY(-1px)}
.weibo-modal,.weibo-comment-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
.weibo-modal-content,.weibo-comment-content{background-color:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto}
.weibo-comment-content{padding:20px}
.weibo-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.weibo-close-modal{background:none;border:none;font-size:20px;cursor:pointer}
.weibo-category-input-group{display:flex;margin-bottom:16px}
.weibo-category-input{flex:1;border:1px solid #e0e0e0;border-radius:4px 0 0 4px;padding:8px;outline:none}
.weibo-add-category-btn{background-color:#000;color:#fff;border:none;border-radius:0 4px 4px 0;padding:0 16px;cursor:pointer}
.weibo-category-list{max-height:200px;overflow-y:auto}
.weibo-category-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f0}
.weibo-delete-category{background:none;border:none;color:#666;cursor:pointer}
.weibo-profile-form{display:flex;flex-direction:column;gap:16px}
.weibo-form-group{display:flex;flex-direction:column;gap:8px}
.weibo-form-group label{font-size:14px;font-weight:600}
.weibo-form-group input,.weibo-form-group textarea{border:1px solid #e0e0e0;border-radius:4px;padding:8px;font-family:inherit;font-size:14px;outline:none}
.weibo-form-group textarea{resize:vertical;min-height:80px}
.weibo-save-profile-btn{background-color:#000;color:#fff;border:none;border-radius:4px;padding:10px;font-size:14px;cursor:pointer;margin-top:8px}
.weibo-compose-section{padding:16px;border-bottom:1px solid #f0f0f0}
.weibo-compose-box{display:flex;gap:12px}
.weibo-avatar{width:40px;height:40px;border-radius:50%;background-color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px}
.weibo-compose-input{flex:1}
.weibo-compose-input textarea{width:100%;border:1px solid #e0e0f0;border-radius:8px;padding:12px;font-family:inherit;font-size:14px;resize:none;outline:none;height:60px}
.weibo-compose-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.weibo-category-select{border:1px solid #e0e0f0;border-radius:4px;padding:6px 12px;font-size:12px;background:none}
.weibo-publish-btn{background-color:#000;color:#fff;border:none;border-radius:20px;padding:6px 20px;font-size:13px;cursor:pointer}
.weibo-list{padding:0}
.weibo-item{padding:16px;border-bottom:1px solid #f0f0f0;display:flex;gap:12px}
.weibo-content{flex:1}
.weibo-item-header{display:flex;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px}
.weibo-username{font-weight:600;margin-right:8px}
.weibo-item-category{background-color:#f0f0f0;border-radius:12px;padding:2px 8px;font-size:10px;color:#666}
.weibo-timestamp{color:#666;font-size:12px}
.weibo-item-text{margin-bottom:12px;font-size:13px;line-height:1.5}
.weibo-item-actions{display:flex;gap:20px}
.weibo-item-actions button{background:none;border:none;color:#666;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:4px;transition:all .2s;padding:4px 8px;border-radius:4px}
.weibo-item-actions button:hover{background-color:#f0f0f0}
.weibo-item-actions button.liked{color:#f4d;border-color:#f4d}
.weibo-item-actions button.liked:hover{background-color:#ff1f10}
.weibo-item-actions button.delete-btn{color:#000}
.weibo-item-actions button.delete-btn:hover{background-color:#f0f0f0}
.weibo-discover-section{padding:16px}
.weibo-discover-title{font-weight:600;font-size:18px;margin-bottom:16px}
.weibo-trending-topics{margin-bottom:24px}
.weibo-trending-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.weibo-trending-title{font-weight:600;font-size:16px}
.weibo-refresh-btn{background:none;border:1px solid #000;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer}
.weibo-topic-list{display:flex;flex-direction:column;gap:8px}
.weibo-topic-item{padding:12px;border:1px solid #f0f0f0;border-radius:8px;cursor:pointer}
.weibo-topic-name{font-weight:600;font-size:15px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.weibo-topic-stats{font-size:12px;color:#666;display:flex;justify-content:space-between;align-items:center}
.weibo-rank-number{font-weight:700;width:20px;display:inline-block;text-align:center;margin-right:5px;font-style:italic}
.rank-top-1{color:red}
.rank-top-2{color:#f60}
.rank-top-3{color:#fa0}
.rank-normal{color:#999}
.weibo-tag{display:inline-block;padding:1px 3px;border-radius:3px;font-size:10px;color:#fff;margin-left:5px;font-weight:400}
.tag-hot{background:#f44}
.tag-new{background:#f90}
.tag-boiled{background:#c00}
.weibo-recommended-users{margin-bottom:24px}
.weibo-user-list{display:flex;flex-direction:column;gap:12px}
.weibo-user-item{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;cursor:pointer}
.weibo-user-avatar{width:40px;height:40px;border-radius:50%;background-color:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px}
.weibo-user-info{flex:1}
.weibo-user-name{font-weight:600;font-size:14px}
.weibo-user-bio{font-size:12px;color:#666;margin-top:2px}
.weibo-follow-btn{background:none;border:1px solid #000;border-radius:16px;padding:4px 12px;font-size:12px;cursor:pointer}
.weibo-random-quote{padding:16px;background-color:#fafafa;border-radius:8px;text-align:center;font-style:italic;margin-top:16px}
.weibo-comment-input{width:100%;border:1px solid #e0e0f0;border-radius:4px;padding:12px;font-family:inherit;font-size:14px;resize:none;outline:none;min-height:80px;margin-bottom:12px}
.weibo-comment-actions{display:flex;justify-content:flex-end;gap:12px}
.weibo-cancel-comment{background:none;border:1px solid #000;border-radius:4px;padding:6px 12px;cursor:pointer}
.weibo-submit-comment{background-color:#000;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer}
.weibo-comments-list{margin-top:16px;max-height:200px;overflow-y:auto}
.weibo-comment-item{padding:8px 0;border-bottom:1px solid #f0f0f0}
.weibo-comment-user{font-weight:600;margin-right:8px}
.weibo-comment-text{margin-top:4px}
@media (max-width:600px){.weibo-container{border:none}}
.weibo-comments-container{margin-top:12px;padding:12px;background:#fafafa;border-radius:8px;border:1px solid #e0e0e0;width:280px;max-width:280px;margin-left:-40px;display:block}
.weibo-comments-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.weibo-comments-title{font-size:13px;font-weight:600;color:#333}
.refresh-comments-btn{background:none;border:1px solid #000;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all .2s}
.refresh-comments-btn:hover{background:#000;color:#fff}
.refresh-comments-btn.loading{opacity:.7;cursor:not-allowed}
.weibo-comments-list-inline{max-height:300px;overflow-y:auto}
.weibo-comment-item-inline{padding:8px;border-bottom:1px solid #eee}
.weibo-comment-item-inline:last-child{border-bottom:none}
.weibo-comment-header-inline{display:flex;align-items:center;margin-bottom:4px}
.weibo-comment-user-inline{font-weight:600;font-size:12px;margin-right:8px}
.weibo-comment-time-inline{font-size:10px;color:#666}
.weibo-comment-text-inline{font-size:11px;line-height:1.4}
.weibo-comment-stance{display:inline-block;margin-left:6px;padding:1px 4px;border-radius:3px;font-size:9px;font-weight:700}
.stance-supportive{background:#e6fffa;color:#00c9a7;border:1px solid #00a68c}
.stance-critical{background:#ffeaea;color:#ff3860;border:1px solid #d11a3f}
.stance-fan{background:#e6f7ff;color:#00bfff;border:1px solid #0099cc}
.stance-anti{background:#f3e5f5;color:#d500f9;border:1px solid #aa00ff}
.profile-card{margin-top:20px;padding:16px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa;transition:all .3s ease}
.profile-summary{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.profile-avatar{width:50px;height:50px;border-radius:50%;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
.profile-basic{flex:1;margin-left:12px}
.profile-name{font-weight:600;font-size:16px;margin-bottom:2px}
.profile-bio{font-size:12px;color:#666;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical}
.profile-toggle{background:none;border:none;font-size:16px;cursor:pointer;width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:#666}
.profile-details{max-height:0;overflow:hidden;transition:max-height .3s ease}
.profile-card.expanded .profile-details{max-height:500px;margin-top:16px}
.profile-stats{display:flex;gap:16px;margin-bottom:12px}
.profile-stat{text-align:center;flex:1}
.profile-stat-number{font-weight:600;font-size:16px}
.profile-stat-label{font-size:10px;color:#666;margin-top:2px}
.profile-edit-btn{width:100%;padding:8px;background:#000;color:#fff;border:none;border-radius:4px;font-size:12px;cursor:pointer;transition:background .2s}
.profile-edit-btn:hover{background:#333}
.profile-edit-btn:focus{outline:2px solid #4a6ee0;outline-offset:2px}
.profile-edit-btn:active{transform:translateY(1px)}
.weibo-modal{z-index:1100}
.weibo-modal-content{z-index:1101;position:relative}
#editMyProfileBtn{cursor:pointer;position:relative;transition:all .2s ease}
#editMyProfileBtn:focus{outline:2px solid #4a6ee0;outline-offset:2px}
#editMyProfileBtn:active{transform:translateY(1px)}
#weibo-interface.interface{padding:20px!important;display:flex!important;flex-direction:column!important}
#weibo-interface .header{padding:0 0 10px 0!important;margin:0!important;flex-shrink:0!important}
#weibo-interface .scrollable-content{flex:1!important;overflow-y:auto!important;margin:0 -20px!important;padding:0 21px!important;width:calc(100% + 40px)!important;box-sizing:border-box!important}
#weibo-interface .weibo-container{width:100%!important;max-width:100%!important;margin:0!important;padding:0!important}
#weibo-interface .weibo-compose-section{padding:16px 0!important;width:100%!important;box-sizing:border-box!important}
#weibo-interface .weibo-compose-box{width:100%!important;max-width:100%!important}
#weibo-interface .weibo-compose-input textarea{width:100%!important;max-width:100%!important;box-sizing:border-box!important;margin:0!important}
#weibo-interface .weibo-list{padding:0!important;width:100%!important}
#weibo-interface .weibo-item{padding:16px 0!important;width:100%!important;box-sizing:border-box!important}
#weibo-interface .weibo-content{width:100%!important;max-width:100%!important;flex:1!important;min-width:0!important}
#weibo-interface .weibo-item-text{width:100%!important;max-width:100%!important;margin:8px 0!important;padding:0!important;word-wrap:break-word!important;word-break:break-word!important;display:block!important}
#weibo-interface .weibo-comment-input{width:100%!important;max-width:100%!important;box-sizing:border-box!important;margin:0!important}
#weibo-interface .weibo-comment-text-inline{width:100%!important;max-width:100%!important;word-wrap:break-word!important}

/* ==================== 外卖/桃源 - 椭圆形按钮修复版 ==================== */
#food-delivery-interface{color:#000;overflow-x:hidden;max-width:100vw}
:root{--primary-color:#000;--secondary-color:#000;--light-color:#fff;--border-color:#000;--accent-color:#000;--success-color:#4caf50;--warning-color:#f90;--danger-color:#f44}
#food-delivery-interface .scrollable-content,#food-delivery-interface .categories,#food-delivery-interface .food-grid,#food-delivery-interface .scrollable-content::-webkit-scrollbar,#food-delivery-interface .categories::-webkit-scrollbar,#food-delivery-interface .food-grid::-webkit-scrollbar{overflow-y:auto;scrollbar-width:none;display:none}
#food-delivery-interface .header{text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:5px solid #000;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0;background-color:#fff;height:auto;padding:0 10px 10px;z-index:1000;margin:0 0 15px}
#food-delivery-interface .header h1{font-size:20px;font-weight:600;margin:0;display:flex;align-items:flex-start;gap:8px;position:relative;left:0;top:0;transform:none;z-index:10}
#food-delivery-interface .cart-btn{position:absolute;right:10px;background:none;border:none;font-size:22px;color:var(--primary-color);cursor:pointer}
#food-delivery-interface .cart-count{position:absolute;top:-5px;right:-5px;background-color:var(--primary-color);color:#fff;font-size:10px;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .food-page-container{display:none;margin-top:-15px;padding:0 8px 20px 8px;background-color:var(--light-color);min-height:calc(100% - 140px);height:100%;overflow-y:auto;scrollbar-width:none}
#food-delivery-interface .food-page-container::-webkit-scrollbar{display:none}
#food-delivery-interface .food-page-container.active{display:block}
#food-delivery-interface .home-page{background-color:var(--light-color)}
#food-delivery-interface .search-container{padding:10px 8px 5px}
#food-delivery-interface .search-box{display:flex;align-items:center;background-color:var(--light-color);border-radius:24px;padding:10px 12px;border:1px solid var(--border-color)}
#food-delivery-interface .search-icon{color:var(--secondary-color);margin-right:10px}
#food-delivery-interface .search-input{border:none;background:none;flex:1;font-size:14px;outline:none;color:var(--primary-color)}
#food-delivery-interface .categories{display:flex;overflow-x:auto;padding:12px 8px 8px;margin-top:0;background-color:#fff;gap:18px;border-bottom:1px solid var(--border-color);-ms-overflow-style:none}
#food-delivery-interface .category-item{display:flex;flex-direction:column;align-items:center;min-width:58px;cursor:pointer}
#food-delivery-interface .category-icon{width:38px;height:38px;border-radius:50%;background-color:var(--light-color);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--primary-color);margin-bottom:6px;border:1px solid var(--border-color)}
#food-delivery-interface .category-name{font-size:12px;color:var(--secondary-color);text-align:center;line-height:1.2}
#food-delivery-interface .category-item.active .category-icon{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .category-item.active .category-name{color:var(--primary-color);font-weight:600}
#food-delivery-interface .recommendations{padding:16px 8px}
#food-delivery-interface .section-title{font-size:18px;font-weight:700;margin-bottom:16px;color:var(--primary-color);position:relative;padding-left:12px}
#food-delivery-interface .section-title::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background-color:var(--primary-color);border-radius:2px}
#food-delivery-interface .food-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;overflow-y:auto;max-height:100%}
#food-delivery-interface .food-card{background-color:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.05);transition:transform .3s,box-shadow .3s;cursor:pointer;border:1px solid var(--border-color);padding:12px;display:flex;flex-direction:column;position:relative}
#food-delivery-interface .food-card:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
#food-delivery-interface .favorite-btn{position:absolute;top:10px;right:10px;background:none;border:none;font-size:18px;color:#000;cursor:pointer;z-index:10;transition:color .3s}
#food-delivery-interface .favorite-btn.active{color:#f47}
#food-delivery-interface .food-icon{width:100%;height:75px;background-color:var(--light-color);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;color:var(--secondary-color);font-size:22px;border:1px dashed var(--border-color)}
#food-delivery-interface .food-info{flex:1}
#food-delivery-interface .food-name{font-size:16px;font-weight:700;margin-bottom:6px;color:var(--primary-color);display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .food-category{font-size:10px;background-color:var(--light-color);color:var(--secondary-color);padding:2px 6px;border-radius:8px;border:1px solid var(--border-color)}
#food-delivery-interface .food-desc{font-size:13px;color:var(--secondary-color);margin-bottom:10px;line-height:1.4}
#food-delivery-interface .food-features{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
#food-delivery-interface .food-feature{font-size:10px;color:var(--secondary-color);background-color:var(--light-color);padding:2px 6px;border-radius:8px;border:1px solid var(--border-color)}
#food-delivery-interface .food-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
#food-delivery-interface .food-price{font-size:17px;font-weight:800;color:var(--primary-color)}
#food-delivery-interface .add-to-cart-btn{width:30px;height:30px;border-radius:50%;background-color:var(--primary-color);color:#fff;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:background-color .3s}
#food-delivery-interface .add-to-cart-btn:hover{background-color:#222}
#food-delivery-interface .orders-page{padding:16px 8px}
#food-delivery-interface .orders-filter{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:8px;white-space:nowrap}
#food-delivery-interface .filter-btn{padding:8px 16px;background-color:var(--light-color);border:1px solid var(--border-color);border-radius:20px;color:var(--secondary-color);font-size:13px;cursor:pointer;white-space:nowrap;flex-shrink:0;height:36px;display:flex;align-items:center;justify-content:center;min-width:80px}
#food-delivery-interface .filter-btn.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .empty-orders{text-align:center;padding:60px 20px;color:#999}
#food-delivery-interface .empty-orders i{font-size:48px;margin-bottom:16px;color:#ddd}
#food-delivery-interface .empty-orders p{font-size:16px;margin-top:10px}
#food-delivery-interface .orders-list{height:auto;overflow-y:visible;padding-right:0;padding-bottom:20px}
#food-delivery-interface .order-card{background-color:#fff;border-radius:12px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);border:1px solid var(--border-color);overflow:hidden;transition:transform .3s,box-shadow .3s}
#food-delivery-interface .order-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
#food-delivery-interface .order-header{padding:14px;display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .order-status{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;display:inline-flex;align-items:center;justify-content:center;min-width:70px;height:24px}
#food-delivery-interface .status-delivering{background-color:rgba(76,175,80,.1);color:var(--success-color)}
#food-delivery-interface .status-delivered{background-color:rgba(33,150,243,.1);color:#2196f3}
#food-delivery-interface .status-canceled{background-color:rgba(244,67,54,.1);color:var(--danger-color)}
#food-delivery-interface .status-overtime{background-color:rgba(255,152,0,.1);color:var(--warning-color)}
#food-delivery-interface .order-time{font-size:12px;color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .order-content{padding:0 14px 14px}
#food-delivery-interface .order-restaurant{font-weight:700;margin-bottom:8px;color:var(--primary-color);display:flex;align-items:center;padding-top:14px}
#food-delivery-interface .order-restaurant i{margin-right:8px;color:var(--secondary-color)}
#food-delivery-interface .order-items{margin-bottom:12px}
#food-delivery-interface .order-item{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
#food-delivery-interface .order-item-name{flex:1;color:var(--secondary-color);font-size:14px;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .order-item-quantity{color:var(--secondary-color);font-size:14px;margin:0 10px;white-space:nowrap}
#food-delivery-interface .order-item-price{color:var(--primary-color);font-weight:600;font-size:14px;min-width:60px;text-align:right;white-space:nowrap}
#food-delivery-interface .order-divider{display:none}
#food-delivery-interface .order-total{display:flex;justify-content:space-between;font-weight:700;color:var(--primary-color);font-size:16px;padding-top:12px;margin-top:12px;border-top:1px dashed var(--border-color)}
#food-delivery-interface .order-footer{padding:14px;display:flex;justify-content:flex-end;align-items:center;gap:10px}
#food-delivery-interface .order-actions{display:flex;gap:8px}
#food-delivery-interface .order-btn{padding:8px 16px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--border-color);background-color:#fff;color:var(--primary-color);transition:all .3s;white-space:nowrap;height:32px;display:flex;align-items:center;justify-content:center;min-width:70px}
#food-delivery-interface .order-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .order-btn.primary:hover{background-color:#222}
#food-delivery-interface .order-btn.danger{background-color:#fff;color:var(--danger-color);border-color:var(--danger-color)}
#food-delivery-interface .order-btn.danger:hover{background-color:rgba(244,67,54,.1)}
#food-delivery-interface .order-btn:hover{background-color:var(--light-color)}
#food-delivery-interface .order-detail-modal{position:absolute;top:0;left:0;right:0;bottom:0;background-color:#fff;z-index:2000;transform:translateY(100%);transition:transform .4s ease;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none}
#food-delivery-interface .order-detail-modal::-webkit-scrollbar{display:none}
#food-delivery-interface .order-detail-modal.active{transform:translateY(0)}
#food-delivery-interface .detail-header{position:sticky;top:0;background-color:#fff;z-index:10;padding:20px 16px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between}
#food-delivery-interface .detail-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .detail-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .detail-close:hover{background-color:var(--light-color)}
#food-delivery-interface .detail-content{flex:1;padding:16px;scrollbar-width:none}
#food-delivery-interface .detail-content::-webkit-scrollbar{display:none}
#food-delivery-interface .detail-section{padding:20px 0;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .detail-section:last-child{border-bottom:none}
#food-delivery-interface .detail-section-title{font-size:16px;font-weight:700;margin-bottom:16px;color:var(--primary-color);display:flex;align-items:center}
#food-delivery-interface .detail-section-title i{margin-right:8px;color:var(--secondary-color)}
#food-delivery-interface .delivery-time-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
#food-delivery-interface .delivery-time-label{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .delivery-time-value{font-size:16px;font-weight:700;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .delivery-time-value.overtime{color:var(--danger-color)}
#food-delivery-interface .time-countdown{font-size:14px;color:var(--secondary-color);text-align:right}
#food-delivery-interface .countdown-timer{font-size:20px;font-weight:800;color:var(--primary-color);margin-top:4px}
#food-delivery-interface .countdown-timer.overtime{color:var(--danger-color)}
#food-delivery-interface .delivery-progress{margin-bottom:20px}
#food-delivery-interface .progress-steps{display:flex;justify-content:space-between;margin-bottom:8px}
#food-delivery-interface .progress-step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative}
#food-delivery-interface .step-icon{width:28px;height:28px;border-radius:50%;background-color:var(--light-color);border:2px solid var(--border-color);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--secondary-color);margin-bottom:4px;z-index:1}
#food-delivery-interface .step-icon.active{background-color:var(--primary-color);border-color:var(--primary-color);color:#fff}
#food-delivery-interface .step-icon.delayed{background-color:var(--light-color);border-color:var(--border-color);color:var(--secondary-color)}
#food-delivery-interface .step-label{font-size:11px;color:var(--secondary-color);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
#food-delivery-interface .step-label.active{color:var(--primary-color);font-weight:600}
#food-delivery-interface .step-label.delayed{color:var(--secondary-color)}
#food-delivery-interface .progress-bar{position:absolute;top:14px;left:0;right:0;height:2px;background-color:var(--border-color);z-index:0}
#food-delivery-interface .progress-fill{position:absolute;top:14px;left:0;height:2px;background-color:var(--primary-color);z-index:0;transition:width .5s ease}
#food-delivery-interface .progress-fill.delayed{background-color:var(--secondary-color)}
#food-delivery-interface .delivery-status-info{display:none}
#food-delivery-interface .rider-info{margin-top:12px;padding:12px;background-color:var(--light-color);border-radius:8px}
#food-delivery-interface .rider-name{font-weight:600;margin-bottom:6px;color:var(--primary-color)}
#food-delivery-interface .rider-rating{display:flex;align-items:center;font-size:14px}
#food-delivery-interface .star-rating{margin-right:8px}
#food-delivery-interface .detail-address{margin-top:16px}
#food-delivery-interface .address-label{font-size:12px;color:var(--secondary-color);margin-bottom:4px}
#food-delivery-interface .address-value{font-size:14px;color:var(--primary-color);word-break:break-word}
#food-delivery-interface .detail-items-list{margin-bottom:16px}
#food-delivery-interface .detail-item{display:flex;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .detail-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
#food-delivery-interface .detail-item-img{width:60px;height:60px;border-radius:8px;background-color:var(--light-color);display:flex;align-items:center;justify-content:center;margin-right:12px;color:var(--secondary-color);font-size:20px;border:1px solid var(--border-color);flex-shrink:0}
#food-delivery-interface .detail-item-info{flex:1;min-width:0}
#food-delivery-interface .detail-item-name{font-weight:600;margin-bottom:4px;color:var(--primary-color);overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .detail-item-desc{font-size:12px;color:var(--secondary-color);margin-bottom:6px;word-break:break-word}
#food-delivery-interface .detail-item-price{font-weight:600;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .detail-remark{margin-top:16px}
#food-delivery-interface .remark-label{font-size:12px;color:var(--secondary-color);margin-bottom:4px}
#food-delivery-interface .remark-value{font-size:14px;color:var(--primary-color);word-break:break-word}
#food-delivery-interface .detail-utensils{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
#food-delivery-interface .utensil-option{display:flex;align-items:center;padding:8px 12px;border:1px solid var(--border-color);border-radius:20px;background-color:#fff;cursor:pointer;transition:all .3s;white-space:nowrap}
#food-delivery-interface .utensil-option.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .utensil-option i{margin-right:6px}
#food-delivery-interface .cart-detail-modal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);width:92%;max-width:480px;background-color:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:2000;opacity:0;visibility:hidden;transition:all .4s ease;overflow:hidden;border:1px solid var(--border-color)}
#food-delivery-interface .cart-detail-modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
#food-delivery-interface .cart-detail-header{padding:20px 20px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between}
#food-delivery-interface .cart-detail-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-detail-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .cart-detail-close:hover{background-color:var(--light-color)}
#food-delivery-interface .cart-detail-content{padding:20px;max-height:60vh;overflow-y:auto;scrollbar-width:none}
#food-delivery-interface .cart-detail-content::-webkit-scrollbar{display:none}
#food-delivery-interface .quantity-control{display:flex;align-items:center;justify-content:center;margin:16px 0}
#food-delivery-interface .quantity-btn{width:36px;height:36px;border-radius:50%;background-color:var(--light-color);border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--primary-color);flex-shrink:0}
#food-delivery-interface .quantity-value{margin:0 16px;font-size:18px;font-weight:600;min-width:30px;text-align:center;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .cart-detail-remark{margin-top:20px}
#food-delivery-interface .remark-input{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;outline:none;resize:vertical;min-height:80px;margin-top:8px;color:var(--primary-color);background-color:#fff;box-sizing:border-box}
#food-delivery-interface .cart-detail-utensils{margin-top:20px}
#food-delivery-interface .cart-detail-actions{padding:20px;border-top:1px solid var(--border-color);display:flex;gap:12px}
#food-delivery-interface .cart-detail-btn{flex:1;padding:14px 20px;border-radius:50px;border:1px solid var(--border-color);font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-detail-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .cart-detail-btn.primary:hover{background-color:#222}
#food-delivery-interface .cart-detail-btn.secondary{background-color:#fff;color:var(--primary-color)}
#food-delivery-interface .cart-detail-btn.secondary:hover{background-color:var(--light-color)}
#food-delivery-interface .cart-panel{position:absolute;top:0;right:0;bottom:0;width:88%;max-width:360px;background-color:#fff;z-index:1500;transform:translateX(100%);transition:transform .4s ease;display:flex;flex-direction:column;box-shadow:-5px 0 20px rgba(0,0,0,.1);border-left:1px solid var(--border-color)}
#food-delivery-interface .cart-panel.active{transform:translateX(0)}
#food-delivery-interface .cart-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .cart-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer}
#food-delivery-interface .cart-address-info{padding:16px 20px;background-color:var(--light-color);border-bottom:1px solid var(--border-color);cursor:pointer;transition:background-color .3s}
#food-delivery-interface .cart-address-info:hover{background-color:rgba(0,0,0,.05)}
#food-delivery-interface .cart-address-info.empty{color:#999}
#food-delivery-interface .address-info-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
#food-delivery-interface .address-info-title{font-size:14px;font-weight:600;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .address-info-change{font-size:12px;color:var(--secondary-color);background:none;border:none;cursor:pointer;white-space:nowrap}
#food-delivery-interface .address-info-content{font-size:13px;color:var(--secondary-color);word-break:break-word}
#food-delivery-interface .cart-items{flex:1;overflow-y:auto;padding:20px;scrollbar-width:none}
#food-delivery-interface .cart-items::-webkit-scrollbar{display:none}
#food-delivery-interface .cart-item{display:flex;align-items:center;padding:15px 0;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .cart-item-icon{width:60px;height:60px;border-radius:8px;background-color:var(--light-color);display:flex;align-items:center;justify-content:center;margin-right:15px;color:var(--secondary-color);font-size:20px;border:1px solid var(--border-color);flex-shrink:0}
#food-delivery-interface .cart-item-info{flex:1;min-width:0}
#food-delivery-interface .cart-item-name{font-weight:600;margin-bottom:5px;color:var(--primary-color);overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-item-price{color:var(--primary-color);font-weight:700;font-size:16px;white-space:nowrap}
#food-delivery-interface .cart-item-controls{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
#food-delivery-interface .cart-item-quantity{display:flex;align-items:center;gap:10px;flex-shrink:0}
#food-delivery-interface .cart-item-quantity-value{font-weight:600;min-width:24px;text-align:center;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .quantity-btn-small{width:24px;height:24px;border-radius:50%;background-color:var(--light-color);border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--primary-color);flex-shrink:0}
#food-delivery-interface .cart-item-detail-btn{background:none;border:1px solid var(--border-color);color:var(--secondary-color);font-size:12px;padding:4px 10px;border-radius:12px;cursor:pointer;transition:all .3s;white-space:nowrap;flex-shrink:0}
#food-delivery-interface .cart-item-detail-btn:hover{background-color:var(--light-color);color:var(--primary-color)}
#food-delivery-interface .cart-footer{padding:20px;border-top:1px solid var(--border-color);background-color:#fff}
#food-delivery-interface .cart-total{display:flex;justify-content:space-between;margin-bottom:20px;font-size:18px;font-weight:700;color:var(--primary-color)}
#food-delivery-interface .cart-checkout{width:100%;padding:16px;background-color:var(--primary-color);color:#fff;border:none;border-radius:50px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color .3s;border:1px solid var(--primary-color)}
#food-delivery-interface .cart-checkout:hover{background-color:#222}
#food-delivery-interface .recommendation-modal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9)!important;width:92%;max-width:400px;background-color:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:2000;opacity:0;visibility:hidden;transition:all .4s ease;overflow:hidden;border:none!important}
#food-delivery-interface .recommendation-modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)!important}
#food-delivery-interface .recommendation-modal .modal-content,#food-delivery-interface .product-detail-box{border:none!important;transform:none!important;background:transparent!important}
#food-delivery-interface .recommendation-modal .modal-content{padding-left:40px;padding-right:15px;text-align:center}
#food-delivery-interface .modal-title{font-size:26px!important;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-subtitle{font-size:16px!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-desc{font-size:16px!important;line-height:1.6;word-break:break-word}
#food-delivery-interface .modal-price{font-size:32px!important;font-weight:900;white-space:nowrap}
#food-delivery-interface .modal-feature{font-size:14px!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-btn{font-size:12px!important;border-radius:15px!important;padding:10px 20px!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-header{padding:24px 24px 16px;border-bottom:none;text-align:center;background-color:var(--light-color)}
#food-delivery-interface .modal-icon{width:60px;height:60px;border-radius:50%;background-color:#fff;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px;color:var(--primary-color);border:none}
#food-delivery-interface .modal-close{position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:50%;background-color:#fff;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--primary-color)}
#food-delivery-interface .modal-content{padding:20px}
#food-delivery-interface .modal-actions{display:flex;gap:12px}
#food-delivery-interface .modal-btn{flex:1;padding:14px 20px;border-radius:50px;border:1px solid var(--border-color);font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .modal-btn.primary:hover{background-color:#222}
#food-delivery-interface .modal-btn.secondary{background-color:#fff;color:var(--primary-color)}
#food-delivery-interface .modal-btn.secondary:hover{background-color:var(--light-color)}
#food-delivery-interface .bottom-nav{position:absolute;bottom:0;left:0;right:0;height:70px;background-color:#fff;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -2px 10px rgba(0,0,0,.05);z-index:1000;border-top:1px solid var(--border-color)}
#food-delivery-interface .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:var(--secondary-color);font-size:12px;flex:1;height:100%;transition:color .3s;cursor:pointer}
#food-delivery-interface .nav-item i{font-size:20px;margin-bottom:4px}
#food-delivery-interface .nav-item.active{color:var(--primary-color)}
#food-delivery-interface .address-panel{position:absolute;top:0;left:0;right:0;bottom:0;background-color:#fff;z-index:1500;transform:translateY(100%);transition:transform .4s ease;display:flex;flex-direction:column;border-top:1px solid var(--border-color)}
#food-delivery-interface .address-panel.active{transform:translateY(0)}
#food-delivery-interface .address-header{padding:20px 16px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;background-color:#fff}
#food-delivery-interface .address-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .address-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .address-close:hover{background-color:var(--light-color)}
#food-delivery-interface .address-content{flex:1;overflow-y:auto;padding:16px;background-color:var(--light-color);scrollbar-width:none}
#food-delivery-interface .address-content::-webkit-scrollbar{display:none}
#food-delivery-interface .address-input-group{background-color:#fff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border-color)}
#food-delivery-interface .address-input-title{font-size:16px;font-weight:600;margin-bottom:12px;color:var(--primary-color)}
#food-delivery-interface .address-input{width:100%;padding:14px;border:1px solid var(--border-color);border-radius:8px;font-size:15px;outline:none;margin-bottom:16px;color:var(--primary-color);background-color:#fff;transition:border-color .3s;box-sizing:border-box}
#food-delivery-interface .address-input:focus{border-color:var(--primary-color)}
#food-delivery-interface .address-tags{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
#food-delivery-interface .address-tag{padding:8px 16px;background-color:var(--light-color);border:1px solid var(--border-color);border-radius:20px;font-size:14px;color:var(--secondary-color);cursor:pointer;transition:all .3s;white-space:nowrap}
#food-delivery-interface .address-tag.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .save-address-btn{width:100%;padding:14px;background-color:var(--primary-color);color:#fff;border:none;border-radius:50px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color .3s}
#food-delivery-interface .save-address-btn:hover{background-color:#222}
#food-delivery-interface .saved-addresses-section{background-color:#fff;border-radius:12px;padding:16px;border:1px solid var(--border-color)}
#food-delivery-interface .saved-addresses-title{font-size:16px;font-weight:600;margin-bottom:16px;color:var(--primary-color)}
#food-delivery-interface .address-list{display:flex;flex-direction:column;gap:12px}
#food-delivery-interface .address-item{padding:16px;background-color:#fff;border-radius:8px;border:1px solid var(--border-color);cursor:pointer;transition:all .3s;position:relative}
#food-delivery-interface .address-item:hover{border-color:var(--primary-color);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.05)}
#food-delivery-interface .address-item.active{border-color:var(--primary-color);background-color:rgba(51,51,51,.03)}
#food-delivery-interface .address-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
#food-delivery-interface .address-item-name{font-weight:600;font-size:14px;color:var(--primary-color);display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .address-tag-small{font-size:10px;background-color:var(--light-color);color:var(--secondary-color);padding:2px 8px;border-radius:10px;border:1px solid var(--border-color);white-space:nowrap}
#food-delivery-interface .address-item-actions{display:flex;gap:8px;flex-shrink:0}
#food-delivery-interface .address-item-action-btn{background:none;border:none;color:var(--secondary-color);font-size:14px;cursor:pointer;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .address-item-action-btn:hover{background-color:var(--light-color);color:var(--primary-color)}
#food-delivery-interface .address-item-content{font-size:14px;color:var(--secondary-color);line-height:1.5;word-break:break-word}
#food-delivery-interface .no-addresses{text-align:center;padding:40px 20px;color:#999}
#food-delivery-interface .no-addresses i{font-size:48px;margin-bottom:16px;color:#ddd}
#food-delivery-interface .no-addresses p{font-size:14px}
#food-delivery-interface .profile-page{padding:20px 8px}
#food-delivery-interface .profile-header{background-color:#fff;border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid var(--border-color)}
#food-delivery-interface .profile-info{display:flex;flex-direction:column;gap:16px}
#food-delivery-interface .profile-field{display:flex;flex-direction:column;gap:6px}
#food-delivery-interface .profile-field label{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .name-display{display:flex;align-items:center;justify-content:space-between;padding:6px 0;cursor:pointer;transition:background-color .3s;border-radius:4px;padding-left:8px}
#food-delivery-interface .name-display:hover{background-color:var(--light-color)}
#food-delivery-interface .name-display.editing{background-color:var(--light-color);border-bottom:1px solid var(--primary-color)}
#food-delivery-interface .name-text{font-size:16px;color:var(--primary-color);font-weight:500;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .name-edit-btn{background:none;border:none;color:var(--secondary-color);font-size:14px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all .3s;display:none;white-space:nowrap}
#food-delivery-interface .name-display:hover .name-edit-btn{display:block}
#food-delivery-interface .name-display.editing .name-edit-btn{display:block;color:var(--primary-color);background-color:#fff;border:1px solid var(--border-color)}
#food-delivery-interface .name-edit-input{display:none;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;outline:none;color:var(--primary-color);background-color:#fff;margin-bottom:12px;width:100%;box-sizing:border-box}
#food-delivery-interface .name-edit-input.active{display:block}
#food-delivery-interface .profile-edit-btn{padding:10px 20px;background-color:var(--primary-color);color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:background-color .3s;align-self:flex-start;display:none}
#food-delivery-interface .profile-edit-btn.active{display:block}
#food-delivery-interface .profile-menu{background-color:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
#food-delivery-interface .menu-item{display:flex;align-items:center;padding:16px;border-bottom:1px solid var(--border-color);text-decoration:none;color:var(--primary-color);transition:background-color .3s;cursor:pointer}
#food-delivery-interface .menu-item:last-child{border-bottom:none}
#food-delivery-interface .menu-item:hover{background-color:var(--light-color)}
#food-delivery-interface .menu-item i{font-size:20px;margin-right:12px;color:var(--secondary-color);width:24px;text-align:center}
#food-delivery-interface .menu-item span{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .menu-item .arrow{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .favorites-page{padding:20px 8px}
#food-delivery-interface .favorites-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;scrollbar-width:none}
#food-delivery-interface .favorites-list::-webkit-scrollbar{display:none}
#food-delivery-interface .favorites-empty{text-align:center;padding:60px 20px;color:#999;grid-column:1/-1}
#food-delivery-interface .favorites-empty i{font-size:48px;margin-bottom:16px;color:#ddd}
#food-delivery-interface .favorites-empty p{font-size:16px;margin-top:10px}
#food-delivery-interface .evaluations-page{padding:20px 8px}
#food-delivery-interface .evaluations-list{max-height:100%;overflow-y:auto;padding-right:5px;scrollbar-width:none}
#food-delivery-interface .evaluations-list::-webkit-scrollbar{display:none}
#food-delivery-interface .evaluation-card{background-color:#fff;border-radius:12px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);border:1px solid var(--border-color);overflow:hidden;transition:transform .3s,box-shadow .3s}
#food-delivery-interface .evaluation-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
#food-delivery-interface .evaluation-header{padding:16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .evaluation-restaurant{font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .evaluation-time{font-size:12px;color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .evaluation-content{padding:16px}
#food-delivery-interface .rating-section{margin-bottom:16px}
#food-delivery-interface .rating-title{font-size:14px;color:var(--secondary-color);margin-bottom:8px}
#food-delivery-interface .star-rating-input{display:flex;gap:5px}
#food-delivery-interface .star-input{font-size:24px;color:#ddd;cursor:pointer;transition:color .2s;flex-shrink:0}
#food-delivery-interface .star-input.active{color:#fc0}
#food-delivery-interface .comment-section{margin-bottom:16px}
#food-delivery-interface .comment-input{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;outline:none;resize:vertical;min-height:80px;margin-top:8px;color:var(--primary-color);background-color:#fff;box-sizing:border-box}
#food-delivery-interface .evaluation-actions{display:flex;justify-content:flex-end;gap:10px}
#food-delivery-interface .evaluation-btn{padding:6px 10px;border-radius:16px;font-size:12px;cursor:pointer;border:1px solid var(--border-color);background-color:#fff;color:var(--primary-color);transition:all .3s;white-space:nowrap}
#food-delivery-interface .evaluation-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .evaluation-btn.primary:hover{background-color:#222}
#food-delivery-interface .evaluation-btn:hover{background-color:var(--light-color)}
#food-delivery-interface .submitted-evaluation{padding:16px;border-top:1px solid var(--border-color);background-color:var(--light-color);position:relative}
#food-delivery-interface .submitted-evaluation-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
#food-delivery-interface .submitted-evaluation-title{font-size:16px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .submitted-evaluation-time{font-size:12px;color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .submitted-rating{display:flex;align-items:center;margin-bottom:8px}
#food-delivery-interface .submitted-comment{font-size:14px;color:var(--primary-color);line-height:1.5;margin-bottom:12px;padding:10px;background-color:#fff;border-radius:8px;border:1px solid var(--border-color);word-break:break-word}
#food-delivery-interface .overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1400;opacity:0;visibility:hidden;transition:opacity .4s,visibility .4s}
#food-delivery-interface .overlay.active{opacity:1;visibility:visible}
@media (max-width:768px){#food-delivery-interface .food-grid,#food-delivery-interface .favorites-list{grid-template-columns:1fr}#food-delivery-interface .recommendation-modal,#food-delivery-interface .cart-detail-modal{width:96%}}
@media (min-width:992px){#food-delivery-interface .food-grid,#food-delivery-interface .favorites-list{grid-template-columns:repeat(3,1fr)}}
#food-delivery-interface .text-primary{color:var(--primary-color)}
#food-delivery-interface .text-secondary{color:var(--secondary-color)}
#food-delivery-interface .bg-light{background-color:var(--light-color)}
#food-delivery-interface .border-light{border-color:var(--border-color)}
#food-delivery-interface .countdown-container{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:12px;background-color:var(--light-color);border-radius:8px;border:1px solid var(--border-color)}
#food-delivery-interface .countdown-label{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .countdown-time{font-size:20px;font-weight:800;color:var(--primary-color)}
#food-delivery-interface .countdown-time.overtime{color:var(--danger-color)}
#food-delivery-interface .countdown-status{font-size:12px;padding:4px 8px;border-radius:10px;background-color:var(--light-color);color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .countdown-status.on-time{background-color:rgba(76,175,80,.1);color:var(--success-color)}
#food-delivery-interface .countdown-status.delayed{background-color:rgba(255,152,0,.1);color:var(--warning-color)}
#food-delivery-interface .countdown-status.overtime{background-color:rgba(244,67,54,.1);color:var(--danger-color)}
#food-delivery-interface .add-food-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2500;display:none;justify-content:center;align-items:center}
#food-delivery-interface .add-food-modal-content{background-color:#fff;border-radius:12px;width:94%;max-width:500px;max-height:80vh;overflow-y:auto;border:2px solid var(--border-color)}
#food-delivery-interface .add-food-modal-header{padding:20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .add-food-modal-header h2{font-size:18px;margin:0;color:var(--primary-color)}
#food-delivery-interface .add-food-modal-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer}
#food-delivery-interface .add-food-modal-body{padding:20px}
#food-delivery-interface .add-food-modal-body .form-group{margin-bottom:15px}
#food-delivery-interface .add-food-modal-body label{display:block;margin-bottom:5px;font-size:14px;color:var(--secondary-color);font-weight:600}
#food-delivery-interface .add-food-modal-body input,#food-delivery-interface .add-food-modal-body textarea,#food-delivery-interface .add-food-modal-body select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;color:var(--primary-color);background-color:#fff;box-sizing:border-box}
#food-delivery-interface .add-food-modal-body textarea{resize:vertical;min-height:80px}
#food-delivery-interface .add-food-modal-body input:focus,#food-delivery-interface .add-food-modal-body textarea:focus,#food-delivery-interface .add-food-modal-body select:focus{border-color:var(--primary-color);outline:none}
#food-delivery-interface .add-food-modal-actions{padding:20px;border-top:1px solid var(--border-color);display:flex;gap:10px}
#food-delivery-interface .add-food-modal-btn{flex:1;padding:12px;border-radius:6px;border:1px solid var(--border-color);font-size:14px;cursor:pointer;transition:all .3s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .add-food-modal-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .add-food-modal-btn.primary:hover{background-color:#222}
#food-delivery-interface .add-food-modal-btn.secondary{background-color:#fff;color:var(--primary-color)}
#food-delivery-interface .add-food-modal-btn.secondary:hover{background-color:var(--light-color)}
#food-delivery-interface .delete-food-btn{background:transparent;border:none;color:#000;cursor:pointer;font-size:18px;padding:0;margin:0}
#food-delivery-interface .delete-food-btn:hover{color:#000}
.food-order-section{margin-top:15px;padding:15px;border:1px solid #000;border-radius:8px;background:#fafafa}
.food-order-section h3{font-size:16px;font-weight:600;margin-bottom:10px}
.order-list{max-height:150px;overflow-y:auto;margin-bottom:10px;border:1px solid #ddd;padding:10px;background:#fff;scrollbar-width:none}
.order-list::-webkit-scrollbar{display:none}
.order-item{padding:8px;border-bottom:1px solid #eee;display:flex;align-items:center}
.order-item:last-child{border-bottom:none}
.order-item input{margin-right:10px}
.order-info{flex:1;font-size:12px;overflow:hidden}
.order-details{font-size:11px;color:#666;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.order-actions{display:flex;gap:10px}
.order-actions button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.order-actions button:hover{background:#f0f0f0}
#fab-container{position:absolute;right:25px;bottom:40px;z-index:1100;width:56px;height:56px}#fab-main-btn{width:100%;height:100%;background:#000;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2);position:relative;z-index:2}#fab-main-btn span{transition:transform .3s ease;display:inline-block}.fab-menu{position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none;transition:all .3s ease}.fab-menu-item{position:absolute;top:0;left:0;width:48px;height:48px;background:#333;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15);transition:all .3s cubic-bezier(0.68, -0.55, 0.27, 1.55);transform:scale(0);opacity:0;pointer-events:none}#fab-container.active .fab-menu{pointer-events:auto}#fab-container.active .fab-menu-item{transform:scale(1);opacity:1;pointer-events:auto}#fab-container.active .fab-menu-item:nth-child(1){transform:translateX(-75px)}#fab-container.active .fab-menu-item:nth-child(2){transform:translateX(-53px) translateY(-53px)}#fab-container.active .fab-menu-item:nth-child(3){transform:translateY(-75px)}.fab-menu-item[data-page="home"]{transition-delay:.2s}.fab-menu-item[data-page="orders"]{transition-delay:.1s}.fab-menu-item[data-page="profile"]{transition-delay:0s}

/* ==================== 谧笺书城 ==================== */
#bookstore-interface .header h1{margin-left:30px}
.bookstore-container{width:100%;height:100%;display:flex;background:#fff}
.sidebar-nav{width:70px;background:#fff;display:flex;flex-direction:column;align-items:center;padding:15px 0;flex-shrink:0}
.nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:15px 0;cursor:pointer;transition:all .2s ease;color:#666;border-left:3px solid transparent}
.nav-item:hover{background:#f0f0f0}
.nav-item.active{color:#000;border-left:3px solid #000;background:#fff}
.nav-icon{font-size:18px;margin-bottom:5px}
.nav-label{font-size:11px;font-weight:500}
.bookstore-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.bookstore-page{display:none;flex-direction:column;flex:1;overflow-y:auto;padding:8px}
.bookstore-page.active{display:flex}
.bookstore-container .page-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;border-bottom:2px solid #000;margin-bottom:15px;flex-shrink:0}
.bookstore-container .logo{font-size:18px;font-weight:700;letter-spacing:1px}
.bookstore-container .header-actions{display:flex;gap:8px}
.bookstore-container .header-btn{padding:5px 10px;border:1px solid #000;border-radius:15px;font-size:11px;background:#fff;cursor:pointer}
.bookstore-container .page-content{flex:1;overflow-y:auto}
.bookstore-container .nav-tabs{display:flex;gap:5px;margin-bottom:15px;overflow-x:auto;padding-bottom:5px;flex-shrink:0}
.bookstore-container .nav-tab{padding:6px 12px;border:1px solid #000;border-radius:15px;font-size:11px;white-space:nowrap;cursor:pointer;flex-shrink:0}
.bookstore-container .nav-tab.active{background:#000;color:#fff}
.bookstore-container .search-box{position:relative;margin-bottom:15px;flex-shrink:0}
.bookstore-container .search-input{width:100%;padding:8px 15px 8px 35px;border:1px solid #000;border-radius:15px;font-size:12px;background:#fff}
.bookstore-container .search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;color:#666}
.bookstore-container .section-title{font-size:14px;font-weight:600;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.bookstore-container .section-more{font-size:10px;color:#555;text-decoration:none;cursor:pointer}
.bookstore-container .featured-book,
.bookstore-container .book-item{border:1px solid #000;border-radius:10px;padding:12px;margin-bottom:15px;background:#fff}
.bookstore-container .featured-title,
.bookstore-container .book-title{font-size:15px;font-weight:600;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center}
.bookstore-container .featured-badge,
.bookstore-container .book-badge{font-size:10px;background:#000;color:#fff;padding:2px 6px;border-radius:8px;white-space:nowrap}
.bookstore-container .featured-meta,
.bookstore-container .book-meta{display:flex;gap:10px;font-size:11px;color:#555;margin-bottom:8px;flex-wrap:wrap}
.bookstore-container .featured-meta i,
.bookstore-container .book-meta i{margin-right:2px}
.bookstore-container .featured-desc,
.bookstore-container .book-desc{font-size:12px;line-height:1.4;margin-bottom:10px;color:#333}
.bookstore-container .featured-desc{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.bookstore-container .book-desc{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.bookstore-container .featured-stats,
.bookstore-container .book-stats{display:flex;justify-content:space-between;font-size:10px;color:#777}
.bookstore-container .book-list{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px}
.bookstore-container .shelf-empty{text-align:center;padding:40px 20px;color:#666;flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center}
.bookstore-container .shelf-empty i{font-size:48px;color:#ccc;margin-bottom:15px}
.bookstore-container .profile-info{text-align:center;padding:20px 0;flex-shrink:0}
.bookstore-container .avatar{width:80px;height:80px;border-radius:50%;border:2px solid #000;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;font-size:36px;color:#000;background:#f5f5f5}
.bookstore-container .menu-list{list-style:none;border-top:1px solid #ddd;margin-top:20px;flex-shrink:0}
.bookstore-container .menu-item{padding:15px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-size:14px;color:#000}
.bookstore-container .menu-item:hover{background:#f9f9f9}
.bookstore-container .remove-book{font-size:10px;color:#f44;border:none;background:none;cursor:pointer;padding:2px 5px;margin-left:8px}
@media (max-width:400px){
.bookstore-container .page-header{padding-bottom:8px}
.bookstore-container .logo{font-size:16px}
.bookstore-container .nav-tab{padding:5px 10px;font-size:10px}
.sidebar-nav{width:60px}
.nav-icon{font-size:16px}
.nav-label{font-size:10px}}
    </style>  
</head>  
<body>  
<!-- 删除模态框 -->
<div class="confirm-dialog" id="confirm-dialog"><div class="confirm-content"><h3>确认删除</h3><p>您确定要删除这条消息吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-btn">确认删除</button><button id="cancel-delete-btn">取消</button></div></div></div><div class="confirm-dialog" id="import-confirm-dialog"><div class="confirm-content"><h3>导入聊天记录</h3><p>导入聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要继续吗？</p><div class="confirm-buttons"><button id="confirm-import-btn">确认导入</button><button id="cancel-import-btn">取消</button></div></div></div><div class="confirm-dialog" id="restore-confirm-dialog"><div class="confirm-content"><h3>恢复聊天记录</h3><p id="restore-confirm-text">恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复吗？</p><div class="confirm-buttons"><button id="confirm-restore-btn">确认恢复</button><button id="cancel-restore-btn">取消</button></div></div></div><div class="confirm-dialog" id="clear-chat-dialog"><div class="confirm-content"><h3>清空聊天记录</h3><p id="clear-chat-text">您确定要清空所有聊天记录吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-clear-chat-btn">确认清空</button><button id="cancel-clear-chat-btn">取消</button></div></div></div><div class="confirm-dialog" id="delete-selected-dialog"><div class="confirm-content"><h3>删除选中消息</h3><p id="delete-selected-text">您确定要删除选中的消息吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-selected-btn">确认删除</button><button id="cancel-delete-selected-btn">取消</button></div></div></div><div class="confirm-dialog" id="delete-worldbook-dialog"><div class="confirm-content"><h3>删除世界书记录</h3><p>您确定要删除这个记录吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-worldbook-btn">确认删除</button><button id="cancel-delete-worldbook-btn">取消</button></div></div></div><div class="confirm-dialog" id="weibo-delete-dialog"><div class="confirm-content"><h3>删除微博</h3><p>您确定要删除这条微博吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-weibo-delete-btn">确认删除</button><button id="cancel-weibo-delete-btn">取消</button></div></div></div>

<!-- 钱包模态框 -->
<div class="wallet-modal" id="rechargeModal"><div class="wallet-modal-content"><div class="wallet-modal-header"><h2 class="wallet-modal-title">手机充值</h2><button class="wallet-close-btn" id="closeModal">&times;</button></div><div class="wallet-input-group"><label class="wallet-input-label">充值金额 (元)</label><input type="number" class="amount-input" id="rechargeAmount" placeholder="请输入充值金额" min="1" step="0.01"></div><button class="wallet-confirm-btn" id="confirmRecharge">确认充值</button></div></div><div class="utility-modal" id="utilityModal"><div class="utility-modal-content"><div class="utility-modal-header"><h2 class="utility-modal-title">本月水电费</h2><button class="utility-close-btn" id="closeUtilityModal">&times;</button></div><div class="house-type-selector"><label for="houseTypeSelect">选择房型</label><select class="house-type-select" id="houseTypeSelect"><option value="豪宅、庄园、城堡">豪宅、庄园、城堡</option><option value="别墅、独栋">别墅、独栋</option><option value="高档公寓、大平层">高档公寓、大平层</option><option value="普通公寓、居民楼、小区">普通公寓、居民楼、小区</option><option value="经济适用房、小户型">经济适用房、小户型</option><option value="宿舍、合租房">宿舍、合租房</option><option value="老破小、旧房" selected>老破小、旧房</option><option value="农村自建房、乡村">农村自建房、乡村</option></select></div><div class="utility-info"><div class="utility-item"><span>当前房型:</span><span id="utility-house-type">老破小</span></div><div class="utility-item"><span>水费:</span><span id="utility-water">0.00 元</span></div><div class="utility-item"><span>电费:</span><span id="utility-electricity">0.00 元</span></div><div class="utility-total"><span>总计:</span><span id="utility-total">0.00 元</span></div></div><button class="utility-confirm-btn" id="confirmUtility">确认缴纳</button></div></div>

<!-- 世界书模态框 -->
<div class="worldbook-modal" id="worldbook-modal"><div class="worldbook-modal-content"><h3 id="worldbook-modal-title">添加世界书记录</h3><div class="worldbook-form-group"><label for="worldbook-title">记录标题</label><input type="text" class="worldbook-form-input" id="worldbook-title" placeholder="输入记录标题..."></div><div class="worldbook-form-group"><label for="worldbook-content">记录内容</label><textarea class="worldbook-form-textarea" id="worldbook-content" placeholder="输入记录内容..."></textarea></div><div class="worldbook-form-actions"><button class="worldbook-form-btn" id="save-worldbook-btn">保存</button><button class="worldbook-form-btn" id="cancel-worldbook-btn">取消</button></div><div class="worldbook-status" id="worldbook-status"></div></div></div>

<!-- 微博模态框 -->
<div class="weibo-modal" id="chatCharacterModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>编辑聊天角色主页</h3><button class="weibo-close-modal" id="closeChatCharacterModal">×</button></div><div class="weibo-profile-form"><div class="weibo-form-group"><label for="chatCharacterName">角色姓名</label><input type="text" id="chatCharacterName" placeholder="请输入角色姓名"></div><div class="weibo-form-group"><label for="chatCharacterBio">角色简介</label><textarea id="chatCharacterBio" placeholder="介绍一下角色..."></textarea></div><div class="weibo-form-group"><label for="chatCharacterFollowers">粉丝数量</label><input type="number" id="chatCharacterFollowers" placeholder="请输入粉丝数量"></div><button class="weibo-save-profile-btn" id="saveChatCharacterBtn">保存角色设置</button></div></div></div><div class="weibo-modal" id="weiboCategoryModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>管理分类</h3><button class="weibo-close-modal" id="weiboCloseCategoryModal">×</button></div><div class="weibo-category-input-group"><input type="text" class="weibo-category-input" id="weiboNewCategoryInput" placeholder="输入新分类名称"><button class="weibo-add-category-btn" id="weiboAddCategoryBtn">添加</button></div><div class="weibo-category-list" id="weiboCategoryList"></div></div></div><div class="weibo-modal" id="weiboProfileModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>编辑个人资料</h3><button class="weibo-close-modal" id="weiboCloseProfileModal">×</button></div><div class="weibo-profile-form"><div class="weibo-form-group"><label for="weiboProfileName">姓名</label><input type="text" id="weiboProfileName" placeholder="请输入您的姓名"></div><div class="weibo-form-group"><label for="weiboProfileBio">个人简介</label><textarea id="weiboProfileBio" placeholder="介绍一下自己..."></textarea></div><div class="weibo-form-group"><label for="weiboProfilePersona">人设/标签</label><input type="text" id="weiboProfilePersona" placeholder="例如：摄影爱好者、程序员、美食家等"></div><div class="weibo-form-group"><label for="weiboProfileLocation">所在地</label><input type="text" id="weiboProfileLocation" placeholder="请输入您所在的城市"></div><div class="weibo-form-group"><label for="weiboProfileFollowers">粉丝数量</label><input type="number" id="weiboProfileFollowers" placeholder="请输入粉丝数量"></div><div class="weibo-form-group"><label for="weiboProfileFollowing">关注数量</label><input type="number" id="weiboProfileFollowing" placeholder="请输入关注数量"></div><button class="weibo-save-profile-btn" id="weiboSaveProfileBtn">保存资料</button></div></div></div><div class="weibo-comment-modal" id="weiboCommentModal"><div class="weibo-comment-content"><div class="weibo-modal-header"><h3>评论</h3><button class="weibo-close-modal" id="weiboCloseCommentModal">×</button></div><textarea class="weibo-comment-input" id="weiboCommentInput" placeholder="写下您的评论..."></textarea><div class="weibo-comment-actions"><button class="weibo-cancel-comment" id="weiboCancelComment">取消</button><button class="weibo-submit-comment" id="weiboSubmitComment">发布评论</button></div><div class="weibo-comments-list" id="weiboCommentsList"></div></div></div>

<!-- 手机桌面 -->
<div class="phone-container"><div class="screen"><div class="desktop-interface active" id="desktop-interface"><div class="desktop-time" id="desktop-time">--:--</div><div class="desktop-signature" id="desktop-signature" contenteditable="true">点击编辑个性签名...</div><div class="lock-screen-btn" onclick="lockScreen.lock()"><i class="fas fa-lock"></i></div><div class="app-grid"><div class="app-item" onclick="openApp('chat')"><div class="app-icon">⊕</div><div class="app-label">聊天</div></div><div class="app-item" onclick="openApp('api')"><div class="app-icon">ꕥ</div><div class="app-label">API</div></div><div class="app-item" onclick="openApp('settings')"><div class="app-icon">Θ</div><div class="app-label">设置</div></div><div class="app-item" onclick="openApp('worldbook')"><div class="app-icon">✧</div><div class="app-label">世界书</div></div><div class="app-item" onclick="openApp('wallet')"><div class="app-icon">〒</div><div class="app-label">钱包</div></div><div class="app-item" onclick="openApp('music')"><div class="app-icon">ʊ</div><div class="app-label">拟刻</div></div><div class="app-item" onclick="openApp('weibo')"><div class="app-icon">㉿</div><div class="app-label">微界</div></div><div class="app-item" onclick="openApp('food-delivery')"><div class="app-icon">の</div><div class="app-label">桃源</div></div><div class="app-item" onclick="openApp('bookstore')"><div class="app-icon">♨</div><div class="app-label">谧笺</div></div></div></div>

<!-- 聊天界面 -->        
<div class="interface chat-interface" id="chat-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>✤世纪 <span class="status-indicator" id="chat-status"></span></h1><button class="toggle-persona" onclick="openPersonaModal()">编辑人设</button></div><div class="scrollable-content"><div class="chat-container"><div class="chat-messages" id="chat-messages"></div></div><div class="chat-management-section"><h3>聊天管理</h3><div class="chat-type-switch"><div class="chat-type-label">聊天类型: </div><div class="chat-type-buttons"><button class="chat-type-btn active" id="single-chat-btn" onclick="switchChatType('single')">单聊</button><button class="chat-type-btn" id="multi-chat-btn" onclick="switchChatType('multi')">多聊</button></div></div><div class="multi-persona-selector" id="multi-persona-selector"><label class="multi-persona-label">当前角色:</label><select class="persona-select" id="multi-persona-select" onchange="switchMultiPersona()"></select><div class="multi-persona-management"><button onclick="refreshMultiPersonaSelect()">刷新角色</button><button onclick="openPersonaModal(); switchPersonaTab('multi')">管理角色</button></div></div><div class="chat-mode-switch"><div class="chat-mode-label">聊天模式: <span id="chat-mode-display">线上模式</span><span class="chat-mode-indicator chat-mode-online" id="chat-mode-indicator"></span></div><div class="chat-mode-buttons"><button class="chat-mode-btn active" id="online-mode-btn" onclick="switchChatMode('online')">线上</button><button class="chat-mode-btn" id="offline-mode-btn" onclick="switchChatMode('offline')">线下</button></div></div><div class="chat-mode-description" id="chat-mode-description">线上模式: 短信模式短文本，日常说话风格 | 线下模式: 剧情模式长文本，唯美小说风格</div><div class="chat-management-buttons"><button onclick="clearAllChatHistory()">一键清空记录</button><button onclick="toggleSelectionMode()" id="selection-mode-btn">选择消息清空</button></div><div class="selection-mode-info" id="selection-mode-info"><span>已选择 <span class="selection-count" id="selection-count">0</span> 条消息</span><div class="selection-actions" id="selection-actions"><button onclick="deleteSelectedMessages()" class="danger">删除选中消息</button><button onclick="toggleSelectionMode()">取消选择</button></div></div></div><div class="food-order-section"><h3>外卖订单</h3><div class="order-list" id="order-list"><div class="empty-order">正在加载已送达订单...</div></div><div class="order-actions"><button onclick="loadDeliveredOrders()">刷新订单</button><button onclick="goToFoodDelivery()">去桃源点外卖</button></div></div><div class="backup-section"><h3>聊天备份</h3><div class="backup-buttons"><button onclick="exportChatHistory()">导出聊天记录</button><button onclick="importChatHistory()">导入聊天记录</button><button onclick="backupToLocal()">备份到本地</button><button onclick="restoreFromLocal()">从本地恢复</button></div><div class="backup-status" id="backup-status"></div><div class="backup-info">使用导出/导入功能可以在不同浏览器之间迁移聊天记录</div><input type="file" class="backup-file-input" id="backup-file-input" accept=".json"></div><div class="scroll-hint" id="chat-scroll-hint">↑ 继续向上滑动查看更多内容</div></div><div class="chat-input-container"><div class="chat-input"><input type="text" id="message-input" placeholder="输入您的消息..." onkeypress="handleMessageKeypress(event)"><button onclick="handleSendButtonClick()" id="send-button">发送</button></div></div><div class="app-navigation" style="display: none;"></div></div><!-- 人设模态框 --><div class="persona-modal" id="persona-modal"><div class="modal-content"><div class="modal-header"><h3>人设管理</h3><button class="close-modal" onclick="closePersonaModal()">×</button></div><div class="modal-body"><div class="persona-tabs"><button class="persona-tab active" onclick="switchPersonaTab('ai')">角色人设</button><button class="persona-tab" onclick="switchPersonaTab('user')">我的人设</button><button class="persona-tab" onclick="switchPersonaTab('multi')" id="multi-persona-tab">多聊角色</button></div><div class="persona-form-section active" id="ai-persona-section"><div class="form-section"><h4>角色人设</h4><div class="form-group"><label for="ai-persona-name">姓名</label><input type="text" class="form-input" id="ai-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="ai-persona-desc">人设描述</label><textarea class="form-input" id="ai-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="saveAIPersona()">保存角色</button><button onclick="loadAIPersona()">加载角色</button></div></div><div class="persona-preview" id="ai-persona-preview"><h5>人设预览：</h5><div id="ai-preview-content">暂无人设</div></div></div><div class="persona-form-section" id="user-persona-section"><div class="form-section"><h4>我的人设</h4><div class="form-group"><label for="user-persona-name">姓名</label><input type="text" class="form-input" id="user-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="user-persona-desc">人设描述</label><textarea class="form-input" id="user-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="saveUserPersona()">保存我的</button><button onclick="loadUserPersona()">加载我的</button></div></div><div class="persona-preview" id="user-persona-preview"><h5>人设预览：</h5><div id="user-preview-content">暂无我的人设</div></div></div><div class="persona-form-section" id="multi-persona-section"><div class="form-section"><h4>多聊角色</h4><div class="form-group"><label for="multi-persona-name">姓名</label><input type="text" class="form-input" id="multi-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="multi-persona-desc">人设描述</label><textarea class="form-input" id="multi-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="addMultiPersona()">添加角色</button><button onclick="saveMultiPersonas()">保存所有角色</button></div></div><div class="persona-preview" id="multi-persona-preview"><h5>多聊角色预览：</h5><div id="multi-preview-content">暂无多聊角色</div></div></div></div></div></div>

<!-- API界面 -->
<div class="interface" id="api-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>API配置 <span class="status-indicator" id="api-status-indicator"></span></h1></div><div class="scrollable-content"><div class="api-section"><h3>API提供商</h3><select class="api-input" id="api-provider" onchange="updateApiEndpoints()"><option value="openai">OpenAI</option><option value="anthropic">Anthropic (Claude)</option><option value="google">Google (Gemini)</option><option value="custom">自定义</option></select></div><div class="api-section"><h3>API端点配置</h3><input type="text" class="api-input" id="api-url" placeholder="输入API端点URL..." value="https://api.openai.com/v1"><input type="password" class="api-input" id="api-key" placeholder="输入API密钥..."><div class="api-buttons"><button onclick="testApiConnection()">测试连接</button><button onclick="refreshModels()">刷新模型列表</button><button onclick="saveApiConfig()">保存配置</button><button onclick="clearApiConfig()">清除配置</button></div><div class="api-status" id="api-status"></div></div><div class="api-section"><h3>模型选择</h3><div class="model-info"><span class="current-model" id="current-model-display">当前模型: 未选择</span><span class="model-badge" id="model-provider-badge">OpenAI</span></div><select class="api-input" id="model-select" onchange="updateSelectedModel()"><option value="">请选择模型</option></select><div class="refresh-status"><button class="refresh-button" onclick="refreshModels()">刷新模型</button><span class="last-updated" id="last-updated">上次更新: 从未</span></div><div class="model-list" id="model-list" style="display: none;"><div class="api-status" id="models-status"></div></div></div><div class="api-section"><h3>高级设置</h3><div class="form-group"><label for="temperature">温度 (0-2)</label><input type="range" class="api-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateTemperatureValue()"><span id="temperature-value">0.7</span></div><div class="form-group"><label for="max-tokens">最大令牌数</label><input type="number" class="api-input" id="max-tokens" value="1000" min="1" max="4000"></div><div class="form-group"><label for="reply-count">角色回复条数 (1-5)</label><input type="number" class="api-input" id="reply-count" value="1" min="1" max="5"></div></div><div class="scroll-hint" id="api-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>
        
<!-- 设置界面 -->
<div class=interface id=settings-interface><div class=header><button class=back-button onclick="goBackToDesktop()">●</button><h1>系统设置 <span class=status-indicator id=settings-status style="background-color:#0f0;"></span></h1></div><div class=scrollable-content><div class=settings-container><div class=settings-category><h3 class=settings-category-title>连接</h3><div class=settings-list><div class=settings-item onclick=toggleSetting('wifi')><div class=settings-icon>W</div><div class=settings-info><div class=settings-title>WLAN</div><div class=settings-desc>已连接/未连接</div></div><div class=settings-switch><label class=switch><input type=checkbox id=wifi-toggle><span class=slider></span></label></div></div><div class=settings-item onclick=toggleSetting('mobile')><div class=settings-icon>N</div><div class=settings-info><div class=settings-title>移动网络</div><div class=settings-desc>5G/6G</div></div><div class=settings-switch><label class=switch><input type=checkbox id=mobile-toggle><span class=slider></span></label></div></div><div class=settings-item onclick=toggleSetting('bluetooth')><div class=settings-icon>B</div><div class=settings-info><div class=settings-title>蓝牙</div><div class=settings-desc>已连接/未连接</div></div><div class=settings-switch><label class=switch><input type=checkbox id=bluetooth-toggle><span class=slider></span></label></div></div></div></div><div class=settings-category><h3 class=settings-category-title>设备</h3><div class=settings-list><div class=settings-item onclick=openSubSetting('sound')><div class=settings-icon>S</div><div class=settings-info><div class=settings-title>声音</div><div class=settings-desc>音量与震动</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick="openApp('style')"><div class=settings-icon>D</div><div class=settings-info><div class=settings-title>显示</div><div class=settings-desc>CSS美化</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick=openSubSetting('battery')><div class=settings-icon>P</div><div class=settings-info><div class=settings-title>电池</div><div class=settings-desc>电量剩余 100%</div></div><div class=settings-arrow>›</div></div></div></div><div class=settings-category><h3 class=settings-category-title>系统</h3><div class=settings-list><div class=settings-item onclick="openApp('security')"><div class=settings-icon>L</div><div class=settings-info><div class=settings-title>安全隐私</div><div class=settings-desc>密码与权限</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick=openSubSetting('storage')><div class=settings-icon>M</div><div class=settings-info><div class=settings-title>存储</div><div class=settings-desc>内存1TB</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick=openSubSetting('about')><div class=settings-icon>I</div><div class=settings-info><div class=settings-title>关于手机</div><div class=settings-desc>版本与设备</div></div><div class=settings-arrow>›</div></div></div></div><div class=settings-footer><div class=app-version>版本 1.0.0</div><div class=copyright>✤世纪小手机✤</div></div></div><div class=scroll-hint id=settings-scroll-hint>↑ 继续向上滑动查看更多内容</div></div></div>

<!-- 美化界面 -->
<div class="interface" id="style-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>CSS美化 <span class="status-indicator" id="style-status"></span></h1></div><div class="scrollable-content"><div class="style-container"><div class="ai-circle">AI</div><textarea class="css-editor" id="css-editor" placeholder="输入全局CSS代码...">/* 在这里输入您的自定义CSS */
.message { border: 1px solid #000; background: white; margin: 8px 0; max-width: 85%; }
.user-message { margin-left: auto; background: #f8f8f8; }
.ai-message { margin-right: auto; background: #f0f0f0; }
.ai-circle { border: 3px solid #000; background: white; transition: all 0.3s ease; }
.ai-circle:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }</textarea><div class="style-buttons"><button class="apply-css" onclick="applyGlobalCSS()">应用CSS</button><button class="apply-css" onclick="resetCSS()">重置CSS</button><button class="apply-css" onclick="exportCSS()">导出CSS</button><button class="apply-css" onclick="importCSS()">导入CSS</button></div></div><div class="scroll-hint" id="style-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>

<!-- 密码设置界面 -->
<div class="interface" id="security-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>安全隐私 <span class="status-indicator" id="security-status"></span></h1></div><div class="scrollable-content"><div class="style-container" style="padding:20px;min-height:400px"><h2 style="margin-bottom:20px">安全隐私设置</h2><p style="color:#666;margin-bottom:30px">管理锁屏密码和其他安全设置</p><div id="password-display-area" style="width:100%;margin-bottom:30px"><div id="lock-icon-area" class="security-lock"><i class="fas fa-lock"></i></div><div id="saved-password-display" style="display:none;width:100%;padding:15px;border:2px solid #000;border-radius:8px;background:#fafafa;position:relative"><span id="password-stars" style="font-family:monospace;letter-spacing:3px;font-size:18px;position:absolute;left:15px;top:50%;transform:translateY(-50%)">●●●●●●</span><button onclick="deletePassword()" style="position:absolute;right:45px;top:50%;transform:translateY(-50%);padding:8px 15px;border:none;background:transparent;border-radius:4px;font-size:16px;cursor:pointer;color:#f00;font-weight:500">删除</button><button onclick="changePassword()" style="position:absolute;right:0px;top:50%;transform:translateY(-50%);padding:8px 15px;border:none;background:transparent;border-radius:4px;font-size:16px;cursor:pointer;color:#000;font-weight:500">修改</button></div></div><div id="password-setup-area" style="display:none;width:100%;margin-bottom:30px"><div style="margin-bottom:15px"><input type="password" id="setup-new-password" placeholder="输入新密码" style="width:100%;padding:12px;border:1px solid #000;border-radius:4px;margin-bottom:10px;font-size:14px"><input type="password" id="setup-confirm-password" placeholder="确认新密码" style="width:100%;padding:12px;border:1px solid #000;border-radius:4px;font-size:14px"></div><div style="display:flex;gap:10px"><button onclick="saveNewPassword()" style="flex:1;padding:10px;border:1px solid #000;background:#000;color:#fff;border-radius:4px;cursor:pointer;font-size:14px">保存密码</button><button onclick="cancelPasswordSetup()" style="flex:1;padding:10px;border:1px solid #000;background:#fff;border-radius:4px;cursor:pointer;font-size:14px">取消</button></div></div><div class="style-buttons" style="width:100%;margin-top:40px"><button class="apply-css" onclick="showPasswordSetup()">设置密码</button><button class="apply-css" onclick="alert('功能开发中')">权限管理</button><button class="apply-css" onclick="alert('功能开发中')">隐私设置</button><button class="apply-css" onclick="goBackToDesktop()">返回桌面</button></div><div id="password-status-message" style="margin-top:20px;padding:10px;border-radius:5px;text-align:center;display:none;font-size:13px"></div></div><div class="scroll-hint" id="security-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>

<!-- 世界书界面 -->
<div class="interface" id="worldbook-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>世界书 <span class="status-indicator" id="worldbook-status-indicator"></span></h1><button class="add-worldbook-btn" onclick="openWorldbookModal()">+</button></div><div class="scrollable-content"><div style="padding: 20px;"><h2>世界书管理 <span class="status-indicator" id="worldbook-status-indicator-title"></span></h2><p>世界书是告诉AI除了角色之外还需要遵守的行为准则和世界观设定。</p><div class="worldbook-list" id="worldbook-list"></div><div class="worldbook-backup-section"><h3>世界书备份管理</h3><p style="font-size: 12px; color: #666; margin-bottom: 10px;">备份您的世界书记录到本地文件，或从文件导入恢复</p><div class="worldbook-backup-buttons"><button onclick="exportWorldbookRecords()">导出世界书记录</button><button onclick="importWorldbookRecords()">导入世界书记录</button><button onclick="backupWorldbookToLocal()">备份到本地存储</button><button onclick="restoreWorldbookFromLocal()">从本地恢复</button></div><div class="worldbook-backup-status" id="worldbook-backup-status"></div><div class="worldbook-backup-info">使用导出/导入功能可以在不同设备之间迁移世界书记录</div><input type="file" class="worldbook-backup-file-input" id="worldbook-backup-file-input" accept=".json"></div><div class="worldbook-status" id="worldbook-status"></div></div><div class="scroll-hint" id="worldbook-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>

<!-- 钱包界面 -->
<div class="interface" id="wallet-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>钱包 <span class="status-indicator" id="wallet-status"></span></h1></div><div class="scrollable-content"><div class="wallet-container"><section class="balance-card"><div class="balance-label">总余额 (元)</div><div class="balance-amount" id="totalBalance">0.00</div><div class="balance-sub-info"><span>今日支出: ¥<span id="todayExpense">0.00</span></span><span>本月收入: ¥<span id="monthIncome">0.00</span></span></div></section><section class="action-buttons"><button class="action-btn" id="rechargeBtn"><span class="icon">✚</span> 手机充值</button><button class="action-btn" id="utilityBtn"><span class="icon">⚡</span> 水电费</button></section><section class="transaction-section"><h3>收入支出</h3><div class="transaction-list" id="transaction-list"></div></section></div></div></div>

<!-- 音乐界面 -->
<div class="interface" id="music-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>黑胶唱片 <span class="status-indicator" id="music-status"></span></h1></div><div class="scrollable-content"><div class="music-player"><div class="music-fixed-area"><div class="disc-container"><div class="disc" id="disc"><div class="disc-center"></div></div></div><div class="song-info"><div class="song-title" id="song-title">选择音频开始播放</div><div class="song-artist" id="song-artist">-</div></div><div class="progress-container"><div class="progress-info"><span class="current-time" id="current-time">0:00</span><span class="duration" id="duration">0:00</span></div><div class="progress-bar" id="progress-bar"><div class="progress" id="progress"></div></div></div><div class="control-buttons"><button class="btn btn-loop active" id="list-loop-btn" title="顺序播放">✦</button><button class="btn btn-prev" id="prev-btn">⏮</button><button class="btn btn-play" id="play-pause-btn">▶</button><button class="btn btn-next" id="next-btn">⏭</button><button class="btn btn-loop" id="single-loop-btn" title="单曲循环">✦</button></div></div><div class="music-scrollable-area"><div class="import-section"><div class="import-btn" id="import-btn">选择音频文件</div><input type="file" class="file-input" id="file-input" accept="audio/*" multiple><div class="playlist" id="playlist"><div class="playlist-item empty">播放列表为空</div></div></div></div></div></div></div>

<!-- 微界界面 -->
<div class="interface" id="weibo-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>MicroWorld<span class="status-indicator" id="weibo-status"></span></h1></div><div class="scrollable-content"><div class="weibo-container"><header class="weibo-header"><div class="weibo-logo">Horizon</div><nav class="weibo-nav"><a href="#" id="weiboHomeLink" class="active">首页</a><a href="#" id="weiboDiscoverLink">发现</a><a href="#" id="weiboProfileLink">我的</a></nav></header><section id="weiboHomePage" class="weibo-page-content active"><section class="weibo-category-section"><div class="weibo-category-header"><div class="weibo-category-title">内容分类</div><button class="weibo-manage-categories-btn" id="weiboManageCategories">管理分类</button><button class="weibo-refresh-btn" id="weiboRefreshDynamicBtn">生成动态</button></div><div class="weibo-category-tags" id="weiboCategoryTags"></div></section><section class="weibo-compose-section"><div class="weibo-compose-box"><div class="weibo-avatar" id="weiboUserAvatar"></div><div class="weibo-compose-input"><textarea placeholder="分享新鲜事..." id="weiboText"></textarea><div class="weibo-compose-actions"><select class="weibo-category-select" id="weiboCategorySelect"><option value="">选择分类</option></select><button class="weibo-publish-btn" id="weiboPublishBtn">发布</button></div></div></div></section><section class="weibo-list" id="weiboList"></section></section><section id="weiboDiscoverPage" class="weibo-page-content"><div class="weibo-discover-section"><div class="weibo-discover-title">发现精彩内容</div><div class="weibo-trending-topics"><div class="weibo-trending-header"><div class="weibo-trending-title">微博热搜</div><button class="weibo-refresh-btn" id="weiboRefreshHotSearch">刷新榜单</button></div><div class="weibo-topic-list" id="weiboHotSearchList"></div></div><div class="weibo-trending-topics"><div class="weibo-trending-header"><div class="weibo-trending-title">热门话题</div><button class="weibo-refresh-btn" id="weiboRefreshTopics">换一批</button></div><div class="weibo-topic-list" id="weiboTopicList"></div></div><div class="weibo-random-quote" id="weiboRandomQuote"></div></div></section><section id="weiboProfilePage" class="weibo-page-content"><div class="weibo-discover-section"><div class="weibo-discover-title">个人主页</div><div class="profile-card" id="myProfileCard"><div class="profile-summary" onclick="toggleProfileCard()"><div class="profile-avatar" id="myProfileAvatar"></div><div class="profile-basic"><div class="profile-name" id="myProfileName">微博用户</div><div class="profile-bio" id="myProfileBio">这个人很懒，什么都没有写...</div></div><button class="profile-toggle">▼</button></div><div class="profile-details"><div class="profile-stats"><div class="profile-stat"><div class="profile-stat-number" id="myProfileFollowers">0</div><div class="profile-stat-label">粉丝</div></div><div class="profile-stat"><div class="profile-stat-number" id="myProfileFollowing">0</div><div class="profile-stat-label">关注</div></div><div class="profile-stat"><div class="profile-stat-number" id="myProfileWeibos">0</div><div class="profile-stat-label">微博</div></div></div><button class="profile-edit-btn" id="editMyProfileBtn">编辑我的主页</button></div></div></div></section></div></div></div>

<!-- 桃源界面 -->
<div class="interface" id="food-delivery-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>桃源外卖 <span class="status-indicator" id="food-status"></span></h1><button class="cart-btn" id="cart-btn"><i class="fas fa-shopping-cart"></i><div class="cart-count" id="cart-count">0</div></button></div><div class="food-page-container home-page active" id="home-page"><div class="search-container"><div class="search-box"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" placeholder="搜索美食、商家"></div></div><div class="categories"><div class="category-item active"><div class="category-icon"><i class="fas fa-utensils"></i></div><div class="category-name">全部</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-hamburger"></i></div><div class="category-name">汉堡</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-pizza-slice"></i></div><div class="category-name">披萨</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-bowl-food"></i></div><div class="category-name">中餐</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-mug-hot"></i></div><div class="category-name">饮品</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-ice-cream"></i></div><div class="category-name">甜点</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-drumstick-bite"></i></div><div class="category-name">炸鸡</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-bread-slice"></i></div><div class="category-name">面包</div></div><div class="category-item" id="add-food-category"><div class="category-icon"><i class="fas fa-plus"></i></div><div class="category-name">添加</div></div></div><div class="recommendations"><h2 class="section-title">今日美食推荐</h2><div class="food-grid" id="food-grid"></div><h2 class="section-title" style="margin-top:30px">附近热门美食</h2><div class="food-grid" id="hot-food-grid"></div></div></div><div class="food-page-container orders-page" id="orders-page"><div class="orders-filter"><button class="filter-btn active" data-filter="all">全部订单</button><button class="filter-btn" data-filter="delivering">配送中</button><button class="filter-btn" data-filter="delivered">已送达</button><button class="filter-btn" data-filter="canceled">已取消</button><button class="filter-btn" data-filter="overtime">已超时</button></div><div class="orders-list" id="orders-list"><div class="empty-orders" id="empty-orders"><i class="fas fa-clipboard-list"></i><p>暂无订单</p><p>快去首页选购美食吧！</p></div></div></div><div class="food-page-container profile-page" id="profile-page"><div class="profile-header"><div class="profile-info"><div class="profile-field"><label for="profile-name">姓名</label><div class="name-display" id="name-display"><div class="name-text" id="name-text">某某</div><button class="name-edit-btn" id="name-edit-btn"><i class="fas fa-edit"></i> 编辑</button></div><input type="text" class="name-edit-input" id="name-edit-input" value="…"><button class="profile-edit-btn" id="profile-save-btn">保存</button></div></div></div><div class="profile-menu"><div class="menu-item" id="address-menu-item"><i class="fas fa-map-marker-alt"></i><span>我的地址</span><i class="fas fa-chevron-right arrow"></i></div><div class="menu-item" id="favorites-menu-item"><i class="fas fa-heart"></i><span>我的收藏</span><i class="fas fa-chevron-right arrow"></i></div><div class="menu-item" id="evaluations-menu-item"><i class="fas fa-comment-alt"></i><span>我的评价</span><i class="fas fa-chevron-right arrow"></i></div></div></div><div class="food-page-container favorites-page" id="favorites-page"><h2 class="section-title">我的收藏</h2><div class="favorites-list" id="favorites-list"><div class="favorites-empty" id="empty-favorites"><i class="fas fa-heart"></i><p>暂无收藏</p><p>快去首页收藏你喜欢的美食吧！</p></div></div></div><div class="food-page-container evaluations-page" id="evaluations-page"><h2 class="section-title">我的评价</h2><div class="evaluations-list" id="evaluations-list"><div class="empty-orders" id="empty-evaluations"><i class="fas fa-comment-alt"></i><p>暂无评价</p><p>完成订单后可以在这里进行评价</p></div></div></div><div class="order-detail-modal" id="order-detail-modal"><div class="detail-header"><h2 class="detail-title">订单详情</h2><button class="detail-close" id="order-detail-close"><i class="fas fa-times"></i></button></div><div class="detail-content" id="order-detail-content"></div></div><div class="cart-detail-modal" id="cart-detail-modal"><div class="cart-detail-header"><h2 class="cart-detail-title">商品详情</h2><button class="cart-detail-close" id="cart-detail-close"><i class="fas fa-times"></i></button></div><div class="cart-detail-content" id="cart-detail-content"></div><div class="cart-detail-actions"><button class="cart-detail-btn secondary" id="cart-detail-cancel">取消</button><button class="cart-detail-btn primary" id="cart-detail-save">保存</button></div></div><div class="recommendation-modal" id="recommendation-modal"><div class="modal-header"><div class="modal-icon" id="recommendation-modal-icon"><i class="fas fa-crown"></i></div><button class="modal-close" id="modal-close"><i class="fas fa-times"></i></button></div><div class="modal-content"><h2 class="modal-title" id="recommendation-modal-title">招牌黑椒牛肉汉堡</h2><div class="modal-subtitle" id="recommendation-modal-subtitle">今日特惠 · 限量供应</div><p class="modal-desc" id="recommendation-modal-desc">精选澳洲牛肉饼，搭配浓郁黑椒酱汁，外层面包烤至金黄酥脆，内层蔬菜新鲜爽脆，口感层次丰富，肉质鲜嫩多汁。</p><div class="modal-features" id="recommendation-modal-features"><div class="modal-feature">厚实牛肉饼</div><div class="modal-feature">黑椒酱汁</div><div class="modal-feature">金黄面包</div><div class="modal-feature">新鲜蔬菜</div></div><div class="modal-price" id="recommendation-modal-price">¥38.8</div><div class="modal-actions"><button class="modal-btn secondary" id="modal-later">稍后看看</button><button class="modal-btn primary" id="modal-add">加入购物车</button></div></div></div><div class="add-food-modal" id="add-food-modal"><div class="add-food-modal-content"><div class="add-food-modal-header"><h2>添加新食物</h2><button class="add-food-modal-close" id="add-food-modal-close"><i class="fas fa-times"></i></button></div><div class="add-food-modal-body"><div class="form-group"><label for="new-food-name">食物名称</label><input type="text" id="new-food-name" placeholder="请输入食物名称"></div><div class="form-group"><label for="new-food-description">食物描述</label><textarea id="new-food-description" placeholder="请输入食物描述，介绍这道美食的特点..."></textarea></div><div class="form-group"><label for="new-food-price">价格 (元)</label><input type="number" id="new-food-price" placeholder="0.00" step="0.01" min="0"></div><div class="form-group"><label for="new-food-category">分类</label><select id="new-food-category"></option><option value="食物">自定义</option><option value="自定义">自定义分类</option></select><input type="text" id="new-food-custom-category" placeholder="输入自定义分类" style="display:none;margin-top:5px;"></div><div class="form-group"><label for="new-food-icon">图标</label><select id="new-food-icon"><option value="fas fa-utensils">通用</option></select></div><div class="form-group"><label for="new-food-features">标签</label><input type="text" id="new-food-features" placeholder="例如：新鲜, 辣味, 推荐"></div></div><div class="add-food-modal-actions"><button class="add-food-modal-btn secondary" id="add-food-cancel">取消</button><button class="add-food-modal-btn primary" id="add-food-save">保存食物</button></div></div></div><div class="cart-panel" id="cart-panel"><div class="cart-header"><h2 class="cart-title">购物车</h2><button class="cart-close" id="cart-close"><i class="fas fa-times"></i></button></div><div class="cart-address-info" id="cart-address-info"><div class="address-info-header"><div class="address-info-title">收货信息</div><button class="address-info-change" id="cart-change-address">更改</button></div><div class="address-info-content" id="cart-address-content">请添加收货地址</div></div><div class="cart-items" id="cart-items"><div style="text-align:center;padding:40px;color:#999">购物车是空的</div></div><div class="cart-footer"><div class="cart-total"><span>总计</span><span id="cart-total-price">¥0.0</span></div><button class="cart-checkout" id="checkout-btn">去结算</button></div></div><div class="address-panel" id="address-panel"><div class="address-header"><h2 class="address-title">我的地址</h2><button class="address-close" id="address-close"><i class="fas fa-times"></i></button></div><div class="address-content"><div class="address-input-group"><div class="address-input-title">添加/编辑地址</div><input type="text" class="address-input" id="address-input" placeholder="请输入详细地址（如：XX省XX市XX区XX街道XX号）"><div class="address-tags"><div class="address-tag active" data-tag="家">家</div><div class="address-tag" data-tag="公司">公司</div><div class="address-tag" data-tag="学校">学校</div><div class="address-tag" data-tag="其他">其他</div></div><button class="save-address-btn" id="save-address-btn">保存地址</button></div><div class="saved-addresses-section"><h3 class="saved-addresses-title">已保存的地址</h3><div class="address-list" id="address-list"></div></div></div></div><div class="overlay" id="overlay"></div><div id=fab-container><div class=fab-menu><div class=fab-menu-item data-page=home title=首页><i class="fas fa-home"></i></div><div class=fab-menu-item data-page=orders title=订单><i class="fas fa-file-alt"></i></div><div class=fab-menu-item data-page=profile title=我的><i class="fas fa-user"></i></div></div><div id=fab-main-btn><span>✤</span></div></div></div>

<!-- 谧笺界面 -->
<div class="interface" id="bookstore-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>谧笺 <span class="status-indicator" id="bookstore-status"></span></h1></div><div class="scrollable-content"><div class="bookstore-container"><div class="sidebar-nav"><div class="nav-item active" data-page="home" title="首页"><div class="nav-icon"><i class="fas fa-home"></i></div><div class="nav-label">首页</div></div><div class="nav-item" data-page="shelf" title="书架"><div class="nav-icon"><i class="fas fa-book"></i></div><div class="nav-label">书架</div></div><div class="nav-item" data-page="profile" title="我的"><div class="nav-icon"><i class="fas fa-user"></i></div><div class="nav-label">我的</div></div></div><div class="bookstore-content"><div id="bookstore-home" class="bookstore-page active"><div class="page-header"><div class="logo">谧笺</div><div class="header-actions"><button class="header-btn" id="loginBtn">登录</button><button class="header-btn" id="registerBtn">注册</button></div></div><div class="page-content"><div class="nav-tabs"><div class="nav-tab active" data-category="recommend">推荐</div><div class="nav-tab" data-category="serial">连载</div><div class="nav-tab" data-category="finished">完结</div><div class="nav-tab" data-category="classic">经典</div><div class="nav-tab" data-category="suspense">悬疑</div><div class="nav-tab" data-category="scifi">科幻</div></div><div class="search-box"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" placeholder="搜索书名、作者或关键词..."></div><div class="featured-section"><div class="section-title"><span>编辑推荐</span><a href="#" class="section-more">更多 <i class="fas fa-chevron-right"></i></a></div><div class="featured-book" data-id="1"><div class="featured-title"><span>沉默的钟摆</span><span class="featured-badge">连载中</span></div><div class="featured-meta"><span><i class="fas fa-user"></i> 墨尘</span><span><i class="fas fa-tag"></i> 悬疑/都市</span><span><i class="fas fa-star"></i> 9.2</span></div><div class="featured-desc">一部关于时间与记忆的悬疑小说，讲述了一个小镇上发生的离奇事件。主角发现镇上所有的钟表都在同一时刻停止，而随之而来的是一系列无法解释的现象...</div><div class="featured-stats"><span>32.1万字</span><span>今日更新 第124章</span></div></div></div><div class="featured-section"><div class="section-title"><span>热门书籍</span><a href="#" class="section-more">更多 <i class="fas fa-chevron-right"></i></a></div><div class="book-list"><div class="book-item" data-id="2"><div class="book-title"><span>暗夜行者</span><span class="book-badge">已完结</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 夜影</span><span><i class="fas fa-tag"></i> 都市/犯罪</span><span><i class="fas fa-star"></i> 9.5</span></div><div class="book-desc">在黑暗的都市中，一个神秘的组织在暗处操控着一切。主角作为潜行者，必须在重重迷雾中寻找真相，同时躲避追捕...</div><div class="book-stats"><span>45.7万字</span><span>完结作品</span></div></div><div class="book-item" data-id="3"><div class="book-title"><span>荒原笔记</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 荒野</span><span><i class="fas fa-tag"></i> 冒险/文学</span><span><i class="fas fa-star"></i> 9.3</span></div><div class="book-desc">一位探险家在未知荒原中的生存记录与心灵独白。不仅仅是野外生存指南，更是对人性与孤独的深刻探讨...</div><div class="book-stats"><span>28.3万字</span><span>经典重制版</span></div></div></div></div></div></div><div id="bookstore-shelf" class="bookstore-page"><div class="page-header"><div class="logo">书架</div><div class="header-actions"><button class="header-btn" id="shelfLoginBtn">登录</button><button class="header-btn" id="shelfRegisterBtn">注册</button></div></div><div class="page-content"><div class="shelf-empty" id="emptyShelf"><i class="fas fa-book-open"></i><div style="font-size:16px;margin-bottom:10px;">书架空空如也</div><div style="font-size:12px;color:#777;margin-bottom:20px;">快去发现好书加入书架吧</div><button class="header-btn" id="goDiscoverBtn">去发现好书</button></div><div id="shelfContent" style="display:none;"><div class="section-title"><span>我的书架</span><span class="section-more" id="editShelfBtn">编辑</span></div><div class="book-list" id="shelfBooks"></div></div></div></div><div id="bookstore-profile" class="bookstore-page"><div class="page-header"><div class="logo">我的</div><div class="header-actions"><button class="header-btn" id="profileLoginBtn">登录</button><button class="header-btn" id="profileRegisterBtn">注册</button></div></div><div class="page-content"><div class="profile-info"><div class="avatar"><i class="fas fa-user"></i></div><div style="font-size:16px;font-weight:600;margin-bottom:5px;">游客用户</div><div style="font-size:12px;color:#777;">点击登录享受完整功能</div></div><ul class="menu-list"><li class="menu-item" id="myCollection"><div><i class="fas fa-bookmark" style="margin-right:10px;"></i>我的收藏</div><i class="fas fa-chevron-right"></i></li><li class="menu-item" id="readingHistory"><div><i class="fas fa-history" style="margin-right:10px;"></i>阅读历史</div><i class="fas fa-chevron-right"></i></li><li class="menu-item" id="myComments"><div><i class="fas fa-comment" style="margin-right:10px;"></i>我的评论</div><i class="fas fa-chevron-right"></i></li><li class="menu-item" id="settings"><div><i class="fas fa-cog" style="margin-right:10px;"></i>设置</div><i class="fas fa-chevron-right"></i></li><li class="menu-item" id="about"><div><i class="fas fa-info-circle" style="margin-right:10px;"></i>关于谧笺</div><i class="fas fa-chevron-right"></i></li></ul></div></div></div></div></div></div>

<!-- 手机锁屏 -->        
<div class="lock-screen active" id="lock-screen"><div class="lock-screen-content"><div class="lock-icon" id="lock-icon"><i class="fas fa-lock"></i></div><div class="lock-time" id="lock-time">--:--</div><div class="lock-date" id="lock-date">--- --- --</div><div class="lock-weather" id="lock-weather"><div class="weather-location" id="weather-location">定位中...</div><div class="weather-info" id="weather-info">天气加载中...</div></div><div class="lock-quote" id="lock-quote"><div class="quote-text">Design is intelligence made visible.</div><div class="quote-author">— Alina Wheeler</div></div><div class="unlock-hint"><i class="fas fa-chevron-up"></i><span>上滑解锁</span></div></div><div class="lock-password-panel" id="lock-password-panel" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;border-radius:20px"><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:60px 20px 40px"><div class="password-time" style="font-size:80px;font-weight:700;margin-bottom:10px">--:--</div><div class="password-date" style="font-size:14px;color:#666;margin-bottom:40px">--- --- --</div><div style="width:250px;margin-bottom:30px"><input type="password" id="password-input" placeholder="输入密码" style="width:100%;padding:12px;border:2px solid #000;border-radius:8px;font-size:16px;text-align:center;outline:none"><div class="password-hint" style="text-align:center;font-size:12px;color:#666;height:20px;margin-top:10px"></div></div><div style="display:flex;gap:10px;width:250px"><button onclick="submitPassword()" style="flex:1;padding:12px;border:1px solid #000;background:#000;color:#fff;border-radius:8px;cursor:pointer;font-size:14px">解锁</button><button onclick="cancelPassword()" style="flex:1;padding:12px;border:1px solid #000;background:#fff;border-radius:8px;cursor:pointer;font-size:14px">取消</button></div></div></div></div>
  
<script>    
// ==========================================
// 基础配置与数据定义
// ==========================================    
//水电费价格配置
const utilityPrices={"豪宅、庄园、城堡":{water:800,electricity:1200},"别墅、独栋":{water:500,electricity:800},"高档公寓、大平层":{water:300,electricity:500},"普通公寓、居民楼、小区":{water:150,electricity:300},"经济适用房、小户型":{water:100,electricity:200},"宿舍、合租房":{water:80,electricity:150},"老破小、旧房":{water:50,electricity:100},"农村自建房、乡村":{water:30,electricity:80}};

// API 配置与模型列表
const API_ENDPOINTS = {openai: 'https://api.openai.com/v1',anthropic: 'https://api.anthropic.com/v1',google: 'https://generativelanguage.googleapis.com/v1'};const MODEL_LISTS = {openai: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-3.5-turbo-16k'],anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'],google: ['gemini-pro', 'gemini-pro-vision']};

// 外卖系统基础数据
const chineseSurnames = ["王", "李", "张", "刘", "陈", "杨", "赵", "黄", "周", "吴", "徐", "孙", "胡", "朱", "高", "林", "何", "郭", "马", "罗", "梁", "宋", "郑", "谢", "韩", "唐", "冯", "于", "董", "萧", "程", "曹", "袁", "邓", "许", "傅", "沈", "曾", "彭", "吕"];const foodData = [{ id: 1, name: "招牌黑椒牛肉汉堡", description: "厚实的澳洲牛肉饼搭配浓郁黑椒酱汁，金黄酥脆的面包裹着新鲜蔬菜，层次丰富，肉质鲜嫩多汁。", features: ["厚实牛肉饼", "黑椒酱汁", "金黄面包", "新鲜蔬菜"], price: 38.8, icon: "fas fa-hamburger", category: "汉堡", isFavorite: false },{ id: 2, name: "经典玛格丽特披萨", description: "薄脆饼底上铺满香浓马苏里拉奶酪和新鲜番茄酱，撒上罗勒叶，烤制后奶酪拉丝，香气四溢。", features: ["薄脆饼底", "马苏里拉奶酪", "番茄酱", "罗勒叶"], price: 68.5, icon: "fas fa-pizza-slice", category: "披萨", isFavorite: false },{ id: 3, name: "川味麻辣香锅", description: "多种新鲜食材搭配秘制麻辣香料炒制，色泽红亮，香气扑鼻，麻辣鲜香，回味无穷。", features: ["秘制香料", "多种食材", "麻辣鲜香", "色泽红亮"], price: 45.9, icon: "fas fa-bowl-food", category: "中餐", isFavorite: false },{ id: 4, name: "手冲精品咖啡", description: "精选阿拉比卡咖啡豆，手工现磨现冲，口感醇厚顺滑，带有坚果和巧克力的香气。", features: ["阿拉比卡豆", "手工现冲", "醇厚顺滑", "坚果香气"], price: 28.8, icon: "fas fa-mug-hot", category: "饮品", isFavorite: false },{ id: 5, name: "抹茶千层蛋糕", description: "层层叠叠的抹茶薄饼与淡奶油交替叠加，外形整齐美观，口感细腻，抹茶香气浓郁。", features: ["抹茶薄饼", "淡奶油", "层次分明", "香气浓郁"], price: 32.9, icon: "fas fa-ice-cream", category: "甜点", isFavorite: false },{ id: 6, name: "香酥炸鸡桶", description: "外皮金黄酥脆，内里鸡肉鲜嫩多汁，搭配特制香料，香气扑鼻，口感层次丰富。", features: ["金黄酥脆", "鲜嫩多汁", "特制香料", "香气扑鼻"], price: 55.5, icon: "fas fa-drumstick-bite", category: "炸鸡", isFavorite: false },{ id: 7, name: "法式可颂面包", description: "外形呈现完美层次，外皮金黄酥脆，内里柔软有弹性，黄油香气浓郁。", features: ["完美层次", "金黄酥脆", "柔软弹性", "黄油香气"], price: 18.8, icon: "fas fa-bread-slice", category: "面包", isFavorite: false },{ id: 8, name: "台式珍珠奶茶", description: "茶香浓郁，奶味醇厚，珍珠Q弹有嚼劲，甜度适中，口感丰富顺滑。", features: ["茶香浓郁", "奶味醇厚", "珍珠Q弹", "口感顺滑"], price: 22.5, icon: "fas fa-wine-bottle", category: "饮品", isFavorite: false }];

// ==========================================
// 核心管理
// ==========================================
// 世界书管理器：处理设定集记录的增删改查
class WorldbookManager{constructor(){this.records=JSON.parse(localStorage.getItem('worldbook')||'[]');this.currentEditingId=null;}addRecord(title,content){if(!title||title.trim()===''||!content||content.trim()==='')return null;const record={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),title:title,content:content,active:true,timestamp:new Date().toISOString()};this.records.push(record);this.saveRecords();return record;}updateRecord(id,title,content){const record=this.records.find(r=>r.id===id);if(record){record.title=title||record.title;record.content=content||record.content;record.timestamp=new Date().toISOString();this.saveRecords();return true;}return false;}deleteRecord(id){const index=this.records.findIndex(r=>r.id===id);if(index!==-1){this.records.splice(index,1);this.saveRecords();return true;}return false;}toggleRecord(id){const record=this.records.find(r=>r.id===id);if(record){record.active=!record.active;this.saveRecords();return record.active;}return false;}getActiveRecords(){return this.records.filter(r=>r.active);}getAllRecords(){return[...this.records];}getRecordById(id){return this.records.find(r=>r.id===id);}saveRecords(){try{localStorage.setItem('worldbook',JSON.stringify(this.records));}catch(e){console.log('存储失败');}}}

// 多人设管理器：处理多聊模式的角色
class MultiPersonaManager{constructor(){this.personas=JSON.parse(localStorage.getItem('multiPersonas')||'[]');this.currentPersonaId=JSON.parse(localStorage.getItem('currentMultiPersonaId')||'null');}addPersona(name,description){if(!name||name.trim()==='')return null;const persona={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),name:name,description:description||'',timestamp:new Date().toISOString()};this.personas.push(persona);this.savePersonas();return persona;}updatePersona(id,name,description){const persona=this.personas.find(p=>p.id===id);if(persona){persona.name=name||persona.name;persona.description=description||persona.description;persona.timestamp=new Date().toISOString();this.savePersonas();return true;}return false;}deletePersona(id){const index=this.personas.findIndex(p=>p.id===id);if(index!==-1){this.personas.splice(index,1);this.savePersonas();if(this.currentPersonaId===id){this.currentPersonaId=this.personas.length>0?this.personas[0].id:null;this.saveCurrentPersonaId();}return true;}return false;}getPersonaById(id){return this.personas.find(p=>p.id===id);}getCurrentPersona(){if(!this.currentPersonaId&&this.personas.length>0){this.currentPersonaId=this.personas[0].id;this.saveCurrentPersonaId();}return this.personas.find(p=>p.id===this.currentPersonaId);}setCurrentPersona(id){this.currentPersonaId=id;this.saveCurrentPersonaId();}getAllPersonas(){return[...this.personas];}getPersonaCount(){return this.personas.length;}savePersonas(){try{localStorage.setItem('multiPersonas',JSON.stringify(this.personas));}catch(e){console.log('存储失败');}}saveCurrentPersonaId(){try{localStorage.setItem('currentMultiPersonaId',JSON.stringify(this.currentPersonaId));}catch(e){console.log('存储失败');}}}

// 聊天管理器：处理消息队列、存储和事件监听
class ChatManager{constructor(){this.messages=JSON.parse(localStorage.getItem("chatMessages")||'[]');this.currentEditingId=null;this.listeners=[];this.messages=this.createObservableArray(this.messages);}createObservableArray(e){const t=this;return new Proxy(e,{set(e,s,a){const n=Reflect.set(e,s,a);t.notifyListeners("messagesChanged",e);t.saveMessages();return n;},get(e,s){const a=Reflect.get(e,s);return"function"==typeof a?function(...n){const i=a.apply(e,n);return["push","pop","shift","unshift","splice"].includes(s)&&(t.notifyListeners("messagesChanged",e),t.saveMessages()),i}:a;}})}addListener(e,t){this.listeners.push({event:e,callback:t});}notifyListeners(e,t){this.listeners.forEach(s=>{s.event===e&&s.callback(t);});}saveMessages(){try{localStorage.setItem("chatMessages",JSON.stringify(this.messages));}catch(e){console.log('存储失败');}}addMessage(e,t,s="",a=null,n="text"){if(!s){if("user"===e){const i=JSON.parse(localStorage.getItem("userPersona")||"{}");s=i.name||"您";}else if("single"===appState.chatType){const r=JSON.parse(localStorage.getItem("aiPersona")||"{}");s=r.name||"助手";}else{const o=appState.multiPersonaManager.getCurrentPersona();s=o?o.name:"助手";}}if(!t||t.trim()==='')return null;const i={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),sender:e,senderName:s,content:t,personaId:a,type:n,timestamp:(new Date).toISOString()};return this.messages.push(i),i;}updateMessage(e,t){const s=this.messages.find(t=>t.id===e);if(!s||!t||t.trim()==='')return false;s.content=t;s.timestamp=(new Date).toISOString();this.saveMessages();this.notifyListeners("messageUpdated",s);return true;}deleteMessage(e){const t=this.messages.findIndex(t=>t.id===e);if(-1!==t){const s=this.messages[t];this.messages.splice(t,1);this.saveMessages();this.notifyListeners("messageDeleted",s);return true;}return false;}deleteMessages(e){const t=e.length;if(t===0)return 0;e.sort((e,t)=>t-e).forEach(e=>{const t=this.messages.findIndex(t=>t.id===e);-1!==t&&this.messages.splice(t,1);});this.saveMessages();this.notifyListeners("messagesChanged",this.messages);return t;}clearAllMessages(){const e=this.messages.length;this.messages.length=0;this.saveMessages();this.notifyListeners("messagesChanged",this.messages);return e;}getMessages(){return[...this.messages];}getMessageCount(){return this.messages.length;}}

// API 服务：处理与 AI 接口的通信
class ApiService{constructor(){this.config=JSON.parse(localStorage.getItem("apiConfig")||'{"provider":"openai","apiKey":"","apiUrl":"https://api.openai.com/v1","model":"gpt-3.5-turbo","replyCount":1}');}async getModels(){try{const e=await fetch(`${this.config.apiUrl}/models`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"}});if(!e.ok){const t=await e.json();throw new Error(t.error?t.error.message:`API请求失败:${e.status}`);}const t=await e.json();return t.data.map(e=>e.id);}catch(e){console.error("获取模型列表失败:",e);throw e;}}async chatWithRole(e,t,s=.7,a=1,n="online",i="single",r=""){if(!this.config.apiKey)throw new Error("API密钥未配置");if(!t||t.trim()==='')throw new Error("消息内容不能为空");const o=JSON.parse(localStorage.getItem("aiPersona")||"{}"),c=JSON.parse(localStorage.getItem("userPersona")||"{}"),l=appState.worldbookManager.getActiveRecords();let d="";if("multi"===i){d=`你现在的身份是：${r}。\n\n你的详细人设如下：\n${e}\n\n【场景说明】\n这是一个多人聊天群组（Group Chat）。\n请时刻保持你的角色设定，不要跳出戏，不要说自己是AI或语言模型。\n你需要根据群里的对话内容，以${r}的口吻进行回复。`;if(c.name||c.description){d+="\n\n和你对话的用户设定：";c.name&&(d+=`\n- 姓名：${c.name}`);c.description&&(d+=`\n- 描述：${c.description}`);}}else{d=e;if(o.name||o.description){d+="\n\n角色信息：";o.name&&(d+=`\n- 姓名：${o.name}`);o.description&&(d+=`\n- 描述：${o.description}`);}if(c.name||c.description){d+="\n\n用户信息：";c.name&&(d+=`\n- 姓名：${c.name}`);c.description&&(d+=`\n- 描述：${c.description}`);d+=`\n\n[系统指令]：请严格根据"用户信息"中的描述确认用户的性别。如果描述中提到是女性，请使用"她"或女性称呼；如果是男性，使用"他"。`;}}l.length>0&&(d+="\n\n世界书记录：",l.forEach((e,t)=>{d+=`\n${t+1}. ${e.content}`;}));"online"===n?d+="\n\n重要：请使用线上模式（短信模式）回复：\n1. 回复要简短精炼，像日常短信对话\n2. 使用日常说话语气，自然亲切\n3. 避免使用复杂的修饰词和文学性描述\n4. 尽量使用短句，表达直接\n5. 回复长度控制在100字以内":d+="\n\n重要：请使用线下模式（剧情模式）回复：\n1. 回复要详细、有画面感，像小说剧情\n2. 使用唯美、文学性的语言，可以大量使用修饰词\n3. 注重情感表达和氛围营造\n4. 可以展开想象，创造生动的场景和细节\n5. 回复可以较长，200-500字为宜\n6. 保持角色的一致性，让对话有剧情推进感";a>1&&(d+=`\n\n重要：请连续回复${a}条消息，这些回复应该是自然的、连贯的对话。\n示例：\n用户说："你好"\n你应该回复：\n你好！今天过得怎么样？\n|||\n我是AI助手，有什么可以帮你的吗？\n|||\n看起来你今天心情不错呢！\n注意：\n1. 每条回复都应该是对话的自然延续\n2. 不要添加任何序号前缀（如"第二条消息："、"回复2："等）\n3. 不要添加任何说明性文字\n4. 每条回复之间用"|||"分隔\n5. 保持语气和角色的一致性，让对话有剧情推进感`);const h=appState.chatManager.getMessages().filter(e=>"正在思考..."!==e.content&&e.content!==t).slice(-15),u=[{role:"system",content:d}];h.forEach(e=>{let t=e.senderName;t||(t="user"===e.sender?c.name||"用户":"群友");const s=`[${t}]: ${e.content}`;u.push("user"===e.sender?{role:"user",content:s}:{role:"assistant",content:s});});const p=c.name||"我";u.push({role:"user",content:`[${p}]: ${t}`});try{const e=await fetch(`${this.config.apiUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model,messages:u,temperature:s,max_tokens:parseInt(document.getElementById("max-tokens")?document.getElementById("max-tokens").value:1000)||1000})});if(!e.ok){const t=await e.json();throw new Error(`API请求失败:${t.error?t.error.message:e.status}`);}const n=await e.json();let i=n.choices[0].message.content;const o=new RegExp(`^\\[?${r}\\]?[:：]\\s*`,"i");i=i.replace(o,"");let l=[];if(a>1){l=i.split(/\|\|\|/).map(e=>e.trim()).filter(e=>e.length>0);l=l.map(e=>e.replace(/^(第[一二三四五六七八九十\d]+条(消息|回复)[:：]\s*)/,"").replace(/^((回复|消息)[一二三四五六七八九十\d]+[:：]\s*)/,"").replace(/^((回复|消息)[\d]+[:：]\s*)/,"").replace(/^[\d]+[\.、:：]\s*/,"").trim()).filter(e=>e.length>0);if(l.length<=1&&i.includes("\n")){const e=i.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("回复")&&!e.startsWith("第")&&!e.match(/^\d+[\.:：]/)&&!e.includes("|||"));e.length>1&&(l=e);}l=l.length<=1?[i]:l.slice(0,a);}else l=[i];return l;}catch(e){console.error("API调用失败:",e);throw e;}}async generateRawContent(e,t,s=.8){if(!this.config.apiKey)throw new Error("API密钥未配置");if(!t||t.trim()==='')throw new Error("生成内容不能为空");const a=[{role:"system",content:e},{role:"user",content:t}];try{const e=await fetch(`${this.config.apiUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model,messages:a,temperature:s,max_tokens:500})});if(!e.ok)throw new Error(`API请求失败:${e.status}`);const t=await e.json();return t.choices[0].message.content;}catch(e){console.error("API generateRawContent 调用失败:",e);throw e;}}async testConnection(){try{const e=await this.getModels();return{success:true,models:e};}catch(e){return{success:false,error:e.message};}}updateConfig(e){this.config={...this.config,...e};try{localStorage.setItem("apiConfig",JSON.stringify(this.config));}catch(e){console.log('存储失败');}}getCurrentConfig(){return{...this.config};}}

// ==========================================
// 功能管理
// ==========================================    
// 音乐播放器管理器
const musicPlayer = {audio: new Audio(), playlist: [], currentIndex: -1, isPlaying: false, loopMode: 'list',init: function() {this.bindEvents();this.audio.addEventListener('loadedmetadata', () => { this.updateTotalTime(); });this.audio.addEventListener('timeupdate', () => { this.updateProgress(); });this.audio.addEventListener('ended', () => { if (this.loopMode === 'single') { this.audio.currentTime = 0; this.audio.play(); } else { this.next(); } });this.updateMusicStatusIndicator(); this.setLoopMode('list');},bindEvents: function() {document.getElementById('play-pause-btn').addEventListener('click', () => { this.togglePlay(); });document.getElementById('prev-btn').addEventListener('click', () => { this.prev(); });document.getElementById('next-btn').addEventListener('click', () => { this.next(); });document.getElementById('progress-bar').addEventListener('click', (e) => { this.seek(e); });document.getElementById('import-btn').addEventListener('click', () => { document.getElementById('file-input').click(); });document.getElementById('single-loop-btn').addEventListener('click', () => { this.setLoopMode('single'); });document.getElementById('list-loop-btn').addEventListener('click', () => { this.setLoopMode('list'); });document.getElementById('file-input').addEventListener('change', (e) => { this.handleFileSelect(e); });},handleFileSelect: function(e) {const files = e.target.files; if (files.length === 0) return;for (let i = 0; i < files.length; i++) { const file = files[i]; if (file.type.startsWith('audio/')) { const url = URL.createObjectURL(file); this.addToPlaylist(file.name, url, file); } }if (this.currentIndex === -1 && this.playlist.length > 0) { this.play(0); } e.target.value = '';},addToPlaylist: function(name, url, file) {const playlist = document.getElementById('playlist'); if (playlist.querySelector('.empty')) { playlist.innerHTML = ''; }const item = document.createElement('div'); item.className = 'playlist-item'; item.dataset.url = url;const tempAudio = new Audio(url);tempAudio.addEventListener('loadedmetadata', () => { const duration = this.formatTime(tempAudio.duration); item.innerHTML = `<div class="song-title">${name}</div><div class="song-duration">${duration}</div>`; item.dataset.duration = tempAudio.duration; });item.addEventListener('click', () => { const index = Array.from(playlist.children).indexOf(item); this.play(index); });playlist.appendChild(item); this.playlist.push({ name: name, url: url, file: file });},play: function(index) {if (index < 0 || index >= this.playlist.length) return;this.currentIndex = index; const song = this.playlist[index]; this.audio.src = song.url;document.getElementById('song-title').textContent = song.name; document.getElementById('song-artist').textContent = '本地音乐';const playlistItems = document.querySelectorAll('.playlist-item'); playlistItems.forEach(item => item.classList.remove('active')); playlistItems[index].classList.add('active');this.audio.play(); this.isPlaying = true; this.updatePlayState();},togglePlay: function() { if (this.currentIndex === -1) { if (this.playlist.length > 0) { this.play(0); } return; } if (this.isPlaying) { this.audio.pause(); } else { this.audio.play(); } this.isPlaying = !this.isPlaying; this.updatePlayState(); },updatePlayState: function() { const disc = document.getElementById('disc'); const playPauseIcon = document.getElementById('play-pause-btn'); if (this.isPlaying) { disc.classList.add('playing'); playPauseIcon.textContent = '❚❚'; } else { disc.classList.remove('playing'); playPauseIcon.textContent = '▶'; } this.updateMusicStatusIndicator(); },updateMusicStatusIndicator: function() { const musicStatus = document.getElementById('music-status'); if (this.isPlaying) { musicStatus.className = 'status-indicator status-online'; musicStatus.title = '正在播放'; } else { musicStatus.className = 'status-indicator status-offline'; musicStatus.title = '未播放'; } },prev: function() { if (this.playlist.length === 0) return; let newIndex = this.currentIndex - 1; if (newIndex < 0) { newIndex = this.playlist.length - 1; } this.play(newIndex); },next: function() { if (this.playlist.length === 0) return; let newIndex = this.currentIndex + 1; if (newIndex >= this.playlist.length) { newIndex = 0; } this.play(newIndex); },seek: function(e) { if (this.currentIndex === -1) return; const progressBar = document.getElementById('progress-bar'); const rect = progressBar.getBoundingClientRect(); const percent = (e.clientX - rect.left) / rect.width; this.audio.currentTime = percent * this.audio.duration; },updateProgress: function() { const progress = document.getElementById('progress'); const currentTime = document.getElementById('current-time'); if (this.audio.duration) { const percent = (this.audio.currentTime / this.audio.duration) * 100; progress.style.width = `${percent}%`; currentTime.textContent = this.formatTime(this.audio.currentTime); } },updateTotalTime: function() { const duration = document.getElementById('duration'); duration.textContent = this.formatTime(this.audio.duration); },formatTime: function(seconds) { if (isNaN(seconds)) return '0:00'; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${mins}:${secs < 10 ? '0' : ''}${secs}`; },setLoopMode: function(mode) { const singleBtn = document.getElementById('single-loop-btn'); const listBtn = document.getElementById('list-loop-btn'); singleBtn.classList.remove('active'); listBtn.classList.remove('active'); this.loopMode = mode; if (mode === 'single') { singleBtn.classList.add('active'); } else { listBtn.classList.add('active'); } }};

// 钱包与账单管理器
const walletManager = {loadWalletData: function() { const e = localStorage.getItem('walletData'); return e ? JSON.parse(e) : { totalBalance: 0, todayExpense: 0, monthIncome: 0, lastUtilityPayMonth: null, transactions: [] }; },saveWalletData: function() { localStorage.setItem('walletData', JSON.stringify(this.walletData)); },walletData: null,loadHouseType: function() { return localStorage.getItem('userHouseType') || "老破小、旧房"; },saveHouseType: function(e) { localStorage.setItem('userHouseType', e); },initWallet: function() { this.walletData = this.loadWalletData(); document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2); document.getElementById('monthIncome').textContent = this.walletData.monthIncome.toFixed(2); this.renderTransactions(); },renderTransactions: function() {const e = document.getElementById('transaction-list');if (0 === this.walletData.transactions.length) { e.innerHTML = '<div class="empty-state"><p>暂无交易记录</p><p style="font-size: 0.8em; margin-top: 10px; color: #999;">所有消费和收入将在这里显示</p></div>'; return; }const t = [...this.walletData.transactions].sort((e, t) => new Date(t.date) - new Date(e.date));e.innerHTML = '';t.forEach(t => { const a = document.createElement('div'); a.className = 'transaction-item'; const n = 'expense' === t.type ? 'transaction-expense' : 'transaction-income'; const i = 'expense' === t.type ? '-' : '+'; a.innerHTML = `<div class="transaction-info"><div class="transaction-title">${t.description}</div><div class="transaction-date">${this.formatDate(t.date)}</div></div><div class="transaction-amount ${n}">${i}¥${t.amount.toFixed(2)}</div>`; e.appendChild(a); });},formatDate: function(e) { const t = new Date(e); return `${t.getFullYear()}-${(t.getMonth() + 1).toString().padStart(2, '0')}-${t.getDate().toString().padStart(2, '0')}`; },addTransaction: function(e, t, a) { const n = { id: Date.now() + Math.random().toString(36).substr(2, 9), type: e, amount: t, description: a, date: (new Date).toISOString() }; this.walletData.transactions.push(n); this.saveWalletData(); this.renderTransactions(); },setupEventListeners: function() {document.getElementById('rechargeBtn').addEventListener('click', function() { document.getElementById('rechargeModal').style.display = 'flex'; document.getElementById('rechargeAmount').focus(); });document.getElementById('closeModal').addEventListener('click', function() { document.getElementById('rechargeModal').style.display = 'none'; document.getElementById('rechargeAmount').value = ''; });document.getElementById('confirmRecharge').addEventListener('click', function() { const e = document.getElementById('rechargeAmount'), t = parseFloat(e.value); isNaN(t) || t <= 0 ? (alert('请输入有效的充值金额！'), e.focus()) : walletManager.recharge(t); });document.getElementById('rechargeModal').addEventListener('click', function(e) { e.target === this && (this.style.display = 'none', document.getElementById('rechargeAmount').value = '') });document.getElementById('rechargeAmount').addEventListener('keypress', function(e) { 'Enter' === e.key && document.getElementById('confirmRecharge').click() });document.getElementById('utilityBtn').addEventListener('click', function() { walletManager.openUtilityModal() });document.getElementById('closeUtilityModal').addEventListener('click', function() { document.getElementById('utilityModal').style.display = 'none' });document.getElementById('confirmUtility').addEventListener('click', function() { walletManager.payUtility() });document.getElementById('utilityModal').addEventListener('click', function(e) { e.target === this && (this.style.display = 'none') });document.getElementById('houseTypeSelect').addEventListener('change', function() { walletManager.updateUtilityPrices() });},recharge: function(e) { this.walletData.totalBalance += e; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); this.saveWalletData(); document.getElementById('rechargeModal').style.display = 'none'; document.getElementById('rechargeAmount').value = ''; alert(`成功充值 ${e.toFixed(2)} 元！`) },openUtilityModal: function() { const e = this.loadHouseType(); document.getElementById('houseTypeSelect').value = e; this.updateUtilityPrices(); document.getElementById('utilityModal').style.display = 'flex'; },updateUtilityPrices: function() { const e = document.getElementById('houseTypeSelect').value, t = utilityPrices[e] || utilityPrices["老破小、旧房"]; document.getElementById('utility-house-type').textContent = e; document.getElementById('utility-water').textContent = `${t.water.toFixed(2)} 元`; document.getElementById('utility-electricity').textContent = `${t.electricity.toFixed(2)} 元`; document.getElementById('utility-total').textContent = `${(t.water + t.electricity).toFixed(2)} 元`; },hasPaidUtilityThisMonth: function() { if (!this.walletData.lastUtilityPayMonth) return !1; const e = (new Date).getMonth(), t = (new Date).getFullYear(), a = new Date(this.walletData.lastUtilityPayMonth).getMonth(), n = new Date(this.walletData.lastUtilityPayMonth).getFullYear(); return e === a && t === n; },payUtility: function() {if (this.hasPaidUtilityThisMonth()) return void(alert('本月水电费已经缴纳过了，下个月再来吧！'), document.getElementById('utilityModal').style.display = 'none');const e = document.getElementById('houseTypeSelect').value, t = utilityPrices[e] || utilityPrices["老破小、旧房"], a = t.water + t.electricity;if (this.walletData.totalBalance < a) return void alert('余额不足，无法缴纳水电费！');this.walletData.totalBalance -= a; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); this.walletData.todayExpense += a; document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2); this.walletData.lastUtilityPayMonth = (new Date).toISOString();this.addTransaction('expense', a, `${e}水电费`); this.saveHouseType(e); this.saveWalletData(); document.getElementById('utilityModal').style.display = 'none'; alert(`成功缴纳水电费 ${a.toFixed(2)} 元！`);},payFoodDelivery: function(e, t) {if (this.walletData.totalBalance < e) return { success: !1, message: '余额不足，无法完成支付！' };this.walletData.totalBalance -= e; this.walletData.todayExpense += e; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2);this.addTransaction('expense', e, t); this.saveWalletData();return { success: !0, message: `支付成功！扣除 ¥${e.toFixed(2)}` };}};

// 微博仿真系统管理器
const weiboManager = {categories: JSON.parse(localStorage.getItem("weiboCategories")) || [], weibos: JSON.parse(localStorage.getItem("weibos")) || [], userProfile: JSON.parse(localStorage.getItem("weiboUserProfile")) || { name: "微博用户", bio: "这个人很懒，什么都没有写...", persona: "普通用户", location: "", followers: 0, following: 0 },neutralNPCs: Array(26).fill().map((e, t) => ({ name: "网友" + String.fromCharCode(65 + t), description: "中性化角色，根据题材发动态" })), fanNPCs: Array(26).fill().map((e, t) => ({ name: "网友" + String.fromCharCode(65 + t), description: "吃瓜角色，围绕用户和角色发动态" })),trendingTopics: [{ name: "#AI技术分享#", posts: "12.3万", trend: "上升" }, { name: "#日常生活#", posts: "8.7万", trend: "热门" }, { name: "#数码新品#", posts: "15.6万", trend: "新" }, { name: "#旅行日记#", posts: "23.1万", trend: "上升" }, { name: "#美食探索#", posts: "18.9万", trend: "热门" }, { name: "#财经新闻#", posts: "31.2万", trend: "爆款" }, { name: "#体育赛事#", posts: "5.4万", trend: "新" }, { name: "#娱乐八卦#", posts: "7.8万", trend: "上升" }, { name: "#恐怖故事#", posts: "9.2万", trend: "新" }],hotSearchList: [], quotes: ["如果世界真的不喜欢你 那世界就是我的敌人", "童年的梦境锈迹斑斑 所罗门式的痛苦曾钻透月亮", "生命生来就如璀璨的夏日之花 不凋不败", "和蒲公英密谋一场叛逃 目的地为乌托邦银河渡口", "吾与吾爱皆亡于高塔 君与君心皆留于盛夏", "我永恒的灵魂注视着你的心 纵然黑夜孤寂 白昼如焚", "我观春山意难容 青也惊鸿 颓也从容", "爱诞生于每一次垂眸相视的瞬间里"],dynamicConfig: { userWeiboFrequency: 0, maxUserWeibosPerRefresh: 0 },identityKeywords: { entertainment: ["明星", "演员", "歌手", "偶像", "艺人", "巨星", "歌星", "影星", "娱乐圈", "演艺圈", "娱乐"], detective: ["法医", "警察", "侦探", "刑侦", "案件", "尸体", "刑警", "警探", "犯罪", "侦查"], tech: ["程序员", "工程师", "科学家", "研究员", "技术", "开发", "编程", "码农", "IT"], medical: ["医生", "护士", "医疗", "医学", "医院", "诊所", "医师", "治疗"], education: ["老师", "教师", "教授", "教育", "学校", "学生", "教学"] },categoryIdentityMap: { 娱乐: "entertainment", 科技: "tech", 数码: "tech", 恐怖: "detective", 刑侦: "detective", 案件: "detective", 医疗: "medical", 教育: "education" },dynamicContent: {topicStyles: { 恐怖: "语气必须令人感到绝望、恐惧、阴森、不安、毛骨悚然。侧重于心理恐怖或未知的恐惧。绝对不要搞笑。", 灵异: "语气必须令人感到绝望、恐惧、阴森、不安、毛骨悚然。侧重于心理恐怖或未知的恐惧。绝对不要搞笑。", 生活: "语气必须温馨、治愈、积极向上、充满生活气息、轻松愉快。", 日常: "语气必须温馨、治愈、积极向上、充满生活气息、轻松愉快。", 科技: "语气必须专业、理性、对未来科技充满向往、强调先进性、硬核。", 数码: "语气必须专业、理性、对未来科技充满向往、强调先进性、硬核。", 娱乐: "语气八卦、兴奋、或者犀利点评，充满娱乐精神，可以使用饭圈用语。", 明星: "语气八卦、兴奋、或者犀利点评，充满娱乐精神，可以使用饭圈用语。", 体育: "语气热血、充满激情、强调拼搏精神和竞技状态。", 运动: "语气热血、充满激情、强调拼搏精神和竞技状态。", 财经: "语气严谨、客观、分析透彻、关注利益和风险。", 金融: "语气严谨、客观、分析透彻、关注利益和风险。", default: "语气符合该话题的常规社交媒体风格。" },emojis: ["😊", "😂", "❤️", "👍", "🔥", "⭐", "🙏", "🎉", "💡", "👏", "🎮", "📚", "✈️", "🍕", "☕", "😭", "🥰"], horrorEmojis: ["😨", "👻", "💀", "🕯️", "🌑", "🕷️", "🦇", "⚰️", "🩸", "👁️", "🧟", "🧛"],generateNPCWeibo: async function(e = null) {const t = JSON.parse(localStorage.getItem("aiPersona") || "{}"), a = JSON.parse(localStorage.getItem("userPersona") || "{}"), n = t.name || "某人", i = a.name || "某人", o = this.extractIdentity(t.description || ""), r = this.extractIdentity(a.description || ""), s = weiboManager.categoryIdentityMap[e] || null, c = !s || !o || this.isIdentityMatch(o, s), l = !s || !r || this.isIdentityMatch(r, s), d = Math.random(); let u, p, m = !1, h = !1, g = "", f = "";if (d < .2 && c && t.name && t.description) m = !0, u = t.name, p = t.description, g = `以${u}的身份发布关于"${e || this.getRandomTopic()}"的微博。`, f = `角色设定：${p}`;else if (d < .6 || !c && !l) { const e = weiboManager.neutralNPCs[Math.floor(Math.random() * weiboManager.neutralNPCs.length)]; u = e.name, p = e.description, g = `以${u}的身份发布关于"${e || this.getRandomTopic()}"的微博。`, f = `角色设定：${p}` }else {h = !0; const n = weiboManager.fanNPCs[Math.floor(Math.random() * weiboManager.fanNPCs.length)]; u = n.name, p = n.description; const o = Math.random(), r = e || this.getRandomTopic();o < .4 && l && a.name ? (g = `以${u}的身份，作为路人或粉丝，发布一条关于用户"${i}"的微博，讨论"${r}"。`, f = `角色设定：${p}\n【重要参考】用户(${i})的人设资料：${a.description || "普通用户"}`) : o < .8 && c && t.name ? (g = `以${u}的身份，作为路人或粉丝，发布一条关于角色"${n}"的微博，讨论"${r}"。`, f = `角色设定：${p}\n【重要参考】角色(${n})的人设资料：${t.description || "虚拟角色"}`) : c && l && t.name && a.name ? (g = `以${u}的身份，作为吃瓜群众，发布一条同时提到"${n}"和"${i}"的微博，讨论"${r}"或他们的关系。`, f = `角色设定：${p}\n【重要参考】用户(${i})资料：${a.description}\n【重要参考】角色(${n})资料：${t.description}`) : (h = !1, g = `以${u}的身份发布关于"${r}"的微博。`, f = `角色设定：${p}`)}const y = this.getTopicStyle(e || "日常"), v = `任务：${g}\n${f}\n情感基调/风格要求：${y}\n其他要求：\n1. 字数控制在140字以内。\n2. 直接输出内容，不要包含解释。\n3. ⚠️必须严格根据【重要参考】中的资料区分用户和角色的性别，不要弄错"他"和"她"。`;try { const e = await appState.apiService.generateRawContent(`你是一个模拟微博用户的AI。`, v, .8); return { content: this.cleanContent(e), username: u, userBio: p, isChatCharacter: m, isFanRole: h } } catch (t) { return console.error("生成NPC微博内容失败:", t), { content: this.generateFallbackContent(e || "生活"), username: u, userBio: p, isChatCharacter: m, isFanRole: h } }},getRandomTopic: function() { const e = ["日常生活", "科技动态", "美食分享", "旅行见闻", "心情随笔", "影视推荐", "音乐分享", "读书感悟", "健康养生", "运动健身", "时尚穿搭", "美妆技巧", "宠物日常", "亲子教育", "职场心得", "学习成长", "摄影作品", "游戏体验", "动漫讨论", "时事热点"]; return e[Math.floor(Math.random() * e.length)] },getTopicStyle: function(e) { if (!e) return this.topicStyles.default; const t = e.toLowerCase(); for (const [e, a] of Object.entries(this.topicStyles)) if (t.includes(e.toLowerCase())) return a; return this.topicStyles.default },extractIdentity: function(e) { const t = e.toLowerCase(); for (const [e, a] of Object.entries(weiboManager.identityKeywords)) for (const n of a) if (t.includes(n.toLowerCase())) return e; return null },isIdentityMatch: function(e, t) { if (e === t) return !0; const a = { detective: ["horror"], entertainment: ["life"], tech: ["finance"] }; return !(!a[e] || !a[e].includes(t)) },generateFallbackContent: function(e) { const t = [`今天遇到了关于${e}的有趣事情，感觉挺有意思的 🎉`, `分享一下我对${e}的看法，大家觉得呢？${this.getRandomEmojis()}`, `刚刚体验了${e}，感觉还不错！推荐给大家 👍`, `关于${e}，我有一个小技巧要分享 💡`, `被${e}惊艳到了！强烈安利 ${this.getRandomEmojis()}`]; return t[Math.floor(Math.random() * t.length)] },cleanContent: function(e) { return e.replace(/^["']|["']$/g, "").replace(/^(这是一条|我生成|我写|我创作|我发布|这是一张|这是一段|这是一个)/g, "").replace(/^(关于|今天|刚刚|最近)/g, "").trim() },getRandomEmojis: function() { const e = Math.floor(2 * Math.random()) + 1; let t = ""; for (let a = 0; a < e; a++) t += this.emojis[Math.floor(Math.random() * this.emojis.length)]; return t },generateTimestamp: function(e = 0) { if (e > 0) return `${e}天前`; const t = Math.floor(24 * Math.random()), a = Math.floor(60 * Math.random()); return t > 0 ? `${t}小时前` : a > 0 ? `${a}分钟前` : "刚刚" }},getRandomNPCPersona: function() { const e = Math.random() < .5, t = e ? this.fanNPCs : this.neutralNPCs; return t[Math.floor(Math.random() * t.length)] },generateDiverseComments: async function(e, t) {const a = `请为以下微博内容生成6条多样化的评论，包含不同的立场和语气：\n\n微博内容："${e}"\n\n要求：\n1. 生成6条评论，每条评论20-40字\n2. 包含以下四种立场（比例大致平均）：\n   - 支持（支持、欣赏的语气）\n   - 批评（批评、质疑的语气）\n   - 粉丝（狂热支持、维护的语气）\n   - 黑粉（恶意攻击、嘲讽的语气）\n3. 评论之间要有互动感，可以体现"粉黑开撕"的氛围\n4. 评论者使用"网友A"到"网友Z"之间的随机名字\n5. 每条评论单独一行，格式必须为："[立场] 用户名: 评论内容"\n6. 立场只能从以下四个中选择：[支持]、[批评]、[粉丝]、[黑粉]\n7. 评论要真实自然，符合微博评论风格\n\n请直接输出评论，不要添加任何解释：`;try {const n = await appState.apiService.generateRawContent("你是一个微博评论生成器，擅长生成真实、多样化的社交媒体评论。", a, .8), i = n.split("\n").map(e => { const t = e.match(/^\[(支持|批评|粉丝|黑粉)\]\s*([^:]+):\s*(.+)$/); return t ? { stanceRaw: t[1], user: t[2].trim(), comment: t[3].trim() } : null }).filter(e => null !== e).slice(0, 6), o = i.map((e, a) => { let n = "neutral"; "支持" === e.stanceRaw ? n = "supportive" : "批评" === e.stanceRaw ? n = "critical" : "粉丝" === e.stanceRaw ? n = "fan" : "黑粉" === e.stanceRaw && (n = "anti"); const i = ["刚刚", "1分钟前", "5分钟前", "10分钟前", "半小时前", "1小时前"][Math.floor(6 * Math.random())]; return { id: Date.now() + a, weiboId: t, user: e.user, content: e.comment, stance: n, stanceText: e.stanceRaw, time: i, likes: Math.floor(20 * Math.random()) } });return 0 === o.length ? this.generateFallbackComments(e, t) : o} catch (a) { return console.error("生成多样化评论失败:", a), this.generateFallbackComments(e, t) }},generateFallbackComments: function(e, t) { const a = ["网友A", "网友B", "网友C", "网友D", "网友E", "网友F"], n = ["说得太好了！完全同意！", "这个观点很新颖，值得思考", "支持楼主，说出了我的心声", "有理有据，分析到位", "点赞！期待更多分享"], i = ["这个观点有点片面了", "不敢苟同，事实并非如此", "我觉得你说得不对", "这个分析有点问题", "过于主观了，不够客观"], o = ["永远支持！你是最棒的！", "不管别人怎么说，我都支持你", "说得对！无条件支持！", "爱你！永远站在你这边", "你就是真理！"], r = ["又在胡说八道了", "这种观点也能发出来？", "明显是在带节奏", "看看这说的什么话", "建议删了吧，太尴尬了"], s = [n, i, o, r], c = ["supportive", "critical", "fan", "anti"], l = ["支持", "批评", "粉丝", "黑粉"], d = ["刚刚", "1分钟前", "5分钟前", "10分钟前"]; return Array.from({ length: 6 }, (e, n) => { const i = n % 4, o = s[i], r = o[Math.floor(Math.random() * o.length)]; return { id: Date.now() + n, weiboId: t, user: a[n], content: r, stance: c[i], stanceText: l[i], time: d[Math.floor(Math.random() * d.length)], likes: Math.floor(20 * Math.random()) } }) },refreshCommentsForWeibo: async function(e) {const t = this.weibos.find(t => t.id === e); if (!t || t.generatingComments) return; t.generatingComments = !0; const a = document.querySelector(`.refresh-comments-btn[data-weibo-id="${e}"]`); a && (a.classList.add("loading"), a.textContent = "生成中...", a.disabled = !0);try { const n = await this.generateDiverseComments(t.content, e); t.commentsList = n, t.comments = n.length, t.lastCommentRefresh = (new Date).toISOString(), localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList(), a && (a.textContent = "刷新评论 ✓", setTimeout(() => { a.textContent = "刷新评论" }, 1e3)) } catch (e) { console.error("刷新评论失败:", e), a && (a.textContent = "刷新失败", setTimeout(() => { a.textContent = "刷新评论" }, 2e3)) } finally { t.generatingComments = !1, a && (a.classList.remove("loading"), a.disabled = !1) }},currentCategory: "", currentWeiboId: null, currentDeletingWeiboId: null,init: function() { this.renderCategoryTags(), this.renderCategoryList(), this.renderCategorySelect(), this.loadUserProfile(), this.switchPage("home"), this.bindEvents(), this.renderWeiboList(), this.renderDiscoverPage(), this.updateUserAvatar(), this.bindDeleteDialogEvents() },bindDeleteDialogEvents: function() { document.getElementById("confirm-weibo-delete-btn").addEventListener("click", () => { this.confirmDeleteWeibo() }), document.getElementById("cancel-weibo-delete-btn").addEventListener("click", () => { this.cancelDeleteWeibo() }) },deleteWeibo: function(e) { const t = this.weibos.findIndex(t => t.id === e); return -1 !== t && (this.weibos.splice(t, 1), localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList(), this.loadUserProfile(), !0) },showDeleteWeiboConfirm: function(e) { this.currentDeletingWeiboId = e, document.getElementById("weibo-delete-dialog").style.display = "flex" },confirmDeleteWeibo: function() { this.currentDeletingWeiboId && (this.deleteWeibo(this.currentDeletingWeiboId), document.getElementById("weibo-delete-dialog").style.display = "none", this.currentDeletingWeiboId = null) },cancelDeleteWeibo: function() { document.getElementById("weibo-delete-dialog").style.display = "none", this.currentDeletingWeiboId = null },updateUserAvatar: function() { const e = document.getElementById("weiboUserAvatar"); e && (e.textContent = this.userProfile.name.charAt(0)) },loadDynamicWeibos: async function() {const e = document.getElementById("weiboList"); e.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">正在加载动态内容...</div>'; const t = [];for (let e = 0; e < 3; e++) try { const a = await this.dynamicContent.generateNPCWeibo(this.currentCategory), n = { id: Date.now() + e, username: a.username, content: a.content, timestamp: this.dynamicContent.generateTimestamp(Math.floor(3 * Math.random())), category: this.currentCategory || this.getRandomCategory(), likes: Math.floor(50 * Math.random()), comments: 0, reposts: Math.floor(15 * Math.random()), commentsList: [], userBio: a.userBio, isLiked: !1, isChatCharacter: a.isChatCharacter || !1, isFanRole: a.isFanRole || !1, generatingComments: !1, lastCommentRefresh: null }; n && t.push(n) } catch (e) { console.error("生成微博失败:", e) }this.weibos = [...t, ...this.weibos], localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList()},getRandomCategory: function() { return this.categories.length > 0 ? this.categories[Math.floor(Math.random() * this.categories.length)] : "生活" },renderCategoryTags: function() { const e = document.getElementById("weiboCategoryTags"); e.innerHTML = ""; const t = document.createElement("div"); t.className = `weibo-category-tag ${"" === this.currentCategory ? "active" : ""}`, t.textContent = "全部", t.setAttribute("data-category", ""), t.addEventListener("click", () => this.filterByCategory("")), e.appendChild(t), this.categories.forEach(t => { const a = document.createElement("div"); a.className = `weibo-category-tag ${this.currentCategory === t ? "active" : ""}`, a.textContent = t, a.setAttribute("data-category", t), a.addEventListener("click", () => this.filterByCategory(t)), e.appendChild(a) }) },renderCategoryList: function() { const e = document.getElementById("weiboCategoryList"); e.innerHTML = "", this.categories.forEach(t => { const a = document.createElement("div"); a.className = "weibo-category-item", a.innerHTML = `<span>${t}</span><button class="weibo-delete-category" data-category="${t}">删除</button>`, e.appendChild(a) }), document.querySelectorAll(".weibo-delete-category").forEach(e => { e.addEventListener("click", e => { const t = e.target.getAttribute("data-category"); this.deleteCategory(t) }) }) },renderCategorySelect: function() { const e = document.getElementById("weiboCategorySelect"); e.innerHTML = '<option value="">选择分类</option>', this.categories.forEach(t => { const a = document.createElement("option"); a.value = t, a.textContent = t, e.appendChild(a) }) },renderWeiboList: function() {const e = document.getElementById("weiboList"); e.innerHTML = ""; const t = this.currentCategory ? this.weibos.filter(e => e.category === this.currentCategory) : this.weibos; if (0 === t.length) return void(e.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无微博内容，点击"刷新动态"按钮加载内容</div>');t.forEach(t => {void 0 === t.isLiked && (t.isLiked = !1), t.commentsList || (t.commentsList = []); const a = document.createElement("div"); a.className = "weibo-item"; const n = t.isLiked ? "like-btn liked" : "like-btn"; let i = t.username.charAt(0); t.username.startsWith("网友") && (i = t.username.replace("网友", "")); let o = "";o = t.commentsList && t.commentsList.length > 0 ? `\n <div class="weibo-comments-container">\n <div class="weibo-comments-header">\n <div class="weibo-comments-title">评论 (${t.commentsList.length})</div>\n <button class="refresh-comments-btn" data-weibo-id="${t.id}">刷新评论</button>\n </div>\n <div class="weibo-comments-list-inline">\n ${t.commentsList.map(e=>`\n <div class="weibo-comment-item-inline">\n <div class="weibo-comment-header-inline">\n <span class="weibo-comment-user-inline">${e.user}</span>\n <span class="weibo-comment-stance stance-${e.stance}">${e.stanceText}</span>\n <span class="weibo-comment-time-inline">${e.time}</span>\n </div>\n <div class="weibo-comment-text-inline">${e.content}</div>\n </div>\n `).join("")}\n </div>\n </div>\n ` : `\n <div class="weibo-comments-container">\n <div class="weibo-comments-header">\n <div class="weibo-comments-title">暂无评论</div>\n <button class="refresh-comments-btn" data-weibo-id="${t.id}">生成评论</button>\n </div>\n </div>\n `, a.innerHTML = `\n <div class="weibo-avatar">${i}</div>\n <div class="weibo-content">\n <div class="weibo-item-header">\n <span class="weibo-username">${t.username}</span>\n ${t.category?`<span class="weibo-item-category">${t.category}</span>`:""}\n <span class="weibo-timestamp">${t.timestamp}</span>\n </div>\n <div class="weibo-item-text">${t.content}</div>\n <div class="weibo-item-actions">\n <button class="repost-btn">转发 ${t.reposts}</button>\n <button class="comment-btn" data-weibo-id="${t.id}">评论 ${t.comments}</button>\n <button class="${n}" data-weibo-id="${t.id}">点赞 ${t.likes}</button>\n <button class="delete-btn" data-weibo-id="${t.id}">删除</button>\n </div>\n ${o}\n </div>`, e.appendChild(a)}), document.querySelectorAll(".like-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")), t = weiboManager.weibos.find(t => t.id === e); t && (t.isLiked ? (t.likes = Math.max(0, t.likes - 1), t.isLiked = !1, this.classList.remove("liked")) : (t.likes += 1, t.isLiked = !0, this.classList.add("liked")), this.textContent = `点赞 ${t.likes}`, localStorage.setItem("weibos", JSON.stringify(weiboManager.weibos))) }) }), document.querySelectorAll(".comment-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")); weiboManager.openCommentModal(e) }) }), document.querySelectorAll(".repost-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.closest(".weibo-item").querySelector(".comment-btn").getAttribute("data-weibo-id")), t = weiboManager.weibos.find(t => t.id === e); t && (t.reposts += 1, localStorage.setItem("weibos", JSON.stringify(weiboManager.weibos)), this.textContent = `转发 ${t.reposts}`, alert("转发成功！")) }) }), document.querySelectorAll(".delete-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")); weiboManager.showDeleteWeiboConfirm(e) }) }), document.querySelectorAll(".refresh-comments-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")); weiboManager.refreshCommentsForWeibo(e) }) })},openCommentModal: function(e) { this.currentWeiboId = e; const t = this.weibos.find(t => t.id === e), a = document.getElementById("weiboCommentsList"); a.innerHTML = "", t.commentsList && t.commentsList.length > 0 ? t.commentsList.forEach(e => { const t = document.createElement("div"); t.className = "weibo-comment-item", t.innerHTML = `<div><span class="weibo-comment-user">${e.user}</span><span style="font-size: 12px; color: #666;">${e.time}</span></div><div class="weibo-comment-text">${e.content}</div>`, a.appendChild(t) }) : a.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无评论</div>', document.getElementById("weiboCommentModal").style.display = "flex", document.getElementById("weiboCommentInput").focus() },submitNewComment: async function() {let e = document.getElementById("weiboCommentInput").value.trim();if (!e && this.currentWeiboId) { const t = this.weibos.find(t => t.id === this.currentWeiboId); if (t) { const a = document.getElementById("weiboCommentInput"); a.value = "正在生成评论...", a.disabled = !0; try { e = await this.generateComment(t.content), a.value = e } catch (e) { console.error("生成评论失败:", e), a.value = "评论一下！" } finally { a.disabled = !1 } } }e && this.currentWeiboId && this.addComment(this.currentWeiboId, e)},addComment: function(e, t) { const a = this.weibos.find(t => t.id === e); a && (a.commentsList || (a.commentsList = []), a.commentsList.unshift({ user: this.userProfile.name, content: t, time: "刚刚" }), a.comments += 1, localStorage.setItem("weibos", JSON.stringify(this.weibos)), document.getElementById("weiboCommentInput").value = "", document.getElementById("weiboCommentModal").style.display = "none", this.renderWeiboList()) },renderDiscoverPage: function() { this.renderTrendingTopics(), this.renderHotSearch(), this.renderRandomQuote(), 0 === this.hotSearchList.length && this.generateHotSearch(), 0 === this.trendingTopics.length && this.generateTrendingTopics() },renderTrendingTopics: function() { const e = document.getElementById("weiboTopicList"); e.innerHTML = "";[...this.trendingTopics].sort(() => .5 - Math.random()).slice(0, 5).forEach(t => { const a = document.createElement("div"); a.className = "weibo-topic-item", a.innerHTML = `<div class="weibo-topic-name">${t.name}</div><div class="weibo-topic-stats">${t.posts} 帖子 · ${t.trend}</div>`, e.appendChild(a) }) },generateTrendingTopics: function() { this.trendingTopics = [{ name: "#AI技术分享#", posts: Math.floor(50 * Math.random() + 10) + "万", trend: "热" }, { name: "#日常生活#", posts: Math.floor(100 * Math.random() + 20) + "万", trend: "新" }, { name: "#美食探店#", posts: Math.floor(80 * Math.random() + 15) + "万", trend: "沸" }, { name: "#恐怖故事#", posts: Math.floor(60 * Math.random() + 5) + "万", trend: "新" }], this.renderTrendingTopics() },generateHotSearch: async function() {const e = document.getElementById("weiboHotSearchList"); e.innerHTML = '<div style="text-align: center; padding: 10px; color: #666;">正在实时生成热搜...</div>'; const t = this.userProfile.name, a = this.userProfile.persona, n = this.userProfile.followers, i = n > 1e4 || /明星|演员|歌手|网红|大V|偶像|艺人|巨星/.test(a); let o = "请生成10个微博热搜词条（不带#号），每行一个。"; i ? o += `\n用户身份是是：${t}，人设是：${a}，粉丝数：${n}。\n这是一个知名人物。请务必在生成的10个热搜中，包含1-3条关于"${t}"的热搜，并且将关于"${t}"的热搜放在前三名。\n其他热搜可以是社会新闻、娱乐八卦等。` : o += "\n用户身份是普通人。请生成10个普通的社会、娱乐、生活类热搜。", o += "\n格式要求：纯文本，每行一个词条，不要带序号。";try { const t = await appState.apiService.generateRawContent("你是一个微博热搜生成器。", o, .8), a = t.split("\n").filter(e => "" !== e.trim()).map(e => e.replace(/^\d+\.\s*/, "").trim()).slice(0, 10); this.hotSearchList = a.map((e, t) => { let a = ""; return t < 3 ? a = "tag-hot" : 3 === t && (a = "tag-new"), { text: e, tag: a } }), this.renderHotSearch() } catch (t) { console.error("生成热搜失败:", t), this.hotSearchList = [{ text: "服务器开小差了", tag: "" }, { text: "AI生成失败", tag: "" }], this.renderHotSearch() }},renderHotSearch: function() { const e = document.getElementById("weiboHotSearchList"); e.innerHTML = "", this.hotSearchList.forEach((t, a) => { const n = document.createElement("div"); n.className = "weibo-topic-item"; const i = a < 3 ? `rank-top-${a + 1}` : "rank-normal", o = t.tag ? `<span class="weibo-tag ${t.tag}">${0 === a ? "爆" : "热"}</span>` : ""; n.innerHTML = `<div class="weibo-topic-name"><span class="weibo-rank-number ${i}">${a + 1}</span> ${t.text} ${o}</div><div class="weibo-topic-stats" style="padding-left: 25px;">${Math.floor(500 * Math.random() + 100)}万 搜索量</div>`, e.appendChild(n) }) },renderRandomQuote: function() { const e = Math.floor(Math.random() * this.quotes.length); document.getElementById("weiboRandomQuote").textContent = this.quotes[e] },loadUserProfile: function() { document.getElementById("weiboProfileName").value = this.userProfile.name, document.getElementById("weiboProfileBio").value = this.userProfile.bio, document.getElementById("weiboProfilePersona").value = this.userProfile.persona, document.getElementById("weiboProfileLocation").value = this.userProfile.location, document.getElementById("weiboProfileFollowers").value = this.userProfile.followers, document.getElementById("weiboProfileFollowing").value = this.userProfile.following, document.getElementById("myProfileName").textContent = this.userProfile.name, document.getElementById("myProfileBio").textContent = this.userProfile.bio, document.getElementById("myProfileFollowers").textContent = this.userProfile.followers, document.getElementById("myProfileFollowing").textContent = this.userProfile.following, document.getElementById("myProfileWeibos").textContent = this.weibos.filter(e => e.username === this.userProfile.name).length; const e = document.getElementById("myProfileAvatar"); e && (e.textContent = this.userProfile.name.charAt(0)) },saveUserProfile: function() { this.userProfile = { name: document.getElementById("weiboProfileName").value.trim() || "微博用户", bio: document.getElementById("weiboProfileBio").value.trim() || "这个人很懒，什么都没有写...", persona: document.getElementById("weiboProfilePersona").value.trim() || "普通用户", location: document.getElementById("weiboProfileLocation").value.trim(), followers: parseInt(document.getElementById("weiboProfileFollowers").value) || 0, following: parseInt(document.getElementById("weiboProfileFollowing").value) || 0 }, localStorage.setItem("weiboUserProfile", JSON.stringify(this.userProfile)), document.getElementById("weiboProfileModal").style.display = "none", this.updateUserWeibos(), this.updateUserAvatar(), this.loadUserProfile() },updateUserWeibos: function() { this.weibos.forEach(e => { "当前用户" === e.username && (e.username = this.userProfile.name) }), localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList() },filterByCategory: function(e) { this.currentCategory = e, this.renderCategoryTags(), this.renderWeiboList() },addCategory: function() { const e = document.getElementById("weiboNewCategoryInput").value.trim(); e && !this.categories.includes(e) && (this.categories.push(e), localStorage.setItem("weiboCategories", JSON.stringify(this.categories)), this.renderCategoryTags(), this.renderCategoryList(), this.renderCategorySelect(), document.getElementById("weiboNewCategoryInput").value = "") },deleteCategory: function(e) { this.categories = this.categories.filter(t => t !== e), localStorage.setItem("weiboCategories", JSON.stringify(this.categories)), this.renderCategoryTags(), this.renderCategoryList(), this.renderCategorySelect(), this.currentCategory === e && this.filterByCategory("") },publishWeibo: async function() { const e = document.getElementById("weiboText").value.trim(), t = document.getElementById("weiboCategorySelect").value; if (!e) return void alert("请输入微博内容！"); if (e) { const a = { id: Date.now(), username: this.userProfile.name, content: e, timestamp: "刚刚", category: t, likes: 0, comments: 0, reposts: 0, commentsList: [], isLiked: !1, isChatCharacter: !1, isFanRole: !1, generatingComments: !1, lastCommentRefresh: null }; this.weibos.unshift(a), localStorage.setItem("weibos", JSON.stringify(this.weibos)), document.getElementById("weiboText").value = "", document.getElementById("weiboCategorySelect").value = "", this.renderWeiboList(), this.loadUserProfile(), alert("微博发布成功！") } },refreshDynamicContent: async function() { await this.loadDynamicWeibos(), this.renderDiscoverPage(), alert("已添加新动态！") },switchPage: function(e) { document.getElementById("weiboHomePage").classList.remove("active"), document.getElementById("weiboDiscoverPage").classList.remove("active"), document.getElementById("weiboProfilePage").classList.remove("active"), document.getElementById("weiboHomeLink").classList.remove("active"), document.getElementById("weiboDiscoverLink").classList.remove("active"), document.getElementById("weiboProfileLink").classList.remove("active"), "home" === e ? (document.getElementById("weiboHomePage").classList.add("active"), document.getElementById("weiboHomeLink").classList.add("active")) : "discover" === e ? (document.getElementById("weiboDiscoverPage").classList.add("active"), document.getElementById("weiboDiscoverLink").classList.add("active"), this.renderDiscoverPage()) : "profile" === e && (document.getElementById("weiboProfilePage").classList.add("active"), document.getElementById("weiboProfileLink").classList.add("active"), this.loadUserProfile()) },bindEvents: function() {document.getElementById("weiboManageCategories").addEventListener("click", () => { document.getElementById("weiboCategoryModal").style.display = "flex" }), document.getElementById("weiboCloseCategoryModal").addEventListener("click", () => { document.getElementById("weiboCategoryModal").style.display = "none" }), document.getElementById("weiboProfileLink").addEventListener("click", e => { e.preventDefault(), this.switchPage("profile") }), document.getElementById("weiboCloseProfileModal").addEventListener("click", () => { document.getElementById("weiboProfileModal").style.display = "none" }), document.getElementById("weiboUserAvatar").addEventListener("click", () => { this.loadUserProfile(), document.getElementById("weiboProfileModal").style.display = "flex" }), document.getElementById("weiboHomeLink").addEventListener("click", e => { e.preventDefault(), this.switchPage("home") }), document.getElementById("weiboDiscoverLink").addEventListener("click", e => { e.preventDefault(), this.switchPage("discover") }), document.getElementById("weiboAddCategoryBtn").addEventListener("click", () => { this.addCategory() }), document.getElementById("weiboNewCategoryInput").addEventListener("keypress", e => { "Enter" === e.key && this.addCategory() }), document.getElementById("weiboSaveProfileBtn").addEventListener("click", () => { this.saveUserProfile() }), document.getElementById("weiboPublishBtn").addEventListener("click", () => { this.publishWeibo() }), document.getElementById("weiboText").addEventListener("keypress", e => { e.ctrlKey && "Enter" === e.key && this.publishWeibo() }), document.getElementById("weiboRefreshHotSearch").addEventListener("click", () => { this.generateHotSearch() }), document.getElementById("weiboRefreshTopics").addEventListener("click", () => { this.generateTrendingTopics() }), document.getElementById("weiboCloseCommentModal").addEventListener("click", () => { document.getElementById("weiboCommentModal").style.display = "none" }), document.getElementById("weiboCancelComment").addEventListener("click", () => { document.getElementById("weiboCommentModal").style.display = "none" }), document.getElementById("weiboSubmitComment").addEventListener("click", () => { this.submitNewComment() }), document.getElementById("weiboCommentInput").addEventListener("keypress", e => { e.key === "Enter" && e.ctrlKey && this.submitNewComment() }), document.getElementById("weiboRefreshDynamicBtn").addEventListener("click", () => { this.refreshDynamicContent() }), document.getElementById("editMyProfileBtn").addEventListener("click", () => { this.loadUserProfile(), document.getElementById("weiboProfileModal").style.display = "flex" })}};

// ==========================================
// 全局管理
// ==========================================    
// 应用全局状态管理器
const appState = {currentPersona: null, apiConfig: {}, customCSS: '', isGenerating: false, models: [], lastUpdated: null,apiService: new ApiService(), chatManager: new ChatManager(), worldbookManager: new WorldbookManager(), multiPersonaManager: new MultiPersonaManager(),currentPersonaTab: 'ai', currentEditingMessageId: null, selectionMode: false, selectedMessageIds: [], chatMode: 'online', chatType: 'single'};let currentInterface = 'desktop';let deleteMessageId = null;let deleteWorldbookId = null;

// ==========================================
// 锁屏系统 (Lock Screen)
// ==========================================    
const lockScreen={quotes:[{text:"Design is intelligence made visible.",author:"Alina Wheeler"},{text:"Simplicity is the ultimate sophistication.",author:"Leonardo da Vinci"},{text:"Less, but better.",author:"Dieter Rams"},{text:"The details are not the details. They make the design.",author:"Charles Eames"},{text:"Good design is as little design as possible.",author:"Dieter Rams"},{text:"Design is not just what it looks like and feels like. Design is how it works.",author:"Steve Jobs"},{text:"Typography is the craft of endowing human language with a durable visual form.",author:"Robert Bringhurst"},{text:"White space is like air: it is necessary for design to breathe.",author:"Wojciech Zieliński"},{text:"Design creates culture. Culture shapes values. Values determine the future.",author:"Robert L. Peters"},{text:"A designer knows he has achieved perfection not when there is nothing left to add, but when there is nothing left to take away.",author:"Antoine de Saint-Exupéry"}],init:function(){this.bindEvents(),this.updateTime(),this.updateQuote(),this.getLocation(),setInterval(()=>this.updateTime(),6e4),setInterval(()=>this.updateQuote(),3e4)},bindEvents:function(){const e=document.getElementById("lock-screen");let t=0,a=0,o=!1;e.addEventListener("touchstart",e=>{t=e.touches[0].clientY,o=!0,e.style.transition="none"}),e.addEventListener("touchmove",e=>{if(!o)return;a=e.touches[0].clientY;const n=t-a;n>0&&(e.style.transform=`translateY(-${Math.min(n/150,1)*100}%)`,document.getElementById("lock-icon").style.transform=`translateY(-${Math.min(n/150,1)*20}px) scale(${1+Math.min(n/150,1)*.2})`)}),e.addEventListener("touchend",()=>{if(!o)return;o=!1,e.style.transition="transform .6s cubic-bezier(0.4,0,0.2,1)";const n=t-a;n>100?this.unlock():(e.style.transform="translateY(0)",document.getElementById("lock-icon").style.transform="translateY(0) scale(1)")}),e.addEventListener("mousedown",e=>{t=e.clientY,o=!0,e.style.transition="none",e.preventDefault()}),document.addEventListener("mousemove",e=>{if(!o)return;a=e.clientY;const n=t-a;n>0&&(document.getElementById("lock-screen").style.transform=`translateY(-${Math.min(n/150,1)*100}%)`,document.getElementById("lock-icon").style.transform=`translateY(-${Math.min(n/150,1)*20}px) scale(${1+Math.min(n/150,1)*.2})`)}),document.addEventListener("mouseup",()=>{if(!o)return;o=!1;const e=document.getElementById("lock-screen");e.style.transition="transform .6s cubic-bezier(0.4,0,0.2,1)";const n=t-a;n>100?this.unlock():(e.style.transform="translateY(0)",document.getElementById("lock-icon").style.transform="translateY(0) scale(1)")})},updateTime:function(){const e=new Date,a=e.getHours().toString().padStart(2,"0")+":"+e.getMinutes().toString().padStart(2,"0"),o=e.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});document.getElementById("lock-time").textContent=a,document.getElementById("lock-date").textContent=o},updateQuote:function(){const e=this.quotes[Math.floor(Math.random()*this.quotes.length)];document.getElementById("lock-quote").innerHTML=`<div class="quote-text">${e.text}</div><div class="quote-author">— ${e.author}</div>`},getLocation:function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{this.getWeatherByCoords(e.coords.latitude,e.coords.longitude)},()=>{this.updateWeather("Beijing","北京", "位置服务已关闭", "--")},{timeout:1e4}):this.updateWeather("Beijing","北京","无法获取位置","--")},getWeatherByCoords:async function(e,t){try{const a=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${t}&current_weather=true`);if(!a.ok)throw new Error("天气API请求失败");const n=await a.json(),o=n.current_weather.temperature.toFixed(0),r=n.current_weather.weathercode,l={0:"晴",1:"晴",2:"局部多云",3:"多云",45:"雾",48:"雾凇",51:"小雨",53:"中雨",55:"大雨",56:"冻雨",57:"冻雨",61:"阵雨",63:"中雨",65:"大雨",66:"冻雨",67:"冻雨",71:"小雪",73:"中雪",75:"大雪",77:"冰雹",80:"阵雨",81:"中雨",82:"大雨",85:"阵雪",86:"大雪",95:"雷暴",96:"雷暴",99:"雷暴"};let i=l[r]||"未知";try{const s=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}`),c=await s.json(),d=c.address.city||c.address.town||c.address.village||"当前位置";this.updateWeather(d,null,i,o)}catch(s){this.updateWeather("当前位置",null,i,o)}}catch(a){console.error("获取天气失败:",a),this.updateWeather("本地",null,"天气更新失败","--")}},updateWeather:function(e,t,a,n){document.getElementById("weather-location").innerHTML=`<i class="fas fa-map-marker-alt"></i> ${e}`,document.getElementById("weather-info").textContent=a&&n?`${a} ${n}°C`:"天气加载中"},unlock:function(){const e=document.getElementById("lock-screen"),t=document.getElementById("lock-icon");t.classList.add("unlocking"),e.classList.add("unlocking"),setTimeout(()=>{e.classList.remove("active","unlocking"),t.classList.remove("unlocking"),e.style.transform="translateY(0)",t.style.transform="translateY(0) scale(1)",document.getElementById("desktop-interface").classList.add("active")},600)},lock:function(){const e=document.getElementById("lock-screen");e.classList.add("active"),this.updateTime(),this.updateQuote(),document.getElementById("desktop-interface").classList.remove("active")}};window.addEventListener("DOMContentLoaded",()=>{lockScreen.init(),document.getElementById("desktop-interface").classList.remove("active")});

// ==========================================
// 锁屏密码验证功能
// ==========================================
const lockPassword={showPasswordPanel:function(){const e=new Date;document.querySelector('.password-time').textContent=e.getHours().toString().padStart(2,'0')+':'+e.getMinutes().toString().padStart(2,'0'),document.querySelector('.password-date').textContent=e.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),document.getElementById('lock-password-panel').style.display='block',document.getElementById('password-input').value='',document.getElementById('password-input').focus(),document.querySelector('.password-hint').textContent='输入密码',document.querySelector('.password-hint').style.color=''},hidePasswordPanel:function(){document.getElementById('lock-password-panel').style.display='none',document.getElementById('password-input').value=''},verifyPassword:function(){const e=document.getElementById('password-input').value,t=localStorage.getItem('lockScreenPassword');if(!t)return this.unlockDevice();e===t?(document.querySelector('.password-hint').textContent='密码正确',document.querySelector('.password-hint').style.color='#0a0',setTimeout(()=>{this.unlockDevice()},500)):(document.querySelector('.password-hint').textContent='密码错误，请重试',document.querySelector('.password-hint').style.color='#f44',document.getElementById('password-input').value='',setTimeout(()=>{document.querySelector('.password-hint').textContent='输入密码',document.querySelector('.password-hint').style.color=''},1e3))},unlockDevice:function(){originalUnlock.call(lockScreen),this.hidePasswordPanel()},cancelPassword:function(){this.hidePasswordPanel();const e=document.getElementById('lock-screen');e.style.transform='translateY(0)';const t=document.getElementById('lock-icon');t.style.transform='translateY(0) scale(1)'}};function submitPassword(){lockPassword.verifyPassword()}function cancelPassword(){lockPassword.cancelPassword()}const originalUnlock=lockScreen.unlock;lockScreen.unlock=function(){const e=localStorage.getItem('lockScreenPassword');e?lockPassword.showPasswordPanel():originalUnlock.call(this)};document.getElementById('password-input')&&document.getElementById('password-input').addEventListener('keypress',function(e){'Enter'===e.key&&submitPassword()});

// ==========================================
// 4.5 聊天界面
// ==========================================
function loadDeliveredOrders() {
    const orderList = document.getElementById('order-list');
    if (!orderList) return;
    orderList.innerHTML = '';
    const storedOrders = localStorage.getItem('foodDeliveryOrders');
    if (!storedOrders) {
        orderList.innerHTML = '<div class="empty-order">暂无外卖订单</div>';
        return;
    }
    const orders = JSON.parse(storedOrders);
    const deliveredOrders = orders.filter(order => order.status === 'delivered' || order.status === 'overtime');
    if (deliveredOrders.length === 0) {
        orderList.innerHTML = '<div class="empty-order">暂无已送达的外卖订单</div>';
        return;
    }
    deliveredOrders.sort((a, b) => new Date(b.time) - new Date(a.time));
    deliveredOrders.forEach(order => {
        const orderItem = document.createElement('div');
        orderItem.className = 'order-item';
        orderItem.dataset.id = order.id;
        const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const orderTime = new Date(order.time);
        const formattedTime = `${orderTime.getMonth()+1}/${orderTime.getDate()} ${orderTime.getHours()}:${orderTime.getMinutes().toString().padStart(2,'0')}`;
        let statusClass = 'simple-order-status';
        let statusText = '';
        switch(order.status) {
            case 'delivering': statusClass += ' status-delivering'; statusText = '配送中'; break;
            case 'delivered': statusClass += ' status-delivered'; statusText = '已送达'; break;
            case 'overtime': statusClass += ' status-overtime'; statusText = '已超时'; break;
            default: statusText = order.status;
        }
        orderItem.innerHTML=`<div style="display:flex;align-items:center;width:100%;">
    <div style="margin-right:10px;"><input type="checkbox" class="order-checkbox" data-id="${order.id}"></div>
    <div style="flex:1;">
        <div class="simple-order-info">
            <div class="simple-order-name">${order.restaurant||'外卖订单'}</div>
            <div class="simple-order-details">
                ${order.items.slice(0,2).map(i=>`${i.name}×${i.quantity}`).join('、')}
                ${order.items.length>2?'...':''}
            </div>
            <div class="simple-order-time">${formattedTime}</div>
        </div>
    </div>
    <div class="simple-order-right">
        <div class="simple-order-price">¥${total.toFixed(1)}</div>
        <div class="${statusClass}">${statusText}</div>
    </div>
</div>`
        orderItem.addEventListener('click',(e)=>{
            if(!e.target.classList.contains('order-checkbox')) showChatOrderDetail(order);
        });
        orderList.appendChild(orderItem);
    });
    const existingSendBtn = orderList.parentNode.querySelector('.send-to-chat-btn');
    if (existingSendBtn) existingSendBtn.remove();
    const sendReceiptBtn = document.createElement('button');
    sendReceiptBtn.textContent = '发送选中订单到聊天';
    sendReceiptBtn.className = 'send-to-chat-btn';
    sendReceiptBtn.style.cssText = 'margin-top:10px;width:100%;padding:8px;background:#000;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:12px;';
    sendReceiptBtn.onclick = sendSelectedOrdersToChat;
    orderList.parentNode.appendChild(sendReceiptBtn);
}
function showChatOrderDetail(order) {
    const total = order.items.reduce((sum,item)=>sum+(item.price*item.quantity),0);
    const detailHTML = `
        <div style="padding:15px;background:#f8f8f8;border-radius:8px;margin:10px 0;">
            <h4 style="margin-bottom:10px;color:#000;">${order.restaurant||'外卖订单'}</h4>
            <div style="font-size:12px;color:#666;margin-bottom:5px;">${order.time}</div>
            <div style="margin:10px 0;border-top:1px solid #ddd;padding-top:10px;">
                ${order.items.map(item=>`
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>${item.name}×${item.quantity}</span>
                        <span>¥${(item.price*item.quantity).toFixed(1)}</span>
                    </div>
                `).join('')}
            </div>
            <div style="display:flex;justify-content:space-between;font-weight:bold;border-top:1px solid #ddd;padding-top:10px;margin-top:10px;">
                <span>总计</span>
                <span>¥${total.toFixed(1)}</span>
            </div>
            <div style="margin-top:10px;font-size:12px;color:#666;">
                <div><strong>配送地址：</strong>${order.deliveryAddress||'未设置'}</div>
                ${order.remark?`<div><strong>备注：</strong>${order.remark}</div>`:''}
                ${order.utensils?`<div><strong>餐具：</strong>${order.utensils}</div>`:''}
            </div>
        </div>`;
    const dialog = document.getElementById('confirm-dialog');
    const content = dialog.querySelector('.confirm-content');
    content.innerHTML = `
        <h3>订单详情</h3>
        ${detailHTML}
        <div class="confirm-buttons" style="margin-top:15px;">
            <button onclick="closeOrderDetail()">关闭</button>
        </div>`;
    dialog.style.display = 'flex';
}
function closeOrderDetail() {
    document.getElementById('confirm-dialog').style.display = 'none';
}
function goToFoodDelivery() {
    openApp('food-delivery');
    setTimeout(() => {
        const foodDeliveryInterface = document.getElementById('food-delivery-interface');
        if (foodDeliveryInterface) {
            const orderNavItem = foodDeliveryInterface.querySelector('.nav-item[data-page="orders"]');
            if (orderNavItem) orderNavItem.click();
        }
    }, 100);
}
function sendSelectedOrdersToChat() {
    const checkboxes = document.querySelectorAll('.order-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('请先选择要发送的订单');
        return;
    }
    const storedOrders = localStorage.getItem('foodDeliveryOrders');
    if (!storedOrders) return;
    const orders = JSON.parse(storedOrders);
    checkboxes.forEach(checkbox => {
        const orderId = parseInt(checkbox.dataset.id);
        const order = orders.find(o => o.id === orderId);
        if (order) {
            const receiptHTML = createReceiptHTML(order);
            appState.chatManager.addMessage('user', receiptHTML, '系统通知', null, 'receipt');
            setTimeout(() => {
                const aiResponse = getAIResponseForOrder(order);
                appState.chatManager.addMessage('ai', aiResponse, 'AI助手');
            }, 500);
        }
    });
    renderChatMessages();
    checkboxes.forEach(cb => cb.checked = false);
    alert(`已发送 ${checkboxes.length} 个订单小票到聊天界面`);
}
function createReceiptHTML(order) {
    const total = order.items.reduce((sum,item)=>sum+(item.price*item.quantity),0);
    const orderTime = new Date(order.time);
    const formattedDate = `${orderTime.getFullYear()}-${(orderTime.getMonth()+1).toString().padStart(2,'0')}-${orderTime.getDate().toString().padStart(2,'0')}`;
    const formattedTime = `${orderTime.getHours().toString().padStart(2,'0')}:${orderTime.getMinutes().toString().padStart(2,'0')}`;
    let statusClass = 'receipt-status ';
    let statusText = '';
    switch(order.status) {
        case 'delivered': statusClass += 'delivered'; statusText = '已送达'; break;
        case 'overtime': statusClass += 'overtime'; statusText = '已超时'; break;
        case 'delivering': statusClass += 'delivering'; statusText = '配送中'; break;
        default: statusClass += 'delivered'; statusText = order.status;
    }
    let customerName = "顾客";
    try {
        const foodDeliveryProfile = localStorage.getItem('foodDeliveryProfile');
        if (foodDeliveryProfile) {
            const profile = JSON.parse(foodDeliveryProfile);
            if (profile.name && profile.name !== "某某") customerName = profile.name;
        }
        if (customerName === "顾客" && window.userProfile && window.userProfile.name) customerName = window.userProfile.name;
        if (customerName === "顾客" && window.foodDelivery && window.foodDelivery.userProfile && window.foodDelivery.userProfile.name) {
            customerName = window.foodDelivery.userProfile.name;
        }
    } catch (e) { console.error("获取用户姓名失败:", e); }
    const receiptId = 'R' + order.id.toString().slice(-6);
    
    const r=order.remark?`<div class="receipt-remark"><strong>备注：</strong>${order.remark}</div>`:''
const a=order.deliveryAddress?`<div style="font-size:10px;color:#666;margin-top:5px;">配送地址: ${order.deliveryAddress}</div>`:''

return `<div class="chat-receipt-wrapper"><div class="chat-receipt">
    <div class="receipt-header"><div class="receipt-title">桃源外卖</div><div class="receipt-subtitle">美食小票</div></div>
    <div class="receipt-store-info">${order.restaurant||'桃源餐厅'}<br>感谢您的光临</div>
    <div class="receipt-datetime">${formattedDate} ${formattedTime}<br>订单号: ${receiptId}</div>
    <div class="receipt-items">${order.items.map(i=>`<div class="receipt-item"><div class="receipt-item-name">${i.name}</div><div class="receipt-item-quantity">×${i.quantity}</div><div class="receipt-item-price">¥${(i.price*i.quantity).toFixed(1)}</div></div>`).join('')}</div>
    <div class="receipt-divider"></div>
    <div class="receipt-totals"><div class="receipt-total-line"><span>小计</span><span>¥${total.toFixed(1)}</span></div><div class="receipt-total-line"><span>配送费</span><span>¥0.0</span></div><div class="receipt-total-line total"><span>总计</span><span>¥${total.toFixed(1)}</span></div></div>
    <div class="receipt-footer"><div class="receipt-thankyou">谢谢惠顾，欢迎再次光临！</div><div class="receipt-barcode"></div><div class="receipt-barcode-number">${customerName}</div><div class="receipt-order-number">订单状态: <span class="${statusClass}">${statusText}</span></div>${r}${a}</div>
</div></div>`
}
function getAIResponseForOrder(order) {
    const responses = {
        'delivered': ['外卖已送达！希望您用餐愉快！','订单已签收，记得给骑手好评哦！','美食已到，请慢慢享用！','送达确认！期待您的下次光临！'],
        'overtime': ['啊哦，订单超时了！骑手正在努力配送中...','抱歉让您久等了，订单有些延误...','配送延迟了，请再耐心等待一下！','超时提醒：骑手正在加速赶来！'],
        'delivering': ['您的外卖正在路上，骑手马上就到！','美食正在配送中，请稍等片刻！','骑手已取餐，正在赶往您的地址！','订单已出餐，即将送达！']
    };
    const statusResponses = responses[order.status] || responses['delivered'];
    return statusResponses[Math.floor(Math.random()*statusResponses.length)];
}

// ==========================================
// 5. 锁屏界面
// ==========================================
function showPasswordSetup(){document.getElementById('lock-icon-area').style.display='none',document.getElementById('password-setup-area').style.display='block',document.getElementById('saved-password-display').style.display='none',document.getElementById('setup-new-password').focus()}function cancelPasswordSetup(){const e=localStorage.getItem('lockScreenPassword');e?(document.getElementById('lock-icon-area').style.display='none',document.getElementById('saved-password-display').style.display='block',document.getElementById('password-setup-area').style.display='none'):(document.getElementById('lock-icon-area').style.display='flex',document.getElementById('saved-password-display').style.display='none',document.getElementById('password-setup-area').style.display='none'),document.getElementById('setup-new-password').value='',document.getElementById('setup-confirm-password').value='',hideStatusMessage()}function saveNewPassword(){const e=document.getElementById('setup-new-password').value,t=document.getElementById('setup-confirm-password').value;if(!e)return showStatusMessage('密码不能为空','error'),void document.getElementById('setup-new-password').focus();if(e!==t)return showStatusMessage('两次输入的密码不一致','error'),void document.getElementById('setup-confirm-password').focus();localStorage.setItem('lockScreenPassword',e),document.getElementById('lock-icon-area').style.display='none',document.getElementById('saved-password-display').style.display='block',document.getElementById('password-setup-area').style.display='none',document.getElementById('password-stars').textContent='●●●●●●',showStatusMessage('密码设置成功！','success'),document.getElementById('setup-new-password').value='',document.getElementById('setup-confirm-password').value='',updateLockScreenHint()}function changePassword(){showPasswordSetup()}function deletePassword(){if(confirm('确定要删除锁屏密码吗？删除后锁屏可直接上滑解锁。')){localStorage.removeItem('lockScreenPassword'),document.getElementById('lock-icon-area').style.display='flex',document.getElementById('saved-password-display').style.display='none',document.getElementById('password-setup-area').style.display='none',showStatusMessage('密码已删除，锁屏可直接上滑解锁','success'),updateLockScreenHint()}}function showStatusMessage(e,t){const a=document.getElementById('password-status-message');a.textContent=e,a.style.display='block',a.style.backgroundColor='success'===t?'#f0f0f0':'#ffebee',a.style.border='success'===t?'1px solid #000':'1px solid #f44',a.style.color='success'===t?'#000':'#c00',setTimeout(()=>{a.style.display='none'},3e3)}function hideStatusMessage(){document.getElementById('password-status-message').style.display='none'}function updateLockScreenHint(){const e=document.querySelector('.unlock-hint span');e&&localStorage.getItem('lockScreenPassword')?e.textContent='上滑并输入密码解锁':e.textContent='上滑解锁'}function initPasswordDisplay(){const e=localStorage.getItem('lockScreenPassword');e?(document.getElementById('lock-icon-area').style.display='none',document.getElementById('saved-password-display').style.display='block',document.getElementById('password-stars').textContent='●●●●●●'):(document.getElementById('lock-icon-area').style.display='flex',document.getElementById('saved-password-display').style.display='none')}window.addEventListener('DOMContentLoaded',function(){initPasswordDisplay()});

// ==========================================
// 5. 外卖界面 (Food Delivery)
// ==========================================
let orderData = [], cartItems = [], favoriteItems = [], currentEditingCartItem = null, savedAddresses = [], selectedTag = "家", userProfile = { name: "某某" }, selectedAddressIndex = -1, countdownTimers = {}, currentRecommendationId = null;

function loadCustomFoods() { const stored = localStorage.getItem('customFoods'); if (stored) { const foods = JSON.parse(stored); foods.forEach(food => { food.isCustom = true; }); return foods; } return []; }
function saveCustomFoods(foods) { const customFoods = foods.filter(food => food.isCustom); localStorage.setItem('customFoods', JSON.stringify(customFoods)); }

function initFoodDelivery(){walletManager.initWallet&&walletManager.initWallet();window.foodDelivery={hasActiveOrders:!1,cartItems:[],updateStatus:function(){updateStatusIndicators()}};const e=loadCustomFoods();window.foodData=[...foodData,...e];renderFoodItems();updateCart();loadOrdersFromStorage();loadFavoritesFromStorage();loadAddressesFromStorage();loadUserProfileFromStorage();updateCartAddress();setTimeout(()=>{setRandomRecommendation();document.getElementById("recommendation-modal").classList.add("active");document.getElementById("food-delivery-interface").querySelector(".overlay").classList.add("active")},2000);setupEventListeners();startAllCountdowns();renderEvaluations();setupAddFoodFunctionality();initFoodDeliveryIntegration()}

function setupAddFoodFunctionality() {
    document.getElementById('add-food-category').addEventListener('click', function() { document.getElementById('add-food-modal').style.display = 'flex'; document.getElementById('new-food-name').focus(); });
    document.getElementById('add-food-modal-close').addEventListener('click', closeAddFoodModal); document.getElementById('add-food-cancel').addEventListener('click', closeAddFoodModal);
    document.getElementById('new-food-category').addEventListener('change', function() { const customInput = document.getElementById('new-food-custom-category'); customInput.style.display = this.value === '自定义' ? 'block' : 'none'; });
    document.getElementById('add-food-save').addEventListener('click', saveNewFood);
}
function closeAddFoodModal() { document.getElementById('add-food-modal').style.display = 'none'; resetAddFoodForm(); }
function resetAddFoodForm() { document.getElementById('new-food-name').value = ''; document.getElementById('new-food-description').value = ''; document.getElementById('new-food-price').value = ''; document.getElementById('new-food-category').value = '汉堡'; document.getElementById('new-food-custom-category').value = ''; document.getElementById('new-food-custom-category').style.display = 'none'; document.getElementById('new-food-icon').value = 'fas fa-hamburger'; document.getElementById('new-food-features').value = ''; }
function saveNewFood() {
    const name = document.getElementById('new-food-name').value.trim(), description = document.getElementById('new-food-description').value.trim(), price = parseFloat(document.getElementById('new-food-price').value), icon = document.getElementById('new-food-icon').value, featuresInput = document.getElementById('new-food-features').value.trim();
    let category = document.getElementById('new-food-category').value;
    if (!name || !description || isNaN(price) || price <= 0) { alert('请输入有效的食物信息'); return; }
    if (category === '自定义') { const customCategory = document.getElementById('new-food-custom-category').value.trim(); if (!customCategory) { alert('请输入自定义分类名称'); return; } category = customCategory; }
    const features = featuresInput ? featuresInput.split(',').map(f => f.trim()).filter(f => f) : [];
    const newFood = { id: 'custom_' + Date.now(), name: name, description: description, price: price, category: category, icon: icon, features: features, isFavorite: false, isCustom: true };
    const customFoods = loadCustomFoods(); customFoods.push(newFood); saveCustomFoods(customFoods); window.foodData.push(newFood); renderFoodItems(); closeAddFoodModal(); alert(`"${name}" 已成功添加到 ${category} 分类中！`);
}
function deleteCustomFood(foodId) { if (!confirm('确定要永久删除这个食物吗？')) return; const foodIndex = window.foodData.findIndex(food => food.id === foodId); if (foodIndex === -1) return; window.foodData.splice(foodIndex, 1); const customFoods = loadCustomFoods(); const updatedCustomFoods = customFoods.filter(food => food.id !== foodId); saveCustomFoods(updatedCustomFoods); renderFoodItems(); alert('食物已永久删除！'); }
function renderFoodItems() { const foodGrid = document.getElementById('food-grid'), hotFoodGrid = document.getElementById('hot-food-grid'); foodGrid.innerHTML = ''; hotFoodGrid.innerHTML = ''; window.foodData.slice(0, 4).forEach(food => { foodGrid.appendChild(createFoodCard(food)); }); window.foodData.forEach(food => { hotFoodGrid.appendChild(createFoodCard(food)); }); }
function createFoodCard(food) {
    const card = document.createElement('div'); card.className = 'food-card'; const deleteBtn = food.isCustom ? `<button class="delete-food-btn" data-id="${food.id}" title="删除此食物">✖</button>` : '';
    card.innerHTML = `<div class="card-top-buttons"><button class="favorite-btn ${food.isFavorite ? 'active' : ''}" data-id="${food.id}"><i class="${food.isFavorite ? 'fas' : 'far'} fa-heart"></i></button>${deleteBtn}</div><div class="food-icon"><i class="${food.icon}"></i></div><div class="food-info"><div class="food-name">${food.name}<span class="food-category">${food.category}</span></div><div class="food-desc">${food.description}</div><div class="food-features">${food.features.map(feature => `<span class="food-feature">${feature}</span>`).join('')}</div><div class="food-footer"><div class="food-price">¥${food.price}</div><button class="add-to-cart-btn" data-id="${food.id}"><i class="fas fa-plus"></i></button></div></div>`;
    card.querySelector('.favorite-btn').addEventListener('click', function(e) { e.stopPropagation(); toggleFavorite(food.id); }); 
    card.querySelector('.add-to-cart-btn').addEventListener('click', function(e) { e.stopPropagation(); openEditModalForFood(food.id); });
    if (food.isCustom) { card.querySelector('.delete-food-btn').addEventListener('click', function(e) { e.stopPropagation(); deleteCustomFood(food.id); }); }
    card.addEventListener('click', function(e) { if (!e.target.closest('button')) { openEditModalForFood(food.id); } });
    return card;
}
function openEditModalForFood(e){
    const t=window.foodData.find(t=>t.id==e); 
    if(!t)return void console.error("找不到食物:",e);
    console.log("正在编辑的食物:",t.name,t.category);
    const n=cartItems.find(n=>n.id==e); 
currentEditingCartItem=n?{id:n.id,name:n.name,price:n.price,quantity:n.quantity,icon:n.icon,remark:n.remark||"",utensils:n.utensils||"需要餐具",description:n.description||t.description,features:n.features||t.features,category:n.category||t.category,isCustom:n.isCustom||t.isCustom||!1}:{id:t.id,name:t.name,price:t.price,quantity:1,icon:t.icon,remark:"",utensils:"需要餐具",description:t.description||"",features:t.features||[],category:t.category||"",isCustom:t.isCustom||!1};showCartItemDetail(e)}
function setRandomRecommendation() { const randomIndex = Math.floor(Math.random() * window.foodData.length), recommendedFood = window.foodData[randomIndex]; currentRecommendationId = recommendedFood.id; document.getElementById('recommendation-modal-icon').innerHTML = `<i class="${recommendedFood.icon}"></i>`; document.getElementById('recommendation-modal-title').textContent = recommendedFood.name; document.getElementById('recommendation-modal-subtitle').textContent = "今日特惠 · 限量供应"; document.getElementById('recommendation-modal-desc').textContent = recommendedFood.description; document.getElementById('recommendation-modal-price').textContent = `¥${recommendedFood.price}`; const featuresContainer = document.getElementById('recommendation-modal-features'); featuresContainer.innerHTML = ''; recommendedFood.features.forEach(feature => { const featureElement = document.createElement('div'); featureElement.className = 'modal-feature'; featureElement.textContent = feature; featuresContainer.appendChild(featureElement); }); }
function loadOrdersFromStorage() { const storedOrders = localStorage.getItem('foodDeliveryOrders'); if (storedOrders) { orderData = JSON.parse(storedOrders); orderData = orderData.filter(order => order.status !== 'canceled'); updateOrderStatuses(); saveOrdersToStorage(); renderOrderList(); } }
function updateOrderStatuses() { const now = new Date(); orderData.forEach(order => { if (order.status === 'delivering') { if (order.deliveryTime && new Date(order.deliveryTime) < now) { order.status = 'overtime'; order.isOvertime = true; } if (order.estimatedArrivalTime && new Date(order.estimatedArrivalTime) < now) { order.status = 'delivered'; } } }); }
function saveOrdersToStorage() { localStorage.setItem('foodDeliveryOrders', JSON.stringify(orderData)); }
function loadFavoritesFromStorage() { const storedFavorites = localStorage.getItem('foodDeliveryFavorites'); if (storedFavorites) { const favoriteIds = JSON.parse(storedFavorites); favoriteItems = []; window.foodData.forEach(food => { food.isFavorite = favoriteIds.includes(food.id); if (food.isFavorite) { favoriteItems.push(food); } }); } }
function saveFavoritesToStorage() { const favoriteIds = window.foodData.filter(food => food.isFavorite).map(food => food.id); localStorage.setItem('foodDeliveryFavorites', JSON.stringify(favoriteIds)); }
function loadUserProfileFromStorage() { const storedProfile = localStorage.getItem('foodDeliveryProfile'); if (storedProfile) { userProfile = JSON.parse(storedProfile); document.getElementById('name-text').textContent = userProfile.name; document.getElementById('name-edit-input').value = userProfile.name; } }
function saveUserProfileToStorage() { localStorage.setItem('foodDeliveryProfile', JSON.stringify(userProfile)); }
function renderOrderList(filter = "all") {
    const ordersList = document.getElementById('orders-list'); const existingCards = ordersList.querySelectorAll('.order-card'); existingCards.forEach(card => card.remove()); const existingEmptyFilter = ordersList.querySelector('.empty-orders:not(#empty-orders)'); if (existingEmptyFilter) { existingEmptyFilter.remove(); }
    const activeOrders = orderData.filter(order => order.status !== 'canceled'); if (activeOrders.length === 0) { document.getElementById('empty-orders').style.display = 'block'; return; } document.getElementById('empty-orders').style.display = 'none';
    let filteredOrders = activeOrders; if (filter !== "all") { if (filter === "overtime") { filteredOrders = activeOrders.filter(order => order.isOvertime === true); } else { filteredOrders = activeOrders.filter(order => order.status === filter); } }
    if (filteredOrders.length === 0) { const emptyFilter = document.createElement('div'); emptyFilter.className = 'empty-orders'; emptyFilter.innerHTML = `<i class="fas fa-filter"></i><p>没有${getFilterText(filter)}的订单</p>`; ordersList.appendChild(emptyFilter); return; }
    filteredOrders.forEach(order => { const orderCard = createOrderCard(order); ordersList.appendChild(orderCard); });
}
function getFilterText(filter) { switch (filter) { case "delivering": return "配送中"; case "delivered": return "已送达"; case "canceled": return "已取消"; case "overtime": return "已超时"; default: return ""; } }
function createOrderCard(order) {
    const card = document.createElement('div'); card.className = 'order-card'; card.setAttribute('data-id', order.id); const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0); let statusText = "", statusClass = "";
    switch (order.status) { case "delivering": statusText = "配送中"; statusClass = "status-delivering"; break; case "delivered": statusText = "已送达"; statusClass = "status-delivered"; break; case "canceled": statusText = "已取消"; statusClass = "status-canceled"; break; case "overtime": statusText = "已超时"; statusClass = "status-overtime"; break; }
    card.innerHTML = `<div class="order-header"><div class="order-status ${statusClass}">${statusText}</div><div class="order-time">${order.time}</div></div><div class="order-content"><div class="order-restaurant"><i class="fas fa-store"></i>${order.restaurant}</div><div class="order-items">${order.items.map(item => `<div class="order-item"><div class="order-item-name">${item.name}</div><div class="order-item-quantity">×${item.quantity}</div><div class="order-item-price">¥${item.price.toFixed(1)}</div></div>`).join('')}</div><div class="order-total"><span>总计</span><span>¥${total.toFixed(1)}</span></div></div><div class="order-footer"><div class="order-actions"><button class="order-btn primary view-detail-btn" data-id="${order.id}">查看详情</button>${order.status === 'delivered' ? `<button class="order-btn primary evaluate-btn" data-id="${order.id}">评价订单</button>` : ''}<button class="order-btn danger delete-order-btn" data-id="${order.id}">删除订单</button></div></div>`; return card;
}
function generateStarRating(rating) { let stars = ""; const fullStars = Math.floor(rating); const halfStar = rating % 1 >= 0.5; for (let i = 0; i < fullStars; i++) { stars += '<i class="fas fa-star"></i>'; } if (halfStar) { stars += '<i class="fas fa-star-half-alt"></i>'; } const emptyStars = 5 - fullStars - (halfStar ? 1 : 0); for (let i = 0; i < emptyStars; i++) { stars += '<i class="far fa-star"></i>'; } return stars; }
function showOrderDetail(orderId) {
    const order = orderData.find(o => o.id === orderId); if (!order) return; const detailContent = document.getElementById('order-detail-content'), total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let progressWidth = "0%", step1Active = false, step2Active = false, step3Active = false, step4Active = false; const now = new Date(), acceptTime = new Date(order.time), pickupTime = order.pickupTime ? new Date(order.pickupTime) : new Date(acceptTime.getTime() + 5 * 60000), deliveryTime = order.deliveryTime ? new Date(order.deliveryTime) : new Date(pickupTime.getTime() + 15 * 60000), arrivalTime = order.estimatedArrivalTime ? new Date(order.estimatedArrivalTime) : new Date(deliveryTime.getTime() + 10 * 60000);
    step1Active = true; step2Active = now >= pickupTime; step3Active = now >= deliveryTime; step4Active = order.status === 'delivered' || now >= arrivalTime; if (step4Active) { progressWidth = "100%"; } else if (step3Active) { progressWidth = "75%"; } else if (step2Active) { progressWidth = "50%"; } else if (step1Active) { progressWidth = "25%"; }
    const countdownHtml = generateCountdownHtml(order), ratingStars = generateStarRating(order.riderRating || 5);
    detailContent.innerHTML = `<div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-clock"></i>配送信息</h3>${countdownHtml}<div class="delivery-progress"><div class="progress-steps"><div class="progress-step"><div class="step-icon ${step1Active ? 'active' : ''}">1</div><div class="step-label ${step1Active ? 'active' : ''}">接单</div></div><div class="progress-step"><div class="step-icon ${step2Active ? 'active' : ''}">2</div><div class="step-label ${step2Active ? 'active' : ''}">取餐</div></div><div class="progress-step"><div class="step-icon ${step3Active ? 'active' : ''}">3</div><div class="step-label ${step3Active ? 'active' : ''}">配送</div></div><div class="progress-step"><div class="step-icon ${step4Active ? 'active' : ''}">4</div><div class="step-label ${step4Active ? 'active' : ''}">送达</div></div></div><div class="progress-bar"><div class="progress-fill" style="width: ${progressWidth}"></div></div></div><div class="rider-info"><div class="rider-name">${order.riderName} 骑手</div><div class="rider-rating"><div class="star-rating">${ratingStars}</div><span>${order.riderRating || 5}</span></div></div><div class="detail-address"><div class="address-label">配送地址</div><div class="address-value">${order.deliveryAddress}</div></div></div><div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-utensils"></i>订单详情</h3><div class="detail-items-list">${order.items.map(item => { const food = window.foodData.find(f => f.name === item.name) || { icon: "fas fa-utensils", description: "" }; return `<div class="detail-item"><div class="detail-item-img"><i class="${food.icon}"></i></div><div class="detail-item-info"><div class="detail-item-name">${item.name} ×${item.quantity}</div><div class="detail-item-desc">${food.description}</div><div class="detail-item-price">¥${item.price.toFixed(1)}</div></div></div>`; }).join('')}</div><div class="order-total" style="margin-top:16px"><span>总计</span><span>¥${total.toFixed(1)}</span></div></div><div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-sticky-note"></i>订单备注</h3><div class="detail-remark"><div class="remark-label">备注信息</div><div class="remark-value">${order.remark || "无"}</div></div><div class="detail-utensils"><div class="utensil-option ${order.utensils === '需要餐具' ? 'active' : ''}"><i class="fas fa-utensils"></i><span>需要餐具</span></div><div class="utensil-option ${order.utensils === '不需要餐具' ? 'active' : ''}"><i class="fas fa-ban"></i><span>不需要餐具</span></div></div></div>${order.status === 'delivered' || order.isOvertime ? `<div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-star"></i>订单评价</h3><div style="padding:10px 0"><button class="order-btn primary" id="evaluate-order-btn" data-id="${order.id}" style="width:100%">前往评价</button></div></div>` : ''}<div class="detail-section"><button class="order-btn danger delete-order-detail-btn" data-id="${order.id}" style="width:100%">删除订单</button></div>`;
    document.getElementById('order-detail-modal').classList.add('active'); const deleteBtn = document.querySelector('.delete-order-detail-btn'); if (deleteBtn) { deleteBtn.addEventListener('click', function() { const orderId = parseInt(this.getAttribute('data-id')); deleteOrder(orderId); }); } const evaluateBtn = document.getElementById('evaluate-order-btn'); if (evaluateBtn) { evaluateBtn.addEventListener('click', function() { const orderId = parseInt(this.getAttribute('data-id')); document.getElementById('order-detail-modal').classList.remove('active'); document.querySelectorAll('.food-page-container').forEach(container => { container.classList.remove('active'); }); document.getElementById('evaluations-page').classList.add('active'); document.querySelectorAll('#food-delivery-interface .nav-item').forEach(item => { item.classList.remove('active'); }); renderEvaluations(); setTimeout(() => { const evaluationCard = document.querySelector(`.evaluation-card[data-id="${orderId}"]`); if (evaluationCard) { evaluationCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }, 100); }); }
    startCountdown(orderId);
}
function generateCountdownHtml(order) {
    const now = new Date(), arrivalTime = order.estimatedArrivalTime ? new Date(order.estimatedArrivalTime) : new Date(new Date(order.time).getTime() + 30 * 60000), timeRemaining = arrivalTime.getTime() - now.getTime();
    if (order.status === 'delivered') { return `<div class="delivery-time-info"><div class="delivery-time-label">送达时间</div><div class="delivery-time-value">${order.deliveredTime || '已送达'}</div></div>`; }
    else if (timeRemaining < 0 || order.isOvertime) { return `<div class="delivery-time-info"><div class="delivery-time-label">预计送达时间</div><div class="delivery-time-value overtime">${formatTime(arrivalTime)}</div></div><div class="time-countdown"><div class="countdown-timer overtime">已超时</div></div>`; }
    else { const minutesRemaining = Math.max(0, Math.floor(timeRemaining / 60000)), secondsRemaining = Math.max(0, Math.floor((timeRemaining % 60000) / 1000)); return `<div class="delivery-time-info"><div class="delivery-time-label">预计送达时间</div><div class="delivery-time-value">${formatTime(arrivalTime)}</div></div><div class="time-countdown"><div class="countdown-timer" id="countdown-${order.id}">剩余 ${minutesRemaining}分${secondsRemaining}秒</div></div>`; }
}
function formatTime(date) { const hours = date.getHours().toString().padStart(2, '0'), minutes = date.getMinutes().toString().padStart(2, '0'); return `${hours}:${minutes}`; }
function startCountdown(orderId) { const order = orderData.find(o => o.id === orderId); if (!order || order.status === 'delivered' || order.status === 'canceled') return; if (countdownTimers[orderId]) { clearInterval(countdownTimers[orderId]); } countdownTimers[orderId] = setInterval(() => { updateOrderCountdown(orderId); }, 1000); }
function startAllCountdowns() { orderData.forEach(order => { if (order.status === 'delivering' && !order.isOvertime) { startCountdown(order.id); } }); }
function updateOrderCountdown(orderId) {
    const order = orderData.find(o => o.id === orderId); if (!order) { if (countdownTimers[orderId]) { clearInterval(countdownTimers[orderId]); delete countdownTimers[orderId]; } return; }
    if (order.status === 'delivered' || order.status === 'canceled') { if (countdownTimers[orderId]) { clearInterval(countdownTimers[orderId]); delete countdownTimers[orderId]; } return; }
    const now = new Date(), arrivalTime = order.estimatedArrivalTime ? new Date(order.estimatedArrivalTime) : new Date(new Date(order.time).getTime() + 30 * 60000), timeRemaining = arrivalTime.getTime() - now.getTime(), countdownElement = document.getElementById(`countdown-${orderId}`);
    if (countdownElement) { if (timeRemaining <= 0) { countdownElement.textContent = `已超时`; countdownElement.className = 'countdown-timer overtime'; if (!order.isOvertime) { order.isOvertime = true; order.status = 'overtime'; saveOrdersToStorage(); const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter'); renderOrderList(activeFilter); showNotification(`订单 ${orderId} 已超时`); } } else { const minutesRemaining = Math.floor(timeRemaining / 60000), secondsRemaining = Math.floor((timeRemaining % 60000) / 1000); countdownElement.textContent = `剩余 ${minutesRemaining}分${secondsRemaining}秒`; countdownElement.className = 'countdown-timer'; } }
    const riderRating = order.riderRating || 5;
    if (riderRating < 3) {
        if (!order.isOvertime) {
            order.estimatedArrivalTime = new Date(arrivalTime.getTime() + 5000).toISOString();
        }
    } else if (riderRating === 3) {
        if (!order.isOvertime && Math.random() < 0.5) {
            order.estimatedArrivalTime = new Date(arrivalTime.getTime() + 5000).toISOString();
        }
    }
}
function deleteOrder(orderId) { const orderIndex = orderData.findIndex(o => o.id === orderId); if (orderIndex === -1) return; if (confirm('确定要删除这个订单吗？')) { orderData.splice(orderIndex, 1); saveOrdersToStorage(); if (countdownTimers[orderId]) { clearInterval(countdownTimers[orderId]); delete countdownTimers[orderId]; } const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter'); renderOrderList(activeFilter); renderEvaluations(); document.getElementById('order-detail-modal').classList.remove('active'); showNotification('订单已删除'); } }
function showCartItemDetail(itemId) {
    const detailContent = document.getElementById('cart-detail-content');
    detailContent.innerHTML = `
        <div class="detail-item">
            <div class="detail-item-img"><i class="${currentEditingCartItem.icon}"></i></div>
            <div class="detail-item-info">
                <div class="detail-item-name">${currentEditingCartItem.name}</div>
                <div class="detail-item-desc">${currentEditingCartItem.description || ""}</div>
                <div class="detail-item-price">¥${currentEditingCartItem.price.toFixed(1)}</div>
            </div>
        </div>
        <div class="quantity-control">
            <button class="quantity-btn" id="decrease-quantity"><i class="fas fa-minus"></i></button>
            <div class="quantity-value" id="detail-quantity">${currentEditingCartItem.quantity}</div>
            <button class="quantity-btn" id="increase-quantity"><i class="fas fa-plus"></i></button>
        </div>
        <div class="cart-detail-remark">
            <div class="detail-section-title"><i class="fas fa-sticky-note"></i>备注信息</div>
            <textarea class="remark-input" id="detail-remark" placeholder="请输入备注信息（如：少辣、不要香菜等）">${currentEditingCartItem.remark || ""}</textarea>
        </div>
        <div class="cart-detail-utensils">
            <div class="detail-section-title"><i class="fas fa-utensils"></i>餐具选择</div>
            <div class="detail-utensils">
                <div class="utensil-option ${currentEditingCartItem.utensils === '需要餐具' ? 'active' : ''}" data-utensil="需要餐具"><i class="fas fa-utensils"></i><span>需要餐具</span></div>
                <div class="utensil-option ${currentEditingCartItem.utensils === '不需要餐具' ? 'active' : ''}" data-utensil="不需要餐具"><i class="fas fa-ban"></i><span>不需要餐具</span></div>
            </div>
        </div>`;
    
    // 减少和增加数量
const q=document.getElementById('detail-quantity')
document.getElementById('decrease-quantity').addEventListener('click',()=>{let n=parseInt(q.textContent);if(n>1)q.textContent=n-1})
document.getElementById('increase-quantity').addEventListener('click',()=>q.textContent=parseInt(q.textContent)+1)

// 餐具选项切换
document.querySelectorAll('.utensil-option').forEach(opt=>{
    opt.addEventListener('click',function(){
        document.querySelectorAll('.utensil-option').forEach(o=>o.classList.remove('active'))
        this.classList.add('active')
    })
})
    
    document.getElementById('cart-detail-modal').classList.add('active'); 
    document.getElementById('overlay').classList.add('active');
}
function saveCartItemDetail() { 
    if (!currentEditingCartItem) return; 
    
    const quantity = parseInt(document.getElementById('detail-quantity').textContent), 
          remark = document.getElementById('detail-remark').value.trim(), 
          utensils = document.querySelector('.utensil-option.active').getAttribute('data-utensil');
    
    const existingIndex = cartItems.findIndex(item => item.id === currentEditingCartItem.id);
    
    if (existingIndex !== -1) {
        // 更新购物车中的现有项目
        cartItems[existingIndex].quantity = quantity;
        cartItems[existingIndex].remark = remark;
        cartItems[existingIndex].utensils = utensils;
    } else {
        // 添加新项目到购物车
        const food = window.foodData.find(f => f.id === currentEditingCartItem.id);
        if (food) {
            cartItems.push({
                id: food.id,
                name: food.name,
                price: food.price,
                quantity: quantity,
                icon: food.icon,
                description: food.description || "",
                features: food.features || [],
                category: food.category || "",
                remark: remark,
                utensils: utensils,
                isCustom: food.isCustom || false
            });
        }
    }
    
    updateCart(); 
    document.getElementById('cart-detail-modal').classList.remove('active'); 
    document.getElementById('overlay').classList.remove('active'); 
    showNotification('已保存修改'); 
}
function loadAddressesFromStorage() { const storedAddresses = localStorage.getItem('foodDeliveryAddresses'); if (storedAddresses) { savedAddresses = JSON.parse(storedAddresses); renderSavedAddresses(); } }
function saveAddressesToStorage() { localStorage.setItem('foodDeliveryAddresses', JSON.stringify(savedAddresses)); }
function renderSavedAddresses() { const addressList = document.getElementById('address-list'); addressList.innerHTML = ''; if (savedAddresses.length === 0) { addressList.innerHTML = `<div class="no-addresses"><i class="fas fa-map-marker-alt"></i><p>暂无已保存的地址</p><p>请在上方添加您的地址</p></div>`; return; } savedAddresses.forEach((address, index) => { const addressItem = document.createElement('div'); addressItem.className = `address-item ${selectedAddressIndex === index ? 'active' : ''}`; addressItem.setAttribute('data-index', index); addressItem.innerHTML = `<div class="address-item-header"><div class="address-item-name">${address.tag}<span class="address-tag-small">${address.tag}地址</span></div><div class="address-item-actions"><button class="address-item-action-btn edit-address-btn" data-index="${index}"><i class="fas fa-edit"></i></button><button class="address-item-action-btn delete-address-btn" data-index="${index}"><i class="fas fa-trash-alt"></i></button></div></div><div class="address-item-content">${address.address}</div>`; addressList.appendChild(addressItem); }); }
function addNewAddress(address, tag) { const newAddress = { address: address, tag: tag }; const existingIndex = savedAddresses.findIndex(addr => addr.tag === tag); if (existingIndex !== -1) { savedAddresses[existingIndex] = newAddress; showNotification(`已更新${tag}地址`); } else { savedAddresses.push(newAddress); showNotification(`已保存${tag}地址`); } if (savedAddresses.length === 1) { selectedAddressIndex = 0; } saveAddressesToStorage(); renderSavedAddresses(); updateCartAddress(); document.getElementById('address-input').value = ''; }
function editAddress(index) { if (index >= 0 && index < savedAddresses.length) { const address = savedAddresses[index]; document.getElementById('address-input').value = address.address; selectedTag = address.tag; document.querySelectorAll('.address-tag').forEach(tag => { tag.classList.remove('active'); if (tag.getAttribute('data-tag') === address.tag) { tag.classList.add('active'); } }); document.querySelector('.address-content').scrollTop = 0; document.getElementById('address-input').focus(); selectedAddressIndex = index; renderSavedAddresses(); } }
function deleteAddress(index) { if (index >= 0 && index < savedAddresses.length) { const tag = savedAddresses[index].tag; savedAddresses.splice(index, 1); if (selectedAddressIndex === index) { selectedAddressIndex = -1; } else if (selectedAddressIndex > index) { selectedAddressIndex--; } saveAddressesToStorage(); renderSavedAddresses(); updateCartAddress(); showNotification(`已删除${tag}地址`); } }
function updateCartAddress() { const cartAddressInfo = document.getElementById('cart-address-info'), cartAddressContent = document.getElementById('cart-address-content'); if (savedAddresses.length === 0) { cartAddressInfo.classList.add('empty'); cartAddressContent.textContent = '请添加收货地址'; } else { cartAddressInfo.classList.remove('empty'); const addressIndex = selectedAddressIndex >= 0 ? selectedAddressIndex : 0; const address = savedAddresses[addressIndex]; cartAddressContent.innerHTML = `<div>${userProfile.name}</div><div>${address.address}</div><div style="font-size:12px;color:#999;margin-top:4px">${address.tag}地址</div>`; } }
function toggleFavorite(foodId) { const food = window.foodData.find(item => item.id === foodId); if (!food) return; food.isFavorite = !food.isFavorite; if (food.isFavorite) { if (!favoriteItems.find(item => item.id === foodId)) { favoriteItems.push(food); } showNotification(`${food.name} 已添加到收藏`); } else { const index = favoriteItems.findIndex(item => item.id === foodId); if (index !== -1) { favoriteItems.splice(index, 1); } showNotification(`${food.name} 已取消收藏`); } saveFavoritesToStorage(); renderFoodItems(); if (document.getElementById('favorites-page').classList.contains('active')) { renderFavorites(); } }
function showFoodDetail(food) { alert(`美食详情：\n\n${food.name}\n${food.description}\n\n特色：${food.features.join('、')}\n价格：¥${food.price}`); }
function updateCart() { 
    const totalItems = cartItems.reduce((total, item) => total + item.quantity, 0); 
    document.getElementById('cart-count').textContent = totalItems; 
    renderCartItems(); 
    updateCartTotal(); 
    window.foodDelivery.cartItems = cartItems; 
    window.foodDelivery.updateStatus(); 
}
function renderCartItems() {
    const cartItemsContainer = document.getElementById('cart-items'); 
    cartItemsContainer.innerHTML = ''; 
    if (cartItems.length === 0) { 
        cartItemsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#999">购物车是空的</div>'; 
        return; 
    }
    
    cartItems.forEach(item => { 
        const cartItem = document.createElement('div'); 
        cartItem.className = 'cart-item'; 
        cartItem.innerHTML = `
            <div class="cart-item-icon"><i class="${item.icon}"></i></div>
            <div class="cart-item-info">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">¥${item.price}</div>
                <div class="cart-item-controls">
                    <div class="cart-item-quantity">
                        <button class="quantity-btn-small minus" data-id="${item.id}"><i class="fas fa-minus"></i></button>
                        <div class="cart-item-quantity-value">${item.quantity}</div>
                        <button class="quantity-btn-small plus" data-id="${item.id}"><i class="fas fa-plus"></i></button>
                    </div>
                    <button class="cart-item-detail-btn detail-btn" data-id="${item.id}"><i class="fas fa-edit"></i> 编辑</button>
                </div>
            </div>`; 
        cartItemsContainer.appendChild(cartItem); 
    });
    
    document.querySelectorAll('.quantity-btn-small.minus').forEach(btn => { 
        btn.addEventListener('click', function() { 
            const id = this.getAttribute('data-id'); 
            decreaseQuantity(id); 
        }); 
    }); 
    
    document.querySelectorAll('.quantity-btn-small.plus').forEach(btn => { 
        btn.addEventListener('click', function() { 
            const id = this.getAttribute('data-id'); 
            increaseQuantity(id); 
        }); 
    }); 
    
    document.querySelectorAll('.detail-btn').forEach(btn => { 
        btn.addEventListener('click', function() { 
            const id = this.getAttribute('data-id'); 
            openEditModalForFood(id); 
        }); 
    });
}
function increaseQuantity(id) { 
    const item = cartItems.find(item => item.id == id); 
    if (item) { 
        item.quantity++; 
        updateCart(); 
    } 
}
function decreaseQuantity(id) { 
    const itemIndex = cartItems.findIndex(item => item.id == id); 
    if (itemIndex !== -1) { 
        if (cartItems[itemIndex].quantity > 1) { 
            cartItems[itemIndex].quantity--; 
        } else { 
            cartItems.splice(itemIndex, 1); 
        } 
        updateCart(); 
    } 
}
function updateCartTotal() { const totalPrice = cartItems.reduce((total, item) => total + (item.price * item.quantity), 0); document.getElementById('cart-total-price').textContent = `¥${totalPrice.toFixed(1)}`; }
function renderFavorites() { const favoritesList = document.getElementById('favorites-list'), emptyFavorites = document.getElementById('empty-favorites'), existingCards = favoritesList.querySelectorAll('.food-card'); existingCards.forEach(card => card.remove()); if (favoriteItems.length === 0) { emptyFavorites.style.display = 'block'; return; } emptyFavorites.style.display = 'none'; favoriteItems.forEach(food => { const foodCard = createFoodCard(food); favoritesList.appendChild(foodCard); }); }
function renderEvaluations() { const evaluationsList = document.getElementById('evaluations-list'), emptyEvaluations = document.getElementById('empty-evaluations'), existingCards = evaluationsList.querySelectorAll('.evaluation-card'); existingCards.forEach(card => card.remove()); const ordersForEvaluation = orderData.filter(order => order.status === 'delivered' || order.status === 'overtime'); if (ordersForEvaluation.length === 0) { emptyEvaluations.style.display = 'block'; return; } emptyEvaluations.style.display = 'none'; ordersForEvaluation.forEach(order => { const evaluationCard = createEvaluationCard(order); evaluationsList.appendChild(evaluationCard); }); }
function createEvaluationCard(order) {
    const card = document.createElement('div'); card.className = 'evaluation-card'; card.setAttribute('data-id', order.id); const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0), itemsList = order.items.map(item => `${item.name} ×${item.quantity}`).join('，'), isOvertime = order.status === 'overtime', isEvaluated = order.evaluated && order.evaluation;
    if (isEvaluated) { const evaluation = order.evaluation; card.innerHTML = `<div class="evaluation-header"><div class="evaluation-restaurant">${order.restaurant}</div><div class="evaluation-time">${order.time} ${isOvertime ? '<span style="color:#f44336">(已超时)</span>' : ''}</div></div><div class="submitted-evaluation"><div class="submitted-evaluation-header"><div class="submitted-evaluation-title">已评价</div><div class="submitted-evaluation-time">评价时间: ${evaluation.time || '刚刚'}</div></div><div class="submitted-rating"><div class="star-rating">${generateStarRating(evaluation.rating)}</div><span style="margin-left:8px;font-weight:600">${evaluation.rating}分</span></div><div class="submitted-comment">${evaluation.comment}</div><div class="evaluation-actions"><button class="evaluation-btn danger delete-evaluation-btn" data-id="${order.id}"><i class="fas fa-trash-alt"></i> 删除评价</button></div></div>`; }
    else { card.innerHTML = `<div class="evaluation-header"><div class="evaluation-restaurant">${order.restaurant}</div><div class="evaluation-time">${order.time} ${isOvertime ? '<span style="color:#f44336">(已超时)</span>' : ''}</div></div><div class="evaluation-content"><p style="margin-bottom:16px;color:var(--secondary-color)">${itemsList}</p><p style="margin-bottom:16px;color:var(--primary-color);font-weight:600">总价: ¥${total.toFixed(1)}</p><div class="rating-section"><div class="rating-title">请为${order.riderName}骑手评分</div><div class="star-rating-input" id="rating-${order.id}"><i class="far fa-star star-input" data-rating="1"></i><i class="far fa-star star-input" data-rating="2"></i><i class="far fa-star star-input" data-rating="3"></i><i class="far fa-star star-input" data-rating="4"></i><i class="far fa-star star-input" data-rating="5"></i></div><div style="font-size:12px;color:var(--secondary-color);margin-top:4px">骑手当前评分: ${order.riderRating || 5}星</div></div><div class="comment-section"><div class="rating-title">评价内容</div><textarea class="comment-input" id="comment-${order.id}" placeholder="请写下您的评价...${isOvertime ? ' (骑手配送超时，您可以在评价中反馈)' : ''}"></textarea></div><div class="evaluation-actions"><button class="evaluation-btn primary submit-evaluation-btn" data-id="${order.id}">提交评价</button></div></div>`; const starInputs = card.querySelectorAll(`#rating-${order.id} .star-input`); starInputs.forEach(star => { star.addEventListener('click', function() { const rating = parseInt(this.getAttribute('data-rating')); const stars = card.querySelectorAll(`#rating-${order.id} .star-input`); stars.forEach((s, index) => { if (index < rating) { s.className = 'fas fa-star star-input active'; } else { s.className = 'far fa-star star-input'; } }); card.setAttribute('data-rating', rating); }); }); } return card;
}
function submitEvaluation(orderId, rating, comment) { const order = orderData.find(o => o.id === orderId); if (!order) return; order.evaluated = true; order.evaluation = { rating: rating, comment: comment, time: new Date().toLocaleString() }; const currentRating = order.riderRating || 5; const newRating = (currentRating + rating) / 2; order.riderRating = parseFloat(newRating.toFixed(1)); saveOrdersToStorage(); renderEvaluations(); showNotification('评价提交成功，感谢您的反馈！'); }
function deleteEvaluation(orderId) { const order = orderData.find(o => o.id === orderId); if (!order) return; if (confirm('确定要删除这个评价吗？')) { order.evaluated = false; delete order.evaluation; saveOrdersToStorage(); renderEvaluations(); showNotification('评价已删除'); } }
function setupEventListeners() {
    document.querySelectorAll('.filter-btn').forEach(btn => { btn.addEventListener('click', function() { document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('active'); }); this.classList.add('active'); const filter = this.getAttribute('data-filter'); renderOrderList(filter); }); });
    document.addEventListener('click', function(e) { if (e.target.closest('.view-detail-btn')) { const orderId = parseInt(e.target.closest('.view-detail-btn').getAttribute('data-id')); showOrderDetail(orderId); } });
    document.addEventListener('click', function(e) { if (e.target.closest('.evaluate-btn')) { const orderId = parseInt(e.target.closest('.evaluate-btn').getAttribute('data-id')); document.querySelectorAll('.food-page-container').forEach(container => { container.classList.remove('active'); }); document.getElementById('evaluations-page').classList.add('active'); document.querySelectorAll('#food-delivery-interface .nav-item').forEach(item => { item.classList.remove('active'); }); renderEvaluations(); setTimeout(() => { const evaluationCard = document.querySelector(`.evaluation-card[data-id="${orderId}"]`); if (evaluationCard) { evaluationCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }, 100); } });
    document.addEventListener('click', function(e) { if (e.target.closest('.delete-order-btn')) { const orderId = parseInt(e.target.closest('.delete-order-btn').getAttribute('data-id')); deleteOrder(orderId); } });
    document.addEventListener('click', function(e) { if (e.target.closest('.delete-evaluation-btn')) { const orderId = parseInt(e.target.closest('.delete-evaluation-btn').getAttribute('data-id')); deleteEvaluation(orderId); } });
    document.getElementById('order-detail-close').addEventListener('click', function() { document.getElementById('order-detail-modal').classList.remove('active'); });
    document.getElementById('cart-detail-save').addEventListener('click', saveCartItemDetail); 
    document.getElementById('cart-detail-cancel').addEventListener('click', function() { document.getElementById('cart-detail-modal').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }); 
    document.getElementById('cart-detail-close').addEventListener('click', function() { document.getElementById('cart-detail-modal').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); });
    document.getElementById('address-menu-item').addEventListener('click', function() { document.getElementById('address-panel').classList.add('active'); document.getElementById('overlay').classList.add('active'); });
    document.getElementById('favorites-menu-item').addEventListener('click', function() { document.querySelectorAll('.food-page-container').forEach(container => { container.classList.remove('active'); }); document.getElementById('favorites-page').classList.add('active'); document.querySelectorAll('#food-delivery-interface .nav-item').forEach(item => { item.classList.remove('active'); }); renderFavorites(); });
    document.getElementById('evaluations-menu-item').addEventListener('click', function() { document.querySelectorAll('.food-page-container').forEach(container => { container.classList.remove('active'); }); document.getElementById('evaluations-page').classList.add('active'); document.querySelectorAll('#food-delivery-interface .nav-item').forEach(item => { item.classList.remove('active'); }); renderEvaluations(); });
    document.addEventListener('click', function(e) { if (e.target.closest('.submit-evaluation-btn')) { const orderId = parseInt(e.target.closest('.submit-evaluation-btn').getAttribute('data-id')); const card = document.querySelector(`.evaluation-card[data-id="${orderId}"]`); let rating = card.getAttribute('data-rating') || 0; if (!rating || rating === '0') { alert('请为骑手评分'); return; } rating = parseInt(rating); const comment = document.getElementById(`comment-${orderId}`).value.trim(); if (!comment) { alert('请填写评价内容'); return; } submitEvaluation(orderId, rating, comment); } });
    document.getElementById('address-close').addEventListener('click', function() { document.getElementById('address-panel').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); document.getElementById('address-input').value = ''; selectedAddressIndex = -1; renderSavedAddresses(); });
    document.querySelectorAll('.address-tag').forEach(tag => { tag.addEventListener('click', function() { document.querySelectorAll('.address-tag').forEach(el => { el.classList.remove('active'); }); this.classList.add('active'); selectedTag = this.getAttribute('data-tag'); const existingAddress = savedAddresses.find(addr => addr.tag === selectedTag); if (existingAddress && selectedAddressIndex === -1) { document.getElementById('address-input').value = existingAddress.address; } }); });
    document.getElementById('save-address-btn').addEventListener('click', function() { const addressInput = document.getElementById('address-input'); const address = addressInput.value.trim(); if (!address) { showNotification('请输入地址'); addressInput.focus(); return; } if (selectedAddressIndex !== -1) { savedAddresses[selectedAddressIndex] = { address: address, tag: selectedTag }; saveAddressesToStorage(); renderSavedAddresses(); updateCartAddress(); showNotification(`已更新${selectedTag}地址`); selectedAddressIndex = -1; addressInput.value = ''; } else { addNewAddress(address, selectedTag); } });
    document.addEventListener('click', function(e) { if (e.target.closest('.address-item') && !e.target.closest('.address-item-actions')) { const addressItem = e.target.closest('.address-item'); const index = parseInt(addressItem.getAttribute('data-index')); if (index >= 0 && index < savedAddresses.length) { selectedAddressIndex = index; renderSavedAddresses(); updateCartAddress(); setTimeout(() => { document.getElementById('address-panel').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }, 300); showNotification(`已选择${savedAddresses[index].tag}地址`); } } if (e.target.closest('.edit-address-btn')) { e.stopPropagation(); const editBtn = e.target.closest('.edit-address-btn'); const index = parseInt(editBtn.getAttribute('data-index')); editAddress(index); } if (e.target.closest('.delete-address-btn')) { e.stopPropagation(); const deleteBtn = e.target.closest('.delete-address-btn'); const index = parseInt(deleteBtn.getAttribute('data-index')); if (confirm('确定要删除这个地址吗？')) { deleteAddress(index); } } });
    document.getElementById('cart-btn').addEventListener('click', function() { document.getElementById('cart-panel').classList.add('active'); document.getElementById('overlay').classList.add('active'); }); document.getElementById('cart-close').addEventListener('click', function() { document.getElementById('cart-panel').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }); document.getElementById('cart-change-address').addEventListener('click', function() { document.getElementById('cart-panel').classList.remove('active'); document.getElementById('address-panel').classList.add('active'); }); document.getElementById('cart-address-info').addEventListener('click', function() { if (savedAddresses.length === 0) { document.getElementById('cart-panel').classList.remove('active'); document.getElementById('address-panel').classList.add('active'); } });
    document.getElementById('checkout-btn').addEventListener('click',function(){if(cartItems.length===0){alert('购物车是空的，请先添加商品');return;}
if(savedAddresses.length===0){alert('请先添加收货地址');document.getElementById('cart-panel').classList.remove('active');document.getElementById('overlay').classList.remove('active');document.getElementById('address-panel').classList.add('active');document.getElementById('overlay').classList.add('active');return;}
const totalPrice=cartItems.reduce((total,item)=>total+(item.price*item.quantity),0);
// 钱包支付验证
const paymentResult=walletManager.payFoodDelivery(totalPrice,"桃源外卖订单");
if(!paymentResult.success){alert(paymentResult.message);return;}
const addressIndex=selectedAddressIndex>=0?selectedAddressIndex:0;const address=savedAddresses[addressIndex];const riderName=generateChineseName();const riderRating=parseFloat((3.0+Math.random()*2.0).toFixed(1));let willBeOvertime=false;if(riderRating<3){willBeOvertime=true;}else if(riderRating===3){willBeOvertime=Math.random()<0.5;}
const orderId=orderData.length>0?Math.max(...orderData.map(o=>o.id))+1:1001;const now=new Date();const orderTime=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
let deliveryTimeMinutes=30;if(willBeOvertime){deliveryTimeMinutes+=10+Math.random()*20;}else if(riderRating>=4){deliveryTimeMinutes-=5+Math.random()*5;}
const estimatedArrivalTime=new Date(now.getTime()+deliveryTimeMinutes*60000),pickupTime=new Date(now.getTime()+5*60000),deliveryStartTime=new Date(pickupTime.getTime()+10*60000),newOrder={id:orderId,status:"delivering",time:orderTime,restaurant:"美食外卖",items:cartItems.map(item=>({name:item.name,quantity:item.quantity,price:item.price})),deliveryAddress:address.address,remark:cartItems.map(item=>item.remark).filter(r=>r).join('; '),riderName:riderName,riderRating:riderRating,estimatedArrivalTime:estimatedArrivalTime.toISOString(),pickupTime:pickupTime.toISOString(),deliveryTime:deliveryStartTime.toISOString(),utensils:"需要餐具",evaluated:false,isOvertime:willBeOvertime};
orderData.unshift(newOrder);saveOrdersToStorage();const message=`订单提交成功！\n订单号：${orderId}\n收货人：${userProfile.name}\n配送地址：${address.address}\n总金额：¥${totalPrice.toFixed(1)}\n骑手：${riderName} (${riderRating}★)\n预计送达时间：${formatTime(estimatedArrivalTime)}${willBeOvertime?"\n\n注意：该骑手评级较低，订单可能超时！":""}`;alert(message+'\n'+paymentResult.message);cartItems=[];updateCart();document.getElementById('cart-panel').classList.remove('active');document.getElementById('overlay').classList.remove('active');startCountdown(orderId);const activeFilter=document.querySelector('.filter-btn.active').getAttribute('data-filter');renderOrderList(activeFilter);renderEvaluations();showNotification('订单已提交，正在配送中...');createNewOrderInChat(newOrder);});
    document.getElementById('modal-close').addEventListener('click', function() { document.getElementById('recommendation-modal').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }); document.getElementById('modal-later').addEventListener('click', function() { document.getElementById('recommendation-modal').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }); document.getElementById('modal-add').addEventListener('click', function() { openEditModalForFood(currentRecommendationId); document.getElementById('recommendation-modal').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }); document.getElementById('overlay').addEventListener('click', function() { document.getElementById('recommendation-modal').classList.remove('active'); document.getElementById('address-panel').classList.remove('active'); document.getElementById('cart-panel').classList.remove('active'); document.getElementById('cart-detail-modal').classList.remove('active'); this.classList.remove('active'); });
    document.querySelectorAll('.category-item').forEach(item => { item.addEventListener('click', function() { document.querySelectorAll('.category-item').forEach(el => { el.classList.remove('active'); }); this.classList.add('active'); const category = this.querySelector('.category-name').textContent; if (category === '全部') { renderFoodItems(); } else { filterFoodByCategory(category); } showNotification(`已筛选：${category}`); }); });
    document.querySelector('.search-input').addEventListener('keypress', function(e) { if (e.key === 'Enter') { const keyword = this.value.trim(); if (keyword) { searchFood(keyword); showNotification(`正在搜索：${keyword}`); } } });
    const nameDisplay = document.getElementById('name-display'), nameEditBtn = document.getElementById('name-edit-btn'), nameEditInput = document.getElementById('name-edit-input'), profileSaveBtn = document.getElementById('profile-save-btn'), nameText = document.getElementById('name-text');
    nameDisplay.addEventListener('click', function() { this.classList.add('editing'); nameEditBtn.style.display = 'block'; nameEditInput.classList.add('active'); profileSaveBtn.classList.add('active'); nameEditInput.focus(); }); nameEditBtn.addEventListener('click', function(e) { e.stopPropagation(); nameDisplay.classList.add('editing'); nameEditInput.classList.add('active'); profileSaveBtn.classList.add('active'); nameEditInput.focus(); });
    profileSaveBtn.addEventListener('click', function() { const name = nameEditInput.value.trim(); if (!name) { alert('请输入姓名'); return; } userProfile.name = name; nameText.textContent = name; saveUserProfileToStorage(); nameDisplay.classList.remove('editing'); nameEditInput.classList.remove('active'); profileSaveBtn.classList.remove('active'); nameEditBtn.style.display = 'none'; updateCartAddress(); showNotification('姓名已更新'); });
    nameEditInput.addEventListener('blur', function() { setTimeout(() => { if (!profileSaveBtn.matches(':active')) { nameDisplay.classList.remove('editing'); nameEditInput.classList.remove('active'); profileSaveBtn.classList.remove('active'); nameEditBtn.style.display = 'none'; } }, 200); });
    document.querySelector('.address-tag[data-tag="家"]').classList.add('active');
}
function generateChineseName() { const surname = chineseSurnames[Math.floor(Math.random() * chineseSurnames.length)]; const givenNames = ["明", "伟", "强", "军", "磊", "涛", "勇", "超", "杰", "浩", "鹏", "飞", "洋", "宇", "晨"]; const givenName = givenNames[Math.floor(Math.random() * givenNames.length)]; return surname + givenName; }
function filterFoodByCategory(category) { const foodGrid = document.getElementById('food-grid'), hotFoodGrid = document.getElementById('hot-food-grid'); foodGrid.innerHTML = ''; hotFoodGrid.innerHTML = ''; const filteredFoods = window.foodData.filter(food => food.category === category); if (filteredFoods.length > 0) { filteredFoods.forEach(food => { foodGrid.appendChild(createFoodCard(food)); hotFoodGrid.appendChild(createFoodCard(food)); }); } else { foodGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">该分类下暂无美食</div>'; hotFoodGrid.innerHTML = ''; } }
function searchFood(keyword) { const foodGrid = document.getElementById('food-grid'), hotFoodGrid = document.getElementById('hot-food-grid'); foodGrid.innerHTML = ''; hotFoodGrid.innerHTML = ''; const filteredFoods = window.foodData.filter(food => food.name.includes(keyword) || food.description.includes(keyword) || food.features.some(feature => feature.includes(keyword))); if (filteredFoods.length > 0) { filteredFoods.forEach(food => { foodGrid.appendChild(createFoodCard(food)); hotFoodGrid.appendChild(createFoodCard(food)); }); } else { foodGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">未找到相关美食</div>'; hotFoodGrid.innerHTML = ''; } }
function showNotification(message) { const notification = document.createElement('div'); notification.textContent = message; notification.style.cssText = `position:fixed;top:80px;left:50%;transform:translateX(-50%);background-color:rgba(51,51,51,0.9);color:white;padding:12px 24px;border-radius:50px;z-index:2000;font-size:14px;animation:fadeInOut 2.5s ease-in-out;white-space:nowrap;max-width:80%;overflow:hidden;text-overflow:ellipsis;border:1px solid #333;`; const style = document.createElement('style'); style.textContent = `@keyframes fadeInOut{0%{opacity:0;transform:translateX(-50%) translateY(-10px)}15%{opacity:1;transform:translateX(-50%) translateY(0)}85%{opacity:1;transform:translateX(-50%) translateY(0)}100%{opacity:0;transform:translateX(-50%) translateY(-10px)}}`; document.head.appendChild(style); document.body.appendChild(notification); setTimeout(() => { notification.remove(); style.remove(); }, 2500); }
function createNewOrderInChat(orderData) { if (typeof createNewOrder === 'function') { createNewOrder(orderData); } else { console.log('订单数据:', orderData); } }

const foodOrderManager = {
    orders: JSON.parse(localStorage.getItem('aiFoodOrders')) || [],
    init: function() { this.renderOrderList(), this.setupEventListeners() },
    setupEventListeners: function() { document.getElementById('send-ai-order-btn') && document.getElementById('send-ai-order-btn').addEventListener('click', () => this.sendSelectedOrder()) },
    addOrder: function(e, t, a, n, i, o) { const r = { id: Date.now() + Math.random().toString(36).substr(2, 9), recipient: e, type: t, items: a, total: n, address: i, timestamp: new Date().toISOString(), status: o || 'pending' }; return this.orders.unshift(r), this.saveOrders(), this.renderOrderList(), r },
    saveOrders: function() { localStorage.setItem('aiFoodOrders', JSON.stringify(this.orders)) },
    renderOrderList: function() { const e = document.getElementById('order-list'); if (!e) return; this.orders.length > 0 ? e.innerHTML = this.orders.map((e, t) => `<div class="order-item"><input type="radio" name="selectedOrder" value="${e.id}" id="order-${e.id}"><label for="order-${e.id}" class="order-info"><strong>订单${t + 1}:</strong> 给AI的${e.type}，总价:¥${e.total}<div class="order-details">地址:${e.address}</div></label></div>`).join("") : e.innerHTML = '<div class="empty-order">暂无给AI的外卖订单</div>' },
    sendSelectedOrder: async function() {
        const e = document.querySelector('input[name="selectedOrder"]:checked'); if (!e) return alert('请先选择一个订单！'); const t = e.value, a = this.orders.find(e => e.id == t); if (!a) return alert('订单不存在！'); const i = this.getAIName(); let o = `【给AI的外卖订单】\n收件人:${i}\n订单类型:${a.type}\n订单总价:¥${a.total}\n配送地址:${a.address}\n下单时间:${new Date(a.timestamp).toLocaleString()}\n订单内容:\n`; a.items.forEach((e, t) => { o += `${t + 1}.${e.name} x${e.quantity} ¥${e.price}\n` }), o += `\n请根据您的角色人设回应这份外卖订单。`, document.getElementById("message-input").value = o, document.getElementById("message-input").focus(), this.orders = this.orders.filter(e => e.id !== t), this.saveOrders(), this.renderOrderList()
    },
    getAIName: function() { const e = JSON.parse(localStorage.getItem("aiPersona") || "{}"); return e.name || "AI" },
    loadOrders: function() { this.orders = JSON.parse(localStorage.getItem('aiFoodOrders')) || [], this.renderOrderList() }
};
function initFoodDeliveryIntegration() { foodOrderManager.init(); }
function loadOrders() {
    const e = document.getElementById("order-list"), t = JSON.parse(localStorage.getItem("foodDeliveryOrders")) || [];
    if (0 === t.length) return void(e.innerHTML = '<div class="empty-order">暂无外卖订单</div>');
    t.sort((e, t) => new Date(t.createdAt) - new Date(e.createdAt)); let a = "";
    t.forEach(t => { const n = new Date(t.createdAt).toLocaleDateString(), o = new Date(t.createdAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }), r = t.items && t.items.length > 0 ? t.items.map(e => `${e.name} × ${e.quantity}`).join(", ") : "无具体项目"; a += `<div class="order-item"><div class="order-info"><div><strong>${t.restaurant || "餐厅"}</strong></div><div class="order-details">${r} | ${n} ${o} | 总计: ¥${t.totalAmount || "0.00"}</div></div></div>` }), e.innerHTML = a
}
function filterOrdersByType() {}
function sendAIOfferOrder() { const e = JSON.parse(localStorage.getItem("foodDeliveryOrders")) || []; if (0 === e.length) return void alert("没有可分享的外卖订单"); const t = e[e.length - 1], a = `我刚刚点了外卖：${t.restaurant}的外卖，有${t.items.length}样食物，总共¥${t.total}。${"delivering" === t.status ? "外卖正在配送中！" : "外卖已经送达了！"}`; document.getElementById("message-input").value = a, addUserMessageAndCallAI() }
function clearAllOrders() { confirm("确定要清空所有历史订单吗？此操作不可撤销。") && (localStorage.removeItem("foodDeliveryOrders"), loadOrders(), alert("历史订单已清空！")) };

    // ==========================================
    // 6. UI 交互与辅助函数 (UI Helpers)
    // ==========================================
    function switchChatType(type) {
        appState.chatType = type; localStorage.setItem('chatType', type); updateChatTypeUI();
        const typeNames = { 'single': '单聊模式', 'multi': '多聊模式' }; const typeDescriptions = { 'single': '和一个角色进行聊天', 'multi': '和多个角色进行聊天，可切换不同角色回复' };
        alert(`已切换到${typeNames[type]}！\n${typeDescriptions[type]}`);
    }
    function updateChatTypeUI() {
        const singleBtn = document.getElementById('single-chat-btn'), multiBtn = document.getElementById('multi-chat-btn'), personaSelector = document.getElementById('multi-persona-selector');
        singleBtn.classList.remove('active'); multiBtn.classList.remove('active');
        if (appState.chatType === 'single') { singleBtn.classList.add('active'); personaSelector.classList.remove('active'); } else { multiBtn.classList.add('active'); personaSelector.classList.add('active'); refreshMultiPersonaSelect(); }
    }
    function loadChatType() { const savedType = localStorage.getItem('chatType'); if (savedType) { appState.chatType = savedType; } updateChatTypeUI(); }
    function refreshMultiPersonaSelect() {
        const personaSelect = document.getElementById('multi-persona-select'), personas = appState.multiPersonaManager.getAllPersonas(); personaSelect.innerHTML = '';
        if (personas.length === 0) { const option = document.createElement('option'); option.value = ''; option.textContent = '请先添加多聊角色'; personaSelect.appendChild(option); return; }
        personas.forEach(persona => { const option = document.createElement('option'); option.value = persona.id; option.textContent = persona.name; if (appState.multiPersonaManager.currentPersonaId === persona.id) { option.selected = true; } personaSelect.appendChild(option); });
    }
    function switchMultiPersona() { const personaSelect = document.getElementById('multi-persona-select'), selectedId = personaSelect.value; if (selectedId) { appState.multiPersonaManager.setCurrentPersona(selectedId); const currentPersona = appState.multiPersonaManager.getCurrentPersona(); if (currentPersona) { alert(`已切换到角色:${currentPersona.name}`); } } }
    function addMultiPersona() { const nameInput = document.getElementById('multi-persona-name'), descInput = document.getElementById('multi-persona-desc'), name = nameInput.value.trim(), desc = descInput.value.trim(); if (!name || !desc) { alert('请填写角色姓名和人设描述！'); return; } const persona = appState.multiPersonaManager.addPersona(name, desc); nameInput.value = ''; descInput.value = ''; refreshMultiPersonaPreview(); if (appState.chatType === 'multi') { refreshMultiPersonaSelect(); } alert(`已添加角色:${persona.name}`); }
    function saveMultiPersonas() { alert('多聊角色已保存！'); }
    function refreshMultiPersonaPreview() {
        const previewContent = document.getElementById('multi-preview-content'), personas = appState.multiPersonaManager.getAllPersonas();
        if (personas.length === 0) { previewContent.innerHTML = '暂无多聊角色'; return; }
        let html = ''; personas.forEach(persona => { html += `<div style="margin-bottom:10px;padding:8px;border:1px solid #000;border-radius:4px;background:white;"><strong>${persona.name}</strong><div style="font-size:10px;color:#000;margin-top:4px;">${persona.description}</div><div style="font-size:9px;color:#333;margin-top:2px;">${new Date(persona.timestamp).toLocaleString()}</div><button onclick="deleteMultiPersona('${persona.id}')" style="margin-top:5px;padding:2px 6px;font-size:10px;background:white;border:1px solid #000;border-radius:3px;cursor:pointer;color:#000;">删除</button></div>`; }); previewContent.innerHTML = html;
    }
    function deleteMultiPersona(personaId) { if (confirm('确定要删除这个角色吗？')) { const success = appState.multiPersonaManager.deletePersona(personaId); if (success) { refreshMultiPersonaPreview(); if (appState.chatType === 'multi') { refreshMultiPersonaSelect(); } alert('角色已删除！'); } } }
    function switchChatMode(mode) { appState.chatMode = mode; localStorage.setItem('chatMode', mode); updateChatModeUI(); const modeNames = { 'online': '线上模式', 'offline': '线下模式' }; const modeDescriptions = { 'online': '短信模式：短文本，日常说话语气，不加修饰词', 'offline': '剧情模式：长文本，走唯美长剧情，小说式，各种修饰词都可以写' }; alert(`已切换到${modeNames[mode]}！\n${modeDescriptions[mode]}`); }
    function updateChatModeUI() { const onlineBtn = document.getElementById('online-mode-btn'), offlineBtn = document.getElementById('offline-mode-btn'), modeDisplay = document.getElementById('chat-mode-display'), modeIndicator = document.getElementById('chat-mode-indicator'); onlineBtn.classList.remove('active'); offlineBtn.classList.remove('active'); if (appState.chatMode === 'online') { onlineBtn.classList.add('active'); modeDisplay.textContent = '线上模式'; modeIndicator.className = 'chat-mode-indicator chat-mode-online'; } else { offlineBtn.classList.add('active'); modeDisplay.textContent = '线下模式'; modeIndicator.className = 'chat-mode-indicator chat-mode-offline'; } }
    function loadChatMode() { const savedMode = localStorage.getItem('chatMode'); if (savedMode) { appState.chatMode = savedMode; } updateChatModeUI(); }
    function clearAllChatHistory() { const messageCount = appState.chatManager.getMessageCount(); if (messageCount === 0) { alert('聊天记录已经是空的！'); return; } document.getElementById('clear-chat-text').textContent = `您确定要清空所有 ${messageCount} 条聊天记录吗？此操作不可撤销。`; document.getElementById('clear-chat-dialog').style.display = 'flex'; }
    function confirmClearChatHistory() { const deletedCount = appState.chatManager.clearAllMessages(); document.getElementById('clear-chat-dialog').style.display = 'none'; alert(`已成功清空 ${deletedCount} 条聊天记录！`); renderChatMessages(); }
    function cancelClearChatHistory() { document.getElementById('clear-chat-dialog').style.display = 'none'; }
    function toggleSelectionMode() {
        appState.selectionMode = !appState.selectionMode; const chatMessages = document.getElementById('chat-messages'), selectionModeInfo = document.getElementById('selection-mode-info'), selectionActions = document.getElementById('selection-actions'), selectionModeBtn = document.getElementById('selection-mode-btn');
        if (appState.selectionMode) { chatMessages.classList.add('selection-mode'); selectionModeInfo.classList.add('active'); selectionActions.classList.add('active'); selectionModeBtn.textContent = '退出选择模式'; selectionModeBtn.classList.add('danger'); appState.selectedMessageIds = []; updateSelectionCount(); } else { chatMessages.classList.remove('selection-mode'); selectionModeInfo.classList.remove('active'); selectionActions.classList.remove('active'); selectionModeBtn.textContent = '选择消息清空'; selectionModeBtn.classList.remove('danger'); document.querySelectorAll('.message.selected').forEach(message => { message.classList.remove('selected'); }); appState.selectedMessageIds = []; } renderChatMessages();
    }
    function toggleMessageSelection(messageId, checkbox) { const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`); if (checkbox.checked) { if (!appState.selectedMessageIds.includes(messageId)) { appState.selectedMessageIds.push(messageId); messageElement.classList.add('selected'); } } else { const index = appState.selectedMessageIds.indexOf(messageId); if (index !== -1) { appState.selectedMessageIds.splice(index, 1); messageElement.classList.remove('selected'); } } updateSelectionCount(); }
    function updateSelectionCount() { const selectionCount = document.getElementById('selection-count'); selectionCount.textContent = appState.selectedMessageIds.length; }
    function deleteSelectedMessages() { const selectedCount = appState.selectedMessageIds.length; if (selectedCount === 0) { alert('请先选择要删除的消息！'); return; } document.getElementById('delete-selected-text').textContent = `您确定要删除选中的 ${selectedCount} 条消息吗？此操作不可撤销。`; document.getElementById('delete-selected-dialog').style.display = 'flex'; }
    function confirmDeleteSelectedMessages() { const deletedCount = appState.chatManager.deleteMessages(appState.selectedMessageIds); document.getElementById('delete-selected-dialog').style.display = 'none'; toggleSelectionMode(); alert(`已成功删除 ${deletedCount} 条消息！`); }
    function cancelDeleteSelectedMessages() { document.getElementById('delete-selected-dialog').style.display = 'none'; }
    let sendButtonClickCount = 0, sendButtonTimer = null, lastClickTime = 0;
    function handleSendButtonClick() { const currentTime = new Date().getTime(); const timeDiff = currentTime - lastClickTime; lastClickTime = currentTime; sendButtonClickCount++; if (sendButtonTimer) { clearTimeout(sendButtonTimer); } if (sendButtonClickCount === 1 || timeDiff > 2000) { sendButtonTimer = setTimeout(() => { addUserMessageOnly(); sendButtonClickCount = 0; sendButtonTimer = null; }, 200); } else if (sendButtonClickCount === 2 && timeDiff <= 2000) { clearTimeout(sendButtonTimer); addUserMessageAndCallAI(); sendButtonClickCount = 0; sendButtonTimer = null; } }
    function addUserMessageOnly() { const e = document.getElementById("message-input"), t = e.value.trim(); if (t) { e.value = ""; const s = JSON.parse(localStorage.getItem("userPersona") || "{}").name || "您"; appState.chatManager.addMessage("user", t, s, null), renderChatMessages() } }
    function addUserMessageAndCallAI() { const e = document.getElementById("message-input"), t = e.value.trim(); if (t) { e.value = ""; const s = JSON.parse(localStorage.getItem("userPersona") || "{}").name || "您"; appState.chatManager.addMessage("user", t, s, null), renderChatMessages(), callAI() } }
    async function callAI() {
        if (!appState.isGenerating) {
            const e = document.getElementById("send-button"); appState.isGenerating = !0, e.disabled = !0, e.textContent = "生成中...", updateStatusIndicators();
            const t = appState.chatManager.getMessages(), s = t.filter(e => "user" === e.sender).pop();
            if (s) {
                let a, n = null, i; if ("single" === appState.chatType) { const e = JSON.parse(localStorage.getItem("aiPersona") || "{}"); a = e.name || "助手", i = getCurrentRolePrompt(), n = null } else { const e = appState.multiPersonaManager.getCurrentPersona(); if (!e) return alert("请先选择多聊角色！"), appState.isGenerating = !1, e.disabled = !1, void(e.textContent = "发送"); a = e.name, i = e.description, n = e.id }
                const r = appState.chatManager.addMessage("ai", "正在思考...", a, n); renderChatMessages();
                try { const o = parseFloat(document.getElementById("temperature").value) || .7, c = parseInt(document.getElementById("reply-count").value) || 1, l = await appState.apiService.chatWithRole(i, s.content, o, c, appState.chatMode, appState.chatType, a); appState.chatManager.deleteMessage(r.id), l.forEach((e, t) => { let s = e; t > 0 && c > 1 && (s = `（继续）\n${e}`), appState.chatManager.addMessage("ai", s, a, n) }), renderChatMessages() } catch (t) { appState.chatManager.updateMessage(r.id, `抱歉，生成回复时出现错误：${t.message}`), renderChatMessages() } finally { appState.isGenerating = !1, e.disabled = !1, e.textContent = "发送", updateStatusIndicators() }
            } else appState.isGenerating = !1, e.disabled = !1, e.textContent = "发送"
        }
    }
    function exportWorldbookRecords() { const records = appState.worldbookManager.getAllRecords(); if (records.length === 0) { showWorldbookBackupStatus('没有世界书记录可以导出', 'error'); return; } const exportData = { version: '1.0', exportTime: new Date().toISOString(), recordCount: records.length, records: records }; const dataStr = JSON.stringify(exportData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `worldbook_records_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showWorldbookBackupStatus(`成功导出 ${records.length} 条世界书记录`, 'success'); }
    function importWorldbookRecords() { document.getElementById('worldbook-backup-file-input').click(); }
    document.getElementById('worldbook-backup-file-input').addEventListener('change', function(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importData = JSON.parse(e.target.result); if (!importData.records || !Array.isArray(importData.records)) { showWorldbookBackupStatus('文件格式不正确', 'error'); return; } showWorldbookImportConfirm(importData); } catch (error) { console.error('解析文件失败:', error); showWorldbookBackupStatus('文件解析失败，请检查文件格式', 'error'); } }; reader.readAsText(file); e.target.value = ''; });
    function showWorldbookImportConfirm(importData) { const dialog = document.createElement('div'); dialog.className = 'confirm-dialog'; dialog.style.display = 'flex'; dialog.innerHTML = `<div class="confirm-content"><h3>导入世界书记录</h3><p>导入世界书记录将覆盖当前的所有记录，此操作不可撤销。确定要导入 ${importData.recordCount} 条记录吗？</p><div class="confirm-buttons"><button id="worldbook-confirm-import-btn">确认导入</button><button id="worldbook-cancel-import-btn">取消</button></div></div>`; document.body.appendChild(dialog); document.getElementById('worldbook-confirm-import-btn').onclick = function() { performWorldbookImport(importData); document.body.removeChild(dialog); }; document.getElementById('worldbook-cancel-import-btn').onclick = function() { document.body.removeChild(dialog); }; }
    function performWorldbookImport(importData) { try { appState.worldbookManager.records.length = 0; importData.records.forEach(record => { appState.worldbookManager.records.push(record); }); appState.worldbookManager.saveRecords(); renderWorldbookList(); updateWorldbookStatusIndicator(); showWorldbookBackupStatus(`成功导入 ${importData.recordCount} 条世界书记录`, 'success'); } catch (error) { console.error('导入世界书记录失败:', error); showWorldbookBackupStatus('导入世界书记录失败', 'error'); } }
    function backupWorldbookToLocal() { const records = appState.worldbookManager.getAllRecords(); if (records.length === 0) { showWorldbookBackupStatus('没有世界书记录可以备份', 'error'); return; } const backupData = { version: '1.0', backupTime: new Date().toISOString(), recordCount: records.length, records: records }; localStorage.setItem('worldbookBackup', JSON.stringify(backupData)); showWorldbookBackupStatus(`成功备份 ${records.length} 条世界书记录到本地`, 'success'); }
    function restoreWorldbookFromLocal() {
        const backupDataStr = localStorage.getItem('worldbookBackup'); if (!backupDataStr) { showWorldbookBackupStatus('没有找到本地备份', 'error'); return; }
        try { const backupData = JSON.parse(backupDataStr); if (!backupData.records || !Array.isArray(backupData.records)) { showWorldbookBackupStatus('备份数据格式不正确', 'error'); return; } const dialog = document.createElement('div'); dialog.className = 'confirm-dialog'; dialog.style.display = 'flex'; dialog.innerHTML = `<div class="confirm-content"><h3>恢复世界书记录</h3><p>恢复世界书记录将覆盖当前的所有记录，此操作不可撤销。确定要恢复 ${backupData.recordCount} 条记录吗？</p><div class="confirm-buttons"><button id="worldbook-confirm-restore-btn">确认恢复</button><button id="worldbook-cancel-restore-btn">取消</button></div></div>`; document.body.appendChild(dialog); document.getElementById('worldbook-confirm-restore-btn').onclick = function() { performWorldbookRestore(backupData); document.body.removeChild(dialog); }; document.getElementById('worldbook-cancel-restore-btn').onclick = function() { document.body.removeChild(dialog); }; } catch (error) { console.error('解析备份数据失败:', error); showWorldbookBackupStatus('备份数据解析失败', 'error'); }
    }
    function performWorldbookRestore(backupData) { try { appState.worldbookManager.records.length = 0; backupData.records.forEach(record => { appState.worldbookManager.records.push(record); }); appState.worldbookManager.saveRecords(); renderWorldbookList(); updateWorldbookStatusIndicator(); showWorldbookBackupStatus(`成功恢复 ${backupData.recordCount} 条世界书记录`, 'success'); } catch (error) { console.error('恢复世界书记录失败:', error); showWorldbookBackupStatus('恢复世界书记录失败', 'error'); } }
    function showWorldbookBackupStatus(message, type) { const statusDiv = document.getElementById('worldbook-backup-status'); statusDiv.textContent = message; statusDiv.className = `worldbook-backup-status worldbook-backup-${type}`; statusDiv.style.display = 'block'; setTimeout(() => { statusDiv.style.display = 'none'; }, 3000); }
    function updateDesktopTime() { const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); document.getElementById('desktop-time').textContent = `${hours}:${minutes}`; }
    function openApp(appName) { document.getElementById('desktop-interface').classList.remove('active'); document.getElementById(`${appName}-interface`).classList.add('active'); currentInterface = appName; updateStatusIndicators(); if (appName === 'worldbook') { renderWorldbookList(); updateWorldbookStatusIndicator(); } if (appName === 'wallet') { walletManager.initWallet(); walletManager.setupEventListeners(); } if (appName === 'weibo') { weiboManager.init(); } if (appName === 'food-delivery' && !window.foodInited) { initFoodDelivery(); window.foodInited = true; } }
    function goBackToDesktop() { document.querySelectorAll('.interface').forEach(interface => { interface.classList.remove('active'); }); document.getElementById('desktop-interface').classList.add('active'); currentInterface = 'desktop'; }
    function showDeleteConfirm(messageId) { deleteMessageId = messageId; document.getElementById('confirm-dialog').style.display = 'flex'; }
    function confirmDelete() { if (!deleteMessageId) { document.getElementById('confirm-dialog').style.display = 'none'; return; } appState.chatManager.deleteMessage(deleteMessageId); renderChatMessages(); document.getElementById('confirm-dialog').style.display = 'none'; deleteMessageId = null; }
    function cancelDelete() { document.getElementById('confirm-dialog').style.display = 'none'; deleteMessageId = null; }
    function openPersonaModal() { document.getElementById('persona-modal').style.display = 'flex'; loadPersonaPreviews(); refreshMultiPersonaPreview(); }
    function closePersonaModal() { document.getElementById('persona-modal').style.display = 'none'; }
    function switchPersonaTab(tabName) { document.querySelectorAll('.persona-tab').forEach(tab => { tab.classList.remove('active'); }); document.querySelectorAll('.persona-form-section').forEach(section => { section.classList.remove('active'); }); document.querySelector(`.persona-tab[onclick="switchPersonaTab('${tabName}')"]`).classList.add('active'); document.getElementById(`${tabName}-persona-section`).classList.add('active'); appState.currentPersonaTab = tabName; loadPersonaPreviews(); if (tabName === 'multi') { refreshMultiPersonaPreview(); } }
    function loadPersonaPreviews() { const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}'); const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}'); if (aiPersona.name || aiPersona.description) { document.getElementById('ai-preview-content').innerHTML = `<strong>姓名:</strong> ${aiPersona.name || '未设置'}<br><strong>描述:</strong> ${aiPersona.description || '未设置'}`; } else { document.getElementById('ai-preview-content').textContent = '暂无角色人设'; } if (userPersona.name || userPersona.description) { document.getElementById('user-preview-content').innerHTML = `<strong>姓名:</strong> ${userPersona.name || '未设置'}<br><strong>描述:</strong> ${userPersona.description || '未设置'}`; } else { document.getElementById('user-preview-content').textContent = '暂无我的人设'; } }
    function saveAIPersona() { const name = document.getElementById('ai-persona-name').value.trim(); const desc = document.getElementById('ai-persona-desc').value.trim(); const persona = { name: name, description: desc, timestamp: new Date().toISOString() }; localStorage.setItem('aiPersona', JSON.stringify(persona)); loadPersonaPreviews(); renderChatMessages(); alert('角色人设保存成功！'); }
    function loadAIPersona() { const savedPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}'); document.getElementById('ai-persona-name').value = savedPersona.name || ''; document.getElementById('ai-persona-desc').value = savedPersona.description || ''; loadPersonaPreviews(); renderChatMessages(); alert('角色人设加载成功！'); }
    function saveUserPersona() { const name = document.getElementById('user-persona-name').value.trim(); const desc = document.getElementById('user-persona-desc').value.trim(); const persona = { name: name, description: desc, timestamp: new Date().toISOString() }; localStorage.setItem('userPersona', JSON.stringify(persona)); loadPersonaPreviews(); renderChatMessages(); alert('我的人设保存成功！'); }
    function loadUserPersona() { const savedPersona = JSON.parse(localStorage.getItem('userPersona') || '{}'); document.getElementById('user-persona-name').value = savedPersona.name || ''; document.getElementById('user-persona-desc').value = savedPersona.description || ''; loadPersonaPreviews(); renderChatMessages(); alert('我的人设加载成功！'); }
    function editMessage(button, messageId) { const messageElement = button.closest('.message'); const contentElement = messageElement.querySelector('.message-content'); const currentContent = contentElement.textContent; messageElement.classList.add('editing'); contentElement.innerHTML = `<textarea class="edit-input">${currentContent}</textarea><div class="edit-actions"><button onclick="saveEdit('${messageId}')">保存</button><button onclick="cancelEdit('${messageId}')">取消</button></div>`; appState.currentEditingMessageId = messageId; }
    function saveEdit(messageId) { const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`); const textarea = messageElement.querySelector('.edit-input'); const newContent = textarea.value.trim(); if (newContent) { if (appState.chatManager.updateMessage(messageId, newContent)) { messageElement.classList.remove('editing'); messageElement.querySelector('.message-content').innerHTML = newContent; } } appState.currentEditingMessageId = null; }
    function cancelEdit(messageId) { const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`); messageElement.classList.remove('editing'); const message = appState.chatManager.messages.find(msg => msg.id === messageId); if (message) { messageElement.querySelector('.message-content').innerHTML = message.content; } appState.currentEditingMessageId = null; }
    function updateStatusIndicators() {
        const chatStatus = document.getElementById('chat-status'), apiStatus = document.getElementById('api-status-indicator'), styleStatus = document.getElementById('style-status'), musicStatus = document.getElementById('music-status'), walletStatus = document.getElementById('wallet-status'), weiboStatus = document.getElementById('weibo-status'), foodStatus = document.getElementById('food-status');
        if (appState.isGenerating) { chatStatus.className = 'status-indicator status-generating'; chatStatus.title = '正在生成回复...'; } else { if (appState.currentPersona) { chatStatus.className = 'status-indicator status-online'; chatStatus.title = '人设已应用'; } else { chatStatus.className = 'status-indicator status-offline'; chatStatus.title = '使用默认人设'; } }
        const currentConfig = appState.apiService.getCurrentConfig(); if (currentConfig.apiKey && currentConfig.model) { apiStatus.className = 'status-indicator status-online'; apiStatus.title = 'API配置完成'; } else { apiStatus.className = 'status-indicator status-offline'; apiStatus.title = 'API未配置'; }
        if (appState.customCSS) { styleStatus.className = 'status-indicator status-online'; styleStatus.title = '自定义样式已应用'; } else { styleStatus.className = 'status-indicator status-offline'; styleStatus.title = '使用默认样式'; }
        if (musicPlayer.isPlaying) { musicStatus.className = 'status-indicator status-online'; musicStatus.title = '正在播放'; } else { musicStatus.className = 'status-indicator status-offline'; musicStatus.title = '未播放'; }
        if (walletManager.walletData && walletManager.walletData.totalBalance > 0) { walletStatus.className = 'status-indicator status-online'; walletStatus.title = '钱包余额充足'; } else { walletStatus.className = 'status-indicator status-offline'; walletStatus.title = '钱包余额为空'; }
        if (weiboManager.weibos && weiboManager.weibos.length > 0) { weiboStatus.className = 'status-indicator status-online'; weiboStatus.title = `有 ${weiboManager.weibos.length} 条动态微博`; } else { weiboStatus.className = 'status-indicator status-offline'; weiboStatus.title = '微博内容加载中'; }
        if (window.foodDelivery && window.foodDelivery.hasActiveOrders) { foodStatus.className = 'status-indicator status-online'; foodStatus.title = '有订单进行中'; } else if (window.foodDelivery && window.foodDelivery.cartItems && window.foodDelivery.cartItems.length > 0) { foodStatus.className = 'status-indicator status-generating'; foodStatus.title = `购物车有 ${window.foodDelivery.cartItems.length} 件商品`; } else { foodStatus.className = 'status-indicator status-offline'; foodStatus.title = '桃源应用就绪'; }
    }
    function updateWorldbookStatusIndicator() { const headerIndicator = document.getElementById('worldbook-status-indicator'), titleIndicator = document.getElementById('worldbook-status-indicator-title'), activeRecords = appState.worldbookManager.getActiveRecords(); if (activeRecords.length > 0) { headerIndicator.className = 'status-indicator status-online'; headerIndicator.title = `有 ${activeRecords.length} 条激活的世界书记录`; titleIndicator.className = 'status-indicator status-online'; titleIndicator.title = `有 ${activeRecords.length} 条激活的世界书记录`; } else { headerIndicator.className = 'status-indicator status-offline'; headerIndicator.title = '没有激活的世界书记录'; titleIndicator.className = 'status-indicator status-offline'; titleIndicator.title = '没有激活的世界书记录'; } }
    function handleMessageKeypress(event) { if (event.key === 'Enter') { event.preventDefault(); addUserMessageAndCallAI(); } }
function renderChatMessages() {
    const e = document.getElementById("chat-messages"), t = appState.chatManager.getMessages(); 
    const aiPersona = JSON.parse(localStorage.getItem("aiPersona") || "{}"), 
          userPersona = JSON.parse(localStorage.getItem("userPersona") || "{}"),
          isSingleChat = appState.chatType === "single";
    e.innerHTML = "", t.forEach(t => { 
        const s = document.createElement("div"), a = "user" === t.sender, 
        n = t.senderName || (a ? (userPersona.name || "您") : 
            (isSingleChat ? (aiPersona.name || "助手") : 
            (appState.multiPersonaManager.getCurrentPersona()?.name || "助手"))); 
        s.className = `message ${a ? "user-message" : "ai-message"}`, 
        s.setAttribute("data-message-id", t.id); 
        const i = appState.selectedMessageIds.includes(t.id); 
        i && s.classList.add("selected"), 
        s.innerHTML = ` \n <div class="message-sender">${n}</div> \n <div class="message-content">${t.content}</div> \n <input type="checkbox" class="message-checkbox" onchange="toggleMessageSelection('${t.id}', this)" ${i ? "checked" : ""}> \n <div class="message-actions"> \n <button class="message-action" title="编辑" onclick="editMessage(this, '${t.id}')">✤</button> \n <button class="message-action" title="删除" onclick="showDeleteConfirm('${t.id}')">✖</button> \n </div> \n `, 
        e.appendChild(s) 
    }), e.scrollTop = e.scrollHeight
}
function getCurrentAiName() { 
    const savedPersona = localStorage.getItem('aiPersona'); 
    if (savedPersona) { try { const persona = JSON.parse(savedPersona); return persona.name || '助手'; } catch (e) { return '助手'; } } 
    return '助手'; 
}
function getCurrentUserName() { 
    const savedPersona = localStorage.getItem('userPersona'); 
    if (savedPersona) { try { const persona = JSON.parse(savedPersona); return persona.name || '您'; } catch (e) { return '您'; } } 
    return '您'; 
}
function getCurrentRolePrompt() { 
    const savedPersona = localStorage.getItem('aiPersona'); 
    if (savedPersona) { const persona = JSON.parse(savedPersona); return persona.description || '你是一个有用的助手'; } 
    return '你是一个有用的助手'; 
}
    function updateApiEndpoints() { const provider = document.getElementById('api-provider').value; const endpointInput = document.getElementById('api-url'); const modelSelect = document.getElementById('model-select'); const providerBadge = document.getElementById('model-provider-badge'); if (provider !== 'custom') { endpointInput.value = API_ENDPOINTS[provider] || ''; providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1); modelSelect.innerHTML = '<option value="">请选择模型</option>'; const models = MODEL_LISTS[provider] || []; models.forEach(model => { const option = document.createElement('option'); option.value = model; option.textContent = model; option.selected = model === appState.apiService.config.model; modelSelect.appendChild(option); }); } }
    function updateSelectedModel() { const modelSelect = document.getElementById('model-select'); const currentModelDisplay = document.getElementById('current-model-display'); const selectedModel = modelSelect.value; if (selectedModel) { currentModelDisplay.textContent = `当前模型:${selectedModel}`; appState.apiService.updateConfig({ model: selectedModel }); } else { currentModelDisplay.textContent = '当前模型:未选择'; appState.apiService.updateConfig({ model: '' }); } }
    async function testApiConnection() { const apiKey = document.getElementById('api-key').value; const apiUrl = document.getElementById('api-url').value; const provider = document.getElementById('api-provider').value; const statusDiv = document.getElementById('api-status'); if (!apiKey) { statusDiv.style.display = 'block'; statusDiv.className = 'api-status status-error'; statusDiv.textContent = '✖ 请输入API密钥'; return; } statusDiv.style.display = 'block'; statusDiv.className = 'api-status'; statusDiv.textContent = '测试连接中...'; try { appState.apiService.updateConfig({ provider: provider, apiKey: apiKey, apiUrl: apiUrl }); const result = await appState.apiService.testConnection(); if (result.success) { statusDiv.className = 'api-status status-success'; statusDiv.textContent = '✔ API连接成功！'; } else { throw new Error(result.error); } } catch (error) { statusDiv.className = 'api-status status-error'; statusDiv.textContent = `✖ API连接失败:${error.message}`; } updateStatusIndicators(); }
    async function refreshModels() { const apiKey = document.getElementById('api-key').value; const apiUrl = document.getElementById('api-url').value; const provider = document.getElementById('api-provider').value; const statusDiv = document.getElementById('api-status'); const lastUpdated = document.getElementById('last-updated'); const providerBadge = document.getElementById('model-provider-badge'); if (!apiKey) { statusDiv.style.display = 'block'; statusDiv.className = 'api-status status-error'; statusDiv.textContent = '✖ 请先输入API密钥'; return; } statusDiv.style.display = 'block'; statusDiv.className = 'api-status'; statusDiv.textContent = '获取模型中...'; try { appState.apiService.updateConfig({ provider: provider, apiKey: apiKey, apiUrl: apiUrl }); const models = await appState.apiService.getModels(); updateModelSelect(models); statusDiv.className = 'api-status status-success'; statusDiv.textContent = `✔ 成功获取 ${models.length} 个模型`; appState.models = models; appState.lastUpdated = new Date(); lastUpdated.textContent = `上次更新:${appState.lastUpdated.toLocaleTimeString()}`; updateSelectedModel(); providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1); } catch (error) { statusDiv.className = 'api-status status-error'; statusDiv.textContent = `✖ 获取模型失败:${error.message}`; const models = MODEL_LISTS[provider] || ['default-model']; updateModelSelect(models); appState.models = models; appState.lastUpdated = new Date(); lastUpdated.textContent = `上次更新:${appState.lastUpdated.toLocaleTimeString()}`; updateSelectedModel(); providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1); } }
    function updateModelSelect(models) { const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = '<option value="">请选择模型</option>'; models.forEach(model => { const option = document.createElement('option'); option.value = model; option.textContent = model; if (model === appState.apiService.config.model) { option.selected = true; } modelSelect.appendChild(option); }); }
    function saveApiConfig() { const apiKey = document.getElementById('api-key').value; const apiUrl = document.getElementById('api-url').value; const model = document.getElementById('model-select').value; const provider = document.getElementById('api-provider').value; const temperature = document.getElementById('temperature').value; const maxTokens = document.getElementById('max-tokens').value; const replyCount = document.getElementById('reply-count').value; if (apiKey && model) { appState.apiService.updateConfig({ provider: provider, apiKey: apiKey, apiUrl: apiUrl, model: model, replyCount: parseInt(replyCount) || 1 }); updateStatusIndicators(); alert('API配置保存成功！'); } else { alert('请填写完整的API配置信息。'); } }
    function clearApiConfig() { document.getElementById('api-key').value = ''; document.getElementById('api-url').value = 'https://api.openai.com/v1'; document.getElementById('model-select').innerHTML = '<option value="">请选择模型</option>'; document.getElementById('api-provider').value = 'openai'; document.getElementById('temperature').value = '0.7'; document.getElementById('max-tokens').value = '1000'; document.getElementById('reply-count').value = '1'; document.getElementById('current-model-display').textContent = '当前模型:未选择'; appState.apiService.updateConfig({ provider: 'openai', apiKey: '', apiUrl: 'https://api.openai.com/v1', model: '', replyCount: 1 }); updateStatusIndicators(); alert('API配置已清除！'); }
    function applyGlobalCSS() { const cssCode = document.getElementById('css-editor').value; let styleElement = document.getElementById('global-css'); if (!styleElement) { styleElement = document.createElement('style'); styleElement.id = 'global-css'; document.head.appendChild(styleElement); } styleElement.textContent = cssCode; appState.customCSS = cssCode; localStorage.setItem('customCSS', cssCode); updateStatusIndicators(); alert('全局CSS应用成功！'); }
    function resetCSS() { document.getElementById('css-editor').value = `/* 在这里输入您的自定义CSS */\n.message {\n border: 1px solid #000;\n background: white;\n margin: 8px 0;\n max-width: 85%;\n}\n\n.user-message {\n margin-left: auto;\n background: #f8f8f8;\n}\n\n.ai-message {\n margin-right: auto;\n background: #f0f0f0;\n}\n\n.ai-circle {\n border: 3px solid #000;\n background: white;\n transition: all 0.3s ease;\n}\n\n.ai-circle:hover {\n transform: scale(1.05);\n box-shadow: 0 5px 15px rgba(0,0,0,0.1);\n}`; appState.customCSS = ''; localStorage.removeItem('customCSS'); const styleElement = document.getElementById('global-css'); if (styleElement) { styleElement.remove(); } updateStatusIndicators(); alert('CSS已重置为默认值！'); }
    function exportCSS() { const cssCode = document.getElementById('css-editor').value; const blob = new Blob([cssCode], { type: 'text/css' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ai_app_styles.css'; a.click(); URL.revokeObjectURL(url); alert('CSS代码已导出！'); }
    function importCSS() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.css'; input.onchange = function(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(e) { document.getElementById('css-editor').value = e.target.result; alert('CSS代码已导入！'); }; reader.readAsText(file); }; input.click(); }
    function updateTemperatureValue() { const temperature = document.getElementById('temperature'); const valueSpan = document.getElementById('temperature-value'); valueSpan.textContent = temperature.value; }
    function openWorldbookModal(recordId = null) { const modal = document.getElementById('worldbook-modal'); const titleInput = document.getElementById('worldbook-title'); const contentInput = document.getElementById('worldbook-content'); const modalTitle = document.getElementById('worldbook-modal-title'); const statusDiv = document.getElementById('worldbook-status'); titleInput.value = ''; contentInput.value = ''; statusDiv.style.display = 'none'; if (recordId) { modalTitle.textContent = '编辑世界书记录'; const record = appState.worldbookManager.getRecordById(recordId); if (record) { titleInput.value = record.title; contentInput.value = record.content; appState.worldbookManager.currentEditingId = recordId; } } else { modalTitle.textContent = '添加世界书记录'; appState.worldbookManager.currentEditingId = null; } modal.style.display = 'flex'; }
    function closeWorldbookModal() { document.getElementById('worldbook-modal').style.display = 'none'; appState.worldbookManager.currentEditingId = null; }
    function saveWorldbookRecord() { const titleInput = document.getElementById('worldbook-title'); const contentInput = document.getElementById('worldbook-content'); const statusDiv = document.getElementById('worldbook-status'); const title = titleInput.value.trim(); const content = contentInput.value.trim(); if (!title || !content) { statusDiv.textContent = '请填写记录标题和内容'; statusDiv.className = 'worldbook-status worldbook-status-error'; statusDiv.style.display = 'block'; return; } let success = false; if (appState.worldbookManager.currentEditingId) { success = appState.worldbookManager.updateRecord(appState.worldbookManager.currentEditingId, title, content); } else { appState.worldbookManager.addRecord(title, content); success = true; } if (success) { statusDiv.textContent = '世界书记录保存成功'; statusDiv.className = 'worldbook-status worldbook-status-success'; statusDiv.style.display = 'block'; renderWorldbookList(); setTimeout(() => { closeWorldbookModal(); }, 1000); } else { statusDiv.textContent = '保存世界书记录失败'; statusDiv.className = 'worldbook-status worldbook-status-error'; statusDiv.style.display = 'block'; } updateWorldbookStatusIndicator(); }
    function deleteWorldbookRecord(recordId) { const record = appState.worldbookManager.getRecordById(recordId); if (!record) return; deleteWorldbookId = recordId; document.getElementById('delete-worldbook-dialog').style.display = 'flex'; }
    function confirmDeleteWorldbookRecord() { if (!deleteWorldbookId) { document.getElementById('delete-worldbook-dialog').style.display = 'none'; return; } appState.worldbookManager.deleteRecord(deleteWorldbookId); renderWorldbookList(); document.getElementById('delete-worldbook-dialog').style.display = 'none'; deleteWorldbookId = null; updateWorldbookStatusIndicator(); }
    function cancelDeleteWorldbookRecord() { document.getElementById('delete-worldbook-dialog').style.display = 'none'; deleteWorldbookId = null; }
    function toggleWorldbookRecord(recordId) { appState.worldbookManager.toggleRecord(recordId); renderWorldbookList(); updateWorldbookStatusIndicator(); }
    function toggleWorldbookContent(recordId) { const contentElement = document.querySelector(`.worldbook-content[data-record-id="${recordId}"]`); if (contentElement) { contentElement.classList.toggle('expanded'); const toggleButton = document.querySelector(`.worldbook-toggle[data-record-id="${recordId}"]`); if (toggleButton) { if (contentElement.classList.contains('expanded')) { toggleButton.textContent = '收起'; } else { toggleButton.textContent = '展开'; } } } }
    function renderWorldbookList() { const worldbookList = document.getElementById('worldbook-list'); const records = appState.worldbookManager.getAllRecords(); if (records.length === 0) { worldbookList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无世界书记录，点击右上角"+"添加</div>'; return; } worldbookList.innerHTML = ''; records.forEach(record => { const recordElement = document.createElement('div'); recordElement.className = 'worldbook-item'; recordElement.innerHTML = `<div class="worldbook-title"><span class="worldbook-active-indicator ${record.active ? 'worldbook-active' : 'worldbook-inactive'}"></span>${record.title}</div><div class="worldbook-content" data-record-id="${record.id}">${record.content}</div><button class="worldbook-toggle" data-record-id="${record.id}" onclick="toggleWorldbookContent('${record.id}')">展开</button><div class="worldbook-actions"><button class="worldbook-action" onclick="toggleWorldbookRecord('${record.id}')">${record.active ? '停用' : '启用'}</button><button class="worldbook-action" onclick="openWorldbookModal('${record.id}')">编辑</button><button class="worldbook-action" onclick="deleteWorldbookRecord('${record.id}')">删除</button></div>`; worldbookList.appendChild(recordElement); }); }
    function exportChatHistory() { const messages = appState.chatManager.getMessages(); if (messages.length === 0) { showBackupStatus('没有聊天记录可以导出', 'error'); return; } const exportData = { version: '1.0', exportTime: new Date().toISOString(), messageCount: messages.length, messages: messages }; const dataStr = JSON.stringify(exportData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showBackupStatus(`成功导出 ${messages.length} 条聊天记录`, 'success'); }
    function importChatHistory() { document.getElementById('backup-file-input').click(); }
    document.getElementById('backup-file-input').addEventListener('change', function(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importData = JSON.parse(e.target.result); if (!importData.messages || !Array.isArray(importData.messages)) { showBackupStatus('文件格式不正确', 'error'); return; } window.currentImportData = importData; document.getElementById('import-confirm-dialog').style.display = 'flex'; } catch (error) { console.error('解析文件失败:', error); showBackupStatus('文件解析失败，请检查文件格式', 'error'); } }; reader.readAsText(file); e.target.value = ''; });
    document.getElementById('confirm-import-btn').addEventListener('click', function() { if (window.currentImportData) { performImport(window.currentImportData); document.getElementById('import-confirm-dialog').style.display = 'none'; } }); document.getElementById('cancel-import-btn').addEventListener('click', function() { document.getElementById('import-confirm-dialog').style.display = 'none'; });
    function performImport(importData) { try { appState.chatManager.messages.length = 0; importData.messages.forEach(msg => { appState.chatManager.messages.push(msg); }); appState.chatManager.saveMessages(); renderChatMessages(); showBackupStatus(`成功导入 ${importData.messages.length} 条聊天记录`, 'success'); } catch (error) { console.error('导入聊天记录失败:', error); showBackupStatus('导入聊天记录失败', 'error'); } }
    function backupToLocal() { const messages = appState.chatManager.getMessages(); if (messages.length === 0) { showBackupStatus('没有聊天记录可以备份', 'error'); return; } const backupData = { version: '1.0', backupTime: new Date().toISOString(), messageCount: messages.length, messages: messages }; localStorage.setItem('chatBackup', JSON.stringify(backupData)); showBackupStatus(`成功备份 ${messages.length} 条聊天记录到本地`, 'success'); }
    function restoreFromLocal() { const backupDataStr = localStorage.getItem('chatBackup'); if (!backupDataStr) { showBackupStatus('没有找到本地备份', 'error'); return; } try { const backupData = JSON.parse(backupDataStr); if (!backupData.messages || !Array.isArray(backupData.messages)) { showBackupStatus('备份数据格式不正确', 'error'); return; } window.currentBackupData = backupData; document.getElementById('restore-confirm-dialog').style.display = 'flex'; document.getElementById('restore-confirm-text').textContent = `恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复 ${backupData.messageCount} 条消息吗？`; } catch (error) { console.error('解析备份数据失败:', error); showBackupStatus('备份数据解析失败', 'error'); } }
    document.getElementById('confirm-restore-btn').addEventListener('click', function() { if (window.currentBackupData) { performRestore(window.currentBackupData); document.getElementById('restore-confirm-dialog').style.display = 'none'; } }); document.getElementById('cancel-restore-btn').addEventListener('click', function() { document.getElementById('restore-confirm-dialog').style.display = 'none'; });
    function performRestore(backupData) { try { appState.chatManager.messages.length = 0; backupData.messages.forEach(msg => { appState.chatManager.messages.push(msg); }); appState.chatManager.saveMessages(); renderChatMessages(); showBackupStatus(`成功恢复 ${backupData.messageCount} 条聊天记录`, 'success'); } catch (error) { console.error('恢复聊天记录失败:', error); showBackupStatus('恢复聊天记录失败', 'error'); } }
    function showBackupStatus(message, type) { const statusDiv = document.getElementById('backup-status'); statusDiv.textContent = message; statusDiv.className = `backup-status backup-${type}`; statusDiv.style.display = 'block'; setTimeout(() => { statusDiv.style.display = 'none'; }, 3000); }
    function toggleProfileCard() { const card = document.getElementById('myProfileCard'); card.classList.toggle('expanded'); const toggleBtn = card.querySelector('.profile-toggle'); if (card.classList.contains('expanded')) { toggleBtn.textContent = '▲'; } else { toggleBtn.textContent = '▼'; } }
    function saveSignature() { const signature = document.getElementById('desktop-signature').textContent; localStorage.setItem('desktopSignature', signature); }
    function loadSignature() { const savedSignature = localStorage.getItem('desktopSignature'); if (savedSignature) { document.getElementById('desktop-signature').textContent = savedSignature; } }
    
// ==========================================
// 谧笺书城界面
// ==========================================
const bookstoreManager={pages:{home:document.getElementById('bookstore-home'),shelf:document.getElementById('bookstore-shelf'),profile:document.getElementById('bookstore-profile')},myShelf:JSON.parse(localStorage.getItem('bookstoreShelf'))||[],isEditingShelf:false,init(){this.bindEvents();this.updateShelfDisplay()},bindEvents(){document.querySelectorAll('.sidebar-nav .nav-item').forEach(e=>{e.addEventListener('click',()=>{this.switchPage(e.dataset.page)})});document.querySelectorAll('.bookstore-container .nav-tab').forEach(e=>{e.addEventListener('click',()=>{document.querySelectorAll('.bookstore-container .nav-tab').forEach(t=>t.classList.remove('active'));e.classList.add('active');this.showCategoryBooks(e.dataset.category)})});document.getElementById('bookstore-interface').addEventListener('click',e=>{let t=e.target.closest('.book-item, .featured-book');t&&this.handleBookClick(e,t)});document.querySelectorAll('#bookstore-interface .header-btn').forEach(e=>{e.addEventListener('click',()=>{alert('登录/注册功能开发中，敬请期待')})});let e=document.getElementById('editShelfBtn');e&&e.addEventListener('click',()=>{this.toggleEditMode()});let t=document.getElementById('goDiscoverBtn');t&&t.addEventListener('click',()=>{this.switchPage('home')});document.querySelectorAll('#bookstore-interface .menu-item').forEach(e=>{e.addEventListener('click',()=>{let t=e.querySelector('div').textContent.trim();alert(t+'功能开发中')})});document.querySelectorAll('#bookstore-interface .search-input').forEach(e=>{e.addEventListener('keypress',t=>{if(t.key==='Enter'){let n=e.value.trim();n&&(alert('搜索: '+n),e.value='')}})})},switchPage(e){Object.values(this.pages).forEach(t=>{t.classList.remove('active')});this.pages[e].classList.add('active');document.querySelectorAll('.sidebar-nav .nav-item').forEach(t=>{t.classList.toggle('active',t.dataset.page===e)});e==='shelf'&&this.updateShelfDisplay()},updateShelfDisplay(){let e=document.getElementById('emptyShelf'),t=document.getElementById('shelfContent'),n=document.getElementById('shelfBooks');if(!e||!t||!n)return;if(this.myShelf.length>0){e.style.display='none';t.style.display='block';n.innerHTML=this.myShelf.map(e=>`<div class="book-item" data-id="${e.id}"><div class="book-title"><span>${e.title}</span><span class="book-badge">${e.badge}</span>${this.isEditingShelf?'<button class="remove-book">移除</button>':''}</div><div class="book-meta"><span><i class="fas fa-user"></i> ${e.author}</span><span><i class="fas fa-star"></i> ${e.rating}</span></div><div class="book-desc">${e.desc}</div><div class="book-stats"><span>${e.wordCount}</span><span>${e.updateInfo}</span></div></div>`).join('')}else{e.style.display='block';t.style.display='none'}},toggleEditMode(){this.isEditingShelf=!this.isEditingShelf;let e=document.getElementById('editShelfBtn');e&&(e.textContent=this.isEditingShelf?'完成':'编辑');this.updateShelfDisplay()},handleBookClick(e,t){if(e.target.classList.contains('remove-book')){this.removeFromShelf(t.dataset.id);return}let n=t.dataset.id,r=t.querySelector('.book-title span, .featured-title span').textContent;if(this.pages.home.classList.contains('active')){if(confirm('打开《'+r+'》\n\n是否加入书架？')){this.addToShelf({id:n,title:r,author:this.getBookAuthor(t),badge:this.getBookBadge(t),rating:this.getBookRating(t),desc:this.getBookDesc(t),wordCount:this.getBookWordCount(t),updateInfo:this.getBookUpdateInfo(t)})}}else if(this.pages.shelf.classList.contains('active')){alert('开始阅读《'+r+'》')}},addToShelf(e){if(!this.myShelf.some(t=>t.id===e.id)){this.myShelf.push(e);localStorage.setItem('bookstoreShelf',JSON.stringify(this.myShelf));this.updateShelfDisplay();alert('《'+e.title+'》已加入书架')}else{alert('这本书已经在书架中了')}},removeFromShelf(e){this.myShelf=this.myShelf.filter(t=>t.id!==e);localStorage.setItem('bookstoreShelf',JSON.stringify(this.myShelf));this.updateShelfDisplay()},getBookAuthor(e){let t=e.querySelector('.book-meta, .featured-meta');if(t){let n=t.querySelector('span');if(n){let r=n.textContent.match(/[\u4e00-\u9fa5]{2,}/);return r?r[0]:'未知作者'}}return'未知作者'},getBookBadge(e){let t=e.querySelector('.book-badge, .featured-badge');return t?t.textContent:'连载中'},getBookRating(e){let t=e.querySelector('.book-meta, .featured-meta');if(t){for(let n of t.querySelectorAll('span'))if(n.textContent.includes('9.'))return n.textContent.split(' ')[1]||'9.0'}return'9.0'},getBookDesc(e){let t=e.querySelector('.book-desc, .featured-desc');return t?t.textContent:'暂无描述'},getBookWordCount(e){let t=e.querySelector('.book-stats, .featured-stats');if(t){let n=t.querySelectorAll('span');if(n.length>0)return n[0].textContent}return'0字'},getBookUpdateInfo(e){let t=e.querySelector('.book-stats, .featured-stats');if(t){let n=t.querySelectorAll('span');if(n.length>1)return n[1].textContent}return'最新更新'},showCategoryBooks(e){console.log('切换到 '+e+' 分类')}};document.addEventListener('DOMContentLoaded',function(){document.getElementById('bookstore-interface')&&bookstoreManager.init()});    

// ==========================================
// 7. 初始化与事件绑定 (Initialization)
// ==========================================

// 7.1 数据加载与恢复函数
function loadInitialData() {
    loadSignature();                                           // 加载桌面签名
    loadChatMode();                                            // 加载聊天模式
    loadChatType();                                            // 加载聊天类型
    updateDesktopTime(); setInterval(updateDesktopTime, 1000); // 时间显示
}

// 7.2 界面初始化函数
function initUIState() {
    document.querySelectorAll('.interface').forEach(interface => { interface.classList.remove('active'); }); // 隐藏所有界面
    document.getElementById('desktop-interface').classList.add('active'); currentInterface = 'desktop';     // 显示桌面
    updateTemperatureValue();                                                                               // 温度滑块
    updateApiEndpoints();                                                                                   // API端点
    updateStatusIndicators();                                                                               // 状态指示器
    updateWorldbookStatusIndicator();                                                                       // 世界书指示器
    refreshMultiPersonaPreview();                                                                           // 多角色预览
}

// 7.3 配置恢复函数
function restoreConfiguration() {
    const currentConfig = appState.apiService.getCurrentConfig();                                           // 获取API配置
    if (currentConfig.apiKey) { document.getElementById('api-key').value = currentConfig.apiKey || ''; document.getElementById('api-url').value = currentConfig.apiUrl || 'https://api.openai.com/v1'; document.getElementById('api-provider').value = currentConfig.provider || 'openai'; document.getElementById('temperature').value = 0.7; document.getElementById('max-tokens').value = 1000; document.getElementById('reply-count').value = currentConfig.replyCount || 1; if (currentConfig.model) { const modelSelect = document.getElementById('model-select'); setTimeout(() => { const options = Array.from(modelSelect.options); const option = options.find(opt => opt.value === currentConfig.model); if (option) { option.selected = true; updateSelectedModel(); } }, 100); } }
    const savedCSS = localStorage.getItem('customCSS');                                                     // 加载自定义CSS
    if (savedCSS) { document.getElementById('css-editor').value = savedCSS; appState.customCSS = savedCSS; let styleElement = document.getElementById('global-css'); if (!styleElement) { styleElement = document.createElement('style'); styleElement.id = 'global-css'; document.head.appendChild(styleElement); } styleElement.textContent = savedCSS; }
    const savedPersona = localStorage.getItem('aiPersona'); if (savedPersona) { const persona = JSON.parse(savedPersona); } // 加载AI人格
}

// 7.4 界面组件初始化函数
function initUIComponents() {
    musicPlayer.init();                                                                                     // 音乐播放器
    const fabContainer = document.getElementById('fab-container'), fabMainBtn = document.getElementById('fab-main-btn'), fabMenuItems = document.querySelectorAll('.fab-menu-item'), fabIcon = fabMainBtn.querySelector('span'), phoneScreen = document.querySelector('.phone-container .screen'); let hasMoved = !1, dragStartX, dragStartY, offsetX, offsetY; const startDrag = e => { hasMoved = !1; const t = e.touches ? e.touches[0] : e; dragStartX = t.clientX, dragStartY = t.clientY; const o = fabContainer.getBoundingClientRect(); offsetX = t.clientX - o.left, offsetY = t.clientY - o.top; e.preventDefault(); document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp); document.addEventListener('touchmove', onMouseMove, { passive: !1 }); document.addEventListener('touchend', onMouseUp); }; fabMainBtn.addEventListener('mousedown', startDrag); fabMainBtn.addEventListener('touchstart', startDrag, { passive: !1 }); function onMouseMove(e) { if (e.cancelable && e.preventDefault(), hasMoved || (hasMoved = Math.abs((e.touches ? e.touches[0] : e).clientX - dragStartX) > 5 || Math.abs((e.touches ? e.touches[0] : e).clientY - dragStartY) > 5), hasMoved) { if (fabContainer.classList.contains('active') && (fabContainer.classList.remove('active'), fabIcon.style.transform = 'rotate(0deg)', fabIcon.textContent = '✤'), 1) { const t = phoneScreen.getBoundingClientRect(), o = (e.touches ? e.touches[0] : e).clientX - t.left - offsetX, n = (e.touches ? e.touches[0] : e).clientY - t.top - offsetY, i = t.width - fabContainer.offsetWidth, s = t.height - fabContainer.offsetHeight; fabContainer.style.left = `${Math.max(0, Math.min(o, i))}px`; fabContainer.style.top = `${Math.max(0, Math.min(n, s))}px`; fabContainer.style.right = 'auto'; fabContainer.style.bottom = 'auto'; } } } function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); document.removeEventListener('touchmove', onMouseMove); document.removeEventListener('touchend', onMouseUp); hasMoved || (fabContainer.classList.toggle('active'), fabContainer.classList.contains('active') ? (fabIcon.style.transform = 'rotate(135deg)', fabIcon.textContent = '×') : (fabIcon.style.transform = 'rotate(0deg)', fabIcon.textContent = '✤')); } fabMenuItems.forEach(e => { e.addEventListener('click', function () { const t = this.getAttribute('data-page'); document.querySelectorAll('#food-delivery-interface .food-page-container').forEach(e => { e.classList.remove('active'); }); const o = document.getElementById(`${t}-page`); o && o.classList.add('active'); 'orders' === t && 'function' == typeof startAllCountdowns && startAllCountdowns(); 'evaluations' === t && 'function' == typeof renderEvaluations && renderEvaluations(); 'favorites' === t && 'function' == typeof renderFavorites && renderFavorites(); fabContainer.classList.remove('active'); fabIcon.style.transform = 'rotate(0deg)'; fabIcon.textContent = '✤'; }); });
    window.addEventListener('DOMContentLoaded', () => { initFoodDeliveryIntegration(); foodOrderManager.loadOrders(); }); // 外卖初始化
}

// 7.5 对话框事件绑定函数
function bindDialogEvents() {
    document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete); document.getElementById('cancel-delete-btn').addEventListener('click', cancelDelete);
    document.getElementById('confirm-import-btn').addEventListener('click', function () { const importData = window.currentImportData; if (importData) { performImport(importData); document.getElementById('import-confirm-dialog').style.display = 'none'; } }); document.getElementById('cancel-import-btn').addEventListener('click', function () { document.getElementById('import-confirm-dialog').style.display = 'none'; });
    document.getElementById('confirm-restore-btn').addEventListener('click', function () { const backupData = window.currentBackupData; if (backupData) { performRestore(backupData); document.getElementById('restore-confirm-dialog').style.display = 'none'; } }); document.getElementById('cancel-restore-btn').addEventListener('click', function () { document.getElementById('restore-confirm-dialog').style.display = 'none'; });
    document.getElementById('confirm-clear-chat-btn').addEventListener('click', confirmClearChatHistory); document.getElementById('cancel-clear-chat-btn').addEventListener('click', cancelClearChatHistory);
    document.getElementById('confirm-delete-selected-btn').addEventListener('click', confirmDeleteSelectedMessages); document.getElementById('cancel-delete-selected-btn').addEventListener('click', cancelDeleteSelectedMessages);
    document.getElementById('save-worldbook-btn').addEventListener('click', saveWorldbookRecord); document.getElementById('cancel-worldbook-btn').addEventListener('click', closeWorldbookModal);
    document.getElementById('confirm-delete-worldbook-btn').addEventListener('click', confirmDeleteWorldbookRecord); document.getElementById('cancel-delete-worldbook-btn').addEventListener('click', cancelDeleteWorldbookRecord);
    document.getElementById('confirm-weibo-delete-btn').addEventListener('click', function () { weiboManager.confirmDeleteWeibo(); }); document.getElementById('cancel-weibo-delete-btn').addEventListener('click', function () { weiboManager.cancelDeleteWeibo(); });
}

// 7.6 表单与输入事件绑定函数
function bindFormEvents() {
    document.getElementById('desktop-signature').addEventListener('blur', saveSignature);
    document.getElementById('desktop-signature').addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); this.blur(); } });
    document.getElementById('temperature').addEventListener('input', updateTemperatureValue);
}

// 7.7 数据监听事件绑定函数
function bindDataListeners() {
    appState.chatManager.addListener('messagesChanged', (messages) => { renderChatMessages(); });
    appState.chatManager.addListener('messageUpdated', (message) => { renderChatMessages(); });
    appState.chatManager.addListener('messageDeleted', (message) => { renderChatMessages(); });
}

// 7.8 主初始化函数（系统启动入口）
function initializeApplication() {
    // 第一步：数据加载
    loadInitialData();
    
    // 第二步：配置恢复
    restoreConfiguration();
    
    // 第三步：界面状态初始化
    initUIState();
    
    // 第四步：组件初始化
    initUIComponents();
    
    // 第五步：绑定所有事件监听（必须在UI初始化后）
    bindDialogEvents();     // 对话框事件
    bindFormEvents();       // 表单事件
    bindDataListeners();    // 数据监听事件（你的聊天监听）
    
    // 第六步：初始渲染
    renderChatMessages();   // 渲染聊天消息
}

// 7.9 DOM就绪时启动应用
document.addEventListener('DOMContentLoaded', initializeApplication);
</script>
</body>  
</html>